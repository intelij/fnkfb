YUI.add("mail-ui-mb-controller",function(D){var B=D.common.Utils,C,A="neo.pref.feedback_ids";C=function(E){this.creativeIds=[];if(NeoConfig.mbPencilRec){this.mbRecVis=1;}else{this.mbRecVis=0;}if(NeoConfig.mbPencil===17&&(NeoConfig.enableMbFeedback||NeoConfig.mbFeedbackOn)){this.metaData=D.mail.persist.MetaData;this.creativeIds=this.fqReloadCrtvIds()||[];this.limit=5;this.toggle=1;}else{this.toggle=0;}if(this.isMoneyballEnabled()){this._initMoneyball(E);}};C.prototype={_resizeHandler:function(){var E=D.Node.one("body"),F=E.get("winHeight"),G=D.one("#slot_mbrec");if(NeoConfig.mbPencilRec){if(F<750){!G.hasClass("hidden")&&G.addClass("hidden");this.mbRecVis=0;}else{G.hasClass("hidden")&&G.removeClass("hidden");this.mbRecVis=1;}}},_slotClickHandler:function(E,F){var G=this.get("displayResponse");F=F||E.target;if(!G||!G.click_url||!G.creative_id){return;}if(E.preventDefault){E.preventDefault();}if(F.hasClass("adchoices")){D.fire("mbEvent",{target:F,action:"click_ad",click_url:strings.str_cfg_url_about_adchoices});}else{if(F.hasClass("adlink")){D.fire("mbEvent",{target:F,action:"click_ad",click_url:G.click_url});D.fire("mt:click",{action:(NeoConfig.hasConv?"mb_ad_thrd":"mb_ad"),append:{crtvid:G.creative_id}});}}},_feedbackFadeToggle:function(J,I,G,H){var F=D.all(J);var E=F.size();if(F){F.each(function(K,M){var L=new yui.Anim({node:K,duration:0.1,to:{opacity:I}});L.run();if(M+1===E){L.on("end",function(){});}});}if(H){H=D.bind(H,this);setTimeout(H,350);}},_feedbackClickHandler:function(F){if(this.toggle){var E=F.target._node.className.match("sponsored-feedback")||[];if(E.length>0){var G=D.one("#adfeedback");if(G){this.fireAdFeedbackBeacon();var I=this,H=this.get("response");this._feedbackFadeToggle(".mb-animate",0,0.1,function(){D.one("#mbAds .description")._node.textContent="Great! We will try to show you fewer like this.";this._feedbackFadeToggle("#mbAds .description",1,0.8);});F.preventDefault();setTimeout(function(){I._renderMbAd(true);},3000);I._getAndSetUniqueAd(H);I.fetchAd(false);}if(F.preventDefault){F.preventDefault();}}}},fireAdFeedbackBeacon:function(){var E=this.get("displayResponse");B.rocketstats.stat("mb","rm");this.fqAdd(E.creative_id);D.fire("mt:click",{action:(NeoConfig.hasConv?"mb_ad_thrd":"mb_ad"),append:{crtvid:E.creative_id,clk_act:"rm"}});},_handleMbEvent:function(E){if(E){this.set("eventSource",E.source);switch(E.action){case"render":this.fetchAd(true);break;case"show":var F=0;if(E.source&&D.Lang.trim(E.source)==="search"){F=1;}if((NeoConfig.mbPencilList&&!NeoConfig.vertPane)||NeoConfig.mbPencilRec){F=1;}if(F){this.fetchAd(true);}break;case"rotate":if((NeoConfig.mbPencilList&&!NeoConfig.vertPane)||NeoConfig.mbPencilRec){this.fetchAd(true);}break;case"hide":this.mbView&&this.mbView.toggleView(false);break;case"previewpane_expand":if(NeoConfig.mbPencilList){this.mbView&&this.mbView.toggleView(!NeoConfig.vertPane);}break;case"previewpane_close":if(NeoConfig.mbPencilList||NeoConfig.mbPencilRec){this.fetchAd(true);}break;case"click_ad":window.open(E.click_url,"_blank");break;case"click_slot":this._slotClickHandler(E);break;default:}}},_bindUI:function(){var E=D.one("#slot_MB"),F=this;D.on("mbEvent",this._handleMbEvent,this);if(E){E.on("click",this._slotClickHandler,this);if(this.toggle){E.on("click",this._feedbackClickHandler,this);}}D.on("global:search:complete",function(){var G=D.one("#mbSearchAd");if(G&&NeoConfig.mbOpt){G.on("click",F._slotClickHandler,F);}});if(NeoConfig.mbPencilRec){D.on("ToolTips:hideTooltips",this._hideRec,this);}},_hideRec:function(){var E=D.one("body").getAttribute("data-open");if(E){this.mbView.toggleView(false);}else{this.mbView.toggleView(true);}},_initMoneyball:function(E){this._setAttrsAndMbView(E);this._bindUI();this.fetchAd();this.ttlTimer=(new Date()).getTime();},_setAttrsAndMbView:function(E){var G=this,F={rootNode:{},response:{setter:function(H){G.response=H;}},responseStartTime:{value:0},responseTime:{value:0}};G.addAttrs(F,E||{});G.set("displayResponse",NeoConfig.moneyball);G.set("recDisplayResponse",NeoConfig.moneyballRec);G.set("adType",NeoConfig.mbPencil?NeoConfig.mbPencil:1);G._initMbView();},isMoneyballEnabled:function(){return((NeoConfig.mbPencil>0)&&NeoConfig.enableMoneyball&&!NeoConfig.isMailPlus&&NeoConfig.hasAds&&!(NeoConfig.mbPencilList&&NeoConfig.vertPane)&&(NeoConfig.mbOpt||!(NeoConfig.mbPencilList&&!NeoConfig.moneyball.click_url))&&(!NeoConfig.partnerType||NeoConfig.partnerType==="pg"||NeoConfig.partnerType==="ycorp")&&NeoConfig.intl==="us"&&NeoConfig.lang==="en-US");},isToolbarInvisible:function(){var F=D.one("body"),E=D.one("#main");return(F&&F.hasClass("notoolbar"))||(E&&E.hasClass("withouttoolbar"));},isResponseValid:function(){var E=this.get("response");return E&&E.ads;},fetchAd:function(E){if(this.isTtlTimerElapsed()){this.set("response",null);E=false;}if(E&&this.isResponseValid()){this._renderMbAd();}this._resetTtlTimer();this._resetMbRequestTimer();},isTtlTimerElapsed:function(){return new Date().getTime()-this.ttlTimer>600000;},_resetTtlTimer:function(){this.ttlTimer=(new Date()).getTime();},_resetMbRequestTimer:function(){this._mbRequestTimer&&clearTimeout(this._mbRequestTimer);this._mbRequestTimer=setTimeout(D.bind(this._initAndExecuteMbRequest,this),2000);},_initAndExecuteMbRequest:function(){var E;var F=this.fqQueryEncode()||"";this.set("responseStartTime",new Date().getTime());this.mbRequest=new D.mail.ui.mbRequest();if(this.mbRecVis||this.toggle){E=2;}else{E=1;}this.mbRequest.execute(this._setJsonResponse,this,NeoConfig.mbSectionId,{"fbIds":F,"numAds":E});},_setJsonResponse:function(E){this.set("responseTime",(new Date()).getTime()-this.get("responseStartTime"));this.set("responseStartTime",0);if(E){this.set("response",E);}B.rocketstats.stat("mb","responsetime",this.get("responseTime"));},_setDisplayResponse:function(){var G=this.get("response"),F;if(!G.ads){return;}if(this.toggle){this._getAndSetUniqueAd(G);}else{F=G.ads[0];this._setResponse(F,"displayResponse");}if(this.mbRecVis){var E=G.ads[1];this._setResponse(E,"recDisplayResponse");
}},_getAndSetUniqueAd:function(H){var I=this,F,E=I.fqQueryEncode()||"",G=1;if(!H.ads){return;}if(I.fqIsIn(H.ads[0].creativeId)){F=H.ads[1];}else{F=H.ads[0];}if(I.fqIsIn(F.creativeId)){I.set("responseStartTime",new Date().getTime());G=2;I.mbRequest.execute(I._getAndSetUniqueAd,I,NeoConfig.mbSectionId,{"fbIds":E,"numAds":G});F="";}if(F){I._setResponse(F,"displayResponse");}return;},_setResponse:function(H,G){if(H&&H.tag){try{var F=D.JSON.parse(H.tag),E=H.beacon,J=H.creativeId;this.set(G,{ad_headline:F.headline,ad_summary:F.summary,ad_img:F.image,ad_source:F.source,image_width:F.imageWidth,image_height:F.imageHeight,click_url:F.clickUrl,landing_url:F.landingUrl,creative_id:J,beacon:E,ri:H.ri});}catch(I){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-ui-moneyball-mbController:1",I,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-ui-moneyball-mbController:1");}}},_renderMbAd:function(E){if(!E){this._setDisplayResponse();}if(this.mbView){this.mbView.set("eventSource",this.get("eventSource"));this.mbView.set("response",this.get("displayResponse"));if(this.mbRecVis){this.mbView.set("recResponse",this.get("recDisplayResponse"));}}else{this._initMbView();}this.mbView.render();this.mbView.set("eventSource",null);},_initMbView:function(){this.mbView=new D.mail.ui.mbView({rootNode:this.get("rootNode"),eventSource:this.get("eventSource"),adType:this.get("adType"),response:this.get("displayResponse")||{}});},fqIsIn:function(F){var E;if(!isNaN(F)&&typeof F==="number"&&isFinite(F)&&Object.prototype.toString.call(this.creativeIds)==="[object Array]"){for(E in this.creativeIds){if(F==this.creativeIds[E]){return true;}}return false;}return true;},fqAdd:function(F){var E=parseInt(F,10);this.creativeIds=this.fqReloadCrtvIds()||[];if(!isNaN(E)&&!this.fqIsIn(E)){this.creativeIds.unshift(E);}while(this.creativeIds.length>this.limit){this.creativeIds.pop();}try{this.metaData.set(A,D.JSON.stringify(this.creativeIds));}catch(G){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-ui-moneyball-mbController:2",G,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-ui-moneyball-mbController:2");}},fqQueryEncode:function(){if(Object.prototype.toString.call(this.creativeIds)==="[object Array]"){return(this.creativeIds.join(","));}else{return"";}},fqReloadCrtvIds:function(){try{var F=this.metaData.get(A);if(F){return D.JSON.parse(F);}}catch(E){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-ui-moneyball-mbController:3",E,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-ui-moneyball-mbController:3");}return;}};D.augment(C,D.EventTarget);D.augment(C,D.Attribute);D.namespace("mail.ui");D.mail.ui.mbController=C;},"1.0.0",{requires:["mail-ui-mb-model","mail-ui-mb-view","rocket-stats","event-base","event-resize","mail-persist-meta-data","common-utils"]});