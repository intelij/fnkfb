YUI.add("common-ui-conv-listview-ext",function(D){var d=D.Node,V=D.one,G=D.Lang,M=D.Array,E=D.common.Utils,K=E.log,c=D.Object,N="#",F="list",e="requestSize",J="pageSize",S="page",a="dash",A="pageCount",Z="loading",I=".",X="setrange",H="selected",P="remove",W="display",b="update",U="renderComplete",R="pageRenderComplete",C="KEY",L="SUBKEY",f="reverse",Q=5,O="focused",B="tabIndex",T="height";D.mix(D.common.ui.ConvListView.prototype,{_selectRange:function(g,Y,k){var o=this,h=o._getIndexN,n,l,m,p,j;if(g._node){g=h(g);}if(k._node){k=h(k);}m=p=k;if(D.Lang.isNumber(k)){n=o._isSubindex(m);l=o._isSubindex(g);if(n!=l){return;}if(n){if(o._getMainindex(m)!=o._getMainindex(g)){return;}g=o._getSubindex(g);m=o._getSubindex(m);}j=g<=m?-1:1;while(m!=g+j){o._selectByIndex(p,Y,0,1,0,1);if(n){p[1]+=j;}else{p+=j;}m+=j;}}o.set("selectionCount",o.selCount());},_updateItem:function(w,z,Y){var u=this,h=z?u.stop()-1:w,y=u._model.valueAt(h),g=V(N+u._id(w)),s=g?u._getItemContainer(g):null,m=u.get("activeItem"),j,o,n,l,p,x,v,r,q,k,t;if(y&&g){x=m?u._getIndexN(m):-1;l=u._lastSel?u._getIndexN(u._lastSel):-1;p=u._lastSS?u._getIndexN(u._lastSS):-1;j=(u.get(O)&&m),o=(w==u._getMainindex(l));n=(w==u._getMainindex(p));u.fire("beforeItemUpdate");v=u._selectToRender();t=d.create(u._renderItem(y,h,v[h],u._id(h),Y));if(z){if(j||o){r=g.next(I+u.ITEM_CLASS_NAME)||t;}s.remove();t&&u._srcNode.append(t);}else{s&&s.replace(t);}u.fire("itemUpdate",{itemIndex:h,itemNode:t});D.fire("listview:itemUpdate",t,y);if(j&&(m!=null)&&(u._getMainindex(x)==w)){r=V(N+u._id(x));if(r){u._focusItem(r);}}if(o){q=V(N+u._id(l));if(q){u._lastSel=q;}}if(n){k=V(N+u._id(p));if(k){u._lastSS=k;}}if((w==u.start())&&!m){t&&t.set(B,0);u._focusItem(t,1);}}},_listchange:function(o){var k=this,r,s,i=k._sel,m,l={},h,q,j,t,g,n=k.checkmode,Y=o.subtype||"DEFAULT";K({m:"list model changed",reason:o.subtype});try{switch(o.subtype){case X:if(NeoConfig.infiniteScroll||k.start()==o.start){if(NeoConfig.infiniteScroll&&k.start()==o.start&&o.start>0&&k.get("page")>0){k._appendConversations(k.start(),k.stop());}else{c.size(k._ss)&&(k._sel=k._model.indexesOf(k._ss));k._sync();k._lastSS=0;c.some(k._sel,function(v,u){k._lastSel=k.getItemEl(u);return 1;});k._ss=0;}}break;case b:k._updateItem(o.index,false,o.expand);break;case f:t=c.keys(i);q=t.length;m=k._model.get("length");if(q===1){j=t[0];g=(j==(m-j))?j:m-j-1;k.set(S,Math.floor(g*1/k.get(J)));l[g]=i[t[0]];}else{k.set(S,0);}k._clearSelect(1);k._sel=l;r=1;k.checkmode=n;break;case P:k._clearSelect(1);if(o.list&&o.list.length&&(s=k.getItemEl(o.list[0]))){k._set("activeItem",s);k._select(s,1);}if(!(k.get("isActive"))){k._set("activeItem",null);}h=k.get(A);if(k.get(S)>=h){k.set(S,h-1);}if(k.get("animateOnRemove")){k._remove(o.list);}else{r=1;}k.setAttrs({"focused":true});break;default:r=1;break;}r&&k._sync(false,Y);}catch(p){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:1",p,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:1");E.error.report("ConvView-ListExt listchange error for subtype: "+o.subtype,p,1,1,1);}},_remove:function(g){var l=this,j,k,Y;k=Y=g.length;for(var h=0;h<k;h++){j=l._getItemContainer(l.getItemEl(g[h]));j.transition({duration:0.1,height:{value:0,easing:"ease-in"},opacity:{value:0},on:{end:function(){j.remove();Y--;!Y&&l._sync();}}});}},_appendConversations:function(Y,q){var o=this,p=o._model.get(F),j=0,s=[],h=o._sel,k=o._srcNode,g=[],m,n,r,l;if(o._r){o.fire("beforeRender");o.fire("appendConversations");o.set("showFocus",false);if((m=o.get("activeItem"))){n=m.get("id");}for(l=Y;l<q;l++){r=p[l];if(r){g.push(p[l]);s.push(o._renderItem(r,l,h[l],o._id(l),false));}else{j=1;break;}}if(j){k.appendChild('<div id="listloading" class="s-loader"></div>');o._model.request(Y,o.get(e));}else{if(k.all("."+o.PAGE_CLASS_NAME).size()*o.get(J)<Y+1){k.one("#listloading")&&k.one("#listloading").remove();k.appendChild('<div role = "presentation" class = "'+o.PAGE_CLASS_NAME+'">'+s.join("")+"</div>");o.set("freeze",0);o.fire(U,{silent:true});o._prefetch();}}}},_getPageNode:function(Y){var g=this;return g._srcNode.all("."+g.PAGE_CLASS_NAME).item(Y);},_renderPage:function(o){var m=this,p=m.get(J),Y=o*p,q=Math.min(Y+p,m._model.get(F).length),n=m._model.get(F),k=m._sel,s=[],h=[],g=m._getPageNode(o),r,l,j;if(Y>q){return;}for(l=Y;l<q;l++){r=n[l];if(r){h.push(r);s.push(m._renderItem(r,l,k[l],m._id(l),false));}else{j=1;}}if(!j&&g){g.set("innerHTML",s.join(""));m.fire(R);}},_renderVisiblePages:function(){var k=this,h=k._srcNode.get("scrollTop"),Y=k.getCurrentPage(h),g,j=Y-1<0?Y:Y-1;for(g=j;g<=Y+1;g++){k._renderPage(g);}K({m:"Rendered Mail list pages",currPage:Y,range:j+"-"+Y-1});},refreshMax:function(){var Y=this;Y.set("page",Math.min(Y.get("page"),200/Y.get(J)-1));Y.set("freeze",1);Y._model.fire("refresh",{requestSize:(Y.get("page")+1)*Y.get(J)});Y._model._refresh=1;},_sync:function(g,Y){var i=this;if(i.tmSync){i.tmSync.cancel();}i._tmSync=G.later(0,i,h);function h(){var AC=this,AE,AJ,AG=AC._model.get(F),o=NeoConfig.infiniteScroll?0:AC.start(),AA=AC.stop(),n=g,AM=AC._srcNode,AL=AC._statusNode,AB,y=AC._maxLength,AH=AC._sel,r=AC.get("activeItem"),q,w,AF=[],AD,v=[],l=0,x,m,s,AK=AC.get(J),AI,z,k,u=NeoConfig.infiniteScroll&&AM.one("."+AC.PAGE_CLASS_NAME);K({m:"Entering sync",syncReason:Y});if(u){m=AM.get("scrollTop");s=parseInt(AM.one("."+AC.PAGE_CLASS_NAME).getComputedStyle("height"),10);z=AC.getCurrentPage(m)||1;}if(AC._r){AC.fire("beforeRender");AC.set("showFocus",false);if((r=AC.get("activeItem"))){w=r.get("id");}AD=AC._selectToRender();for(AE=o;AE<AA;AE++){AJ=AG[AE];if(AJ){v.push(AJ);if(NeoConfig.infiniteScroll){if(AE%AK===0){AI=(AE/AK);if(AE!==0){AF.push("</div>");}if(!s||(AI>=z-1&&AI<=z+1)){AF.push('<div role = "presentation" class = "'+AC.PAGE_CLASS_NAME+'">');}else{AF.push('<div role = "presentation" class = "'+AC.PAGE_CLASS_NAME+'" style="height:'+s+'px">');}}}if(u&&AI>=z-1&&AI<=z+1||!u){if(NeoConfig.infiniteScroll){}AF.push(AC._renderItem(AJ,AE,AD[AE],AC._id(AE),false));
}}else{n=1;l=AE;break;}}if(NeoConfig.infiniteScroll){AF.push("</div>");}if(n){if(NeoConfig.parallelRequests){AC._setStatus(true);if(g){AC.resetTop=1;}}if(NeoConfig.infiniteScroll){if(AA-l<200){x=g?AC.get(J)+50:50;k=Math.max(AA-l,x)||AC.get(e);K({m:"Sync din't find all the mails, request for more",from:l,size:k});AC._model.request(l,k);}else{AC.refreshMax();}}else{AC._model.request(o,AC.get(e));AM.setStyle(T,Math.max(500,y)+"px");}}else{if(!NeoConfig.parallelRequests){AL&&AL.setStyle(W,"none");}else{if(AC.resetTop){AC.resetTop=0;AC._resetScrollTop();}}AM.setContent(AF.join(""));AM.setStyle(T,"auto");if(v.length||NeoConfig.mbPencilTop||NeoConfig.mbPencilRec){var t=D.one("body"),p=D.one("#main"),j=((t&&t.hasClass("notoolbar"))||(p&&p.hasClass("withouttoolbar")));if(!j){D.fire("mbEvent",{action:"rotate"});D.fire("rotateD2S");}}if(NeoConfig.infiniteScroll){AC.set("freeze",0);if(NeoConfig.parallelRequests){AC._setStatus(false);}}}AC._maxLength=Math.max(y,AM.get("offsetHeight"));if(AC.get(O)){if((q=D.one(document.activeElement))&&q.hasClass("col-hd")){AC.set("activeItem",null);}else{AB=AC._parentNode;r=w?AB.one(N+w):AB.one(I+AC.ITEM_CLASS_NAME+I+H)||AB.one(I+AC.ITEM_CLASS_NAME);if(r){AC._focusItem(r);if(NeoConfig.infiniteScroll){AC.set("activeItem",r);}}else{AC.setAttrs({activeItem:null,focused:false});}}}if(!n){if(this.selCount()){if(AC._lastSel){AE=AC._getIndexN(AC._lastSel);}else{for(AE in AH){break;}}AC._lastSS=AC._lastSel=AC.getItemEl(AE);}if(!NeoConfig.infiniteScroll){AC._prefetch();AC.fire("listview:prefetchMessage",{msgsList:v});}D.fire("listview:sync",Y);AC.fire(U);}}}},_resetScrollTop:function(){var Y=this._parentNode.one(I+this.LIST_CLASS_NAME);Y.set("scrollTop",0);},getCurrentPage:function(g){var i=this,Y,h=i._srcNode.all("."+i.PAGE_CLASS_NAME);h.each(function(k,j){if(!D.Lang.isValue(Y)&&k.get("offsetTop")>=g){Y=j>0?j-1:0;return false;}});return D.Lang.isValue(Y)?Y:h.size()-1;},_setStatus:function(g){var k=this,Y,h=k._parentNode,j=false,i="";if(NeoConfig.parallelRequests){Y=h.one(".msg-list-loading");if(g){Y.removeClass("hidden");}else{Y.addClass("hidden");}}else{Y=k._statusNode;g=g||"";j=g.hideLoader||false;i=g.tmpl||g;if(!Y&&k._parentNode){Y=D.Node.create('<div role="'+k.STATUS_ROLE+'" tabindex="-1" class="'+k.STATUS_CLASS_NAME+'" style="display:none;text-align:center;padding-top:10px;padding-bottom:100px;"></div>');Y.setStyles({"position":"absolute","width":"100%","height":"auto","top":"30px","left":"-1px","margin":0,"zIndex":10000,"overflow":"visible"});k._statusNode=Y;k._parentNode.append(Y);k._maxLength=Math.max(500,k._srcNode.get("offsetHeight"));}if(Y){if(j){Y.removeClass(Z);}else{Y.addClass(Z);}k._status=i||"";if(i&&k.get("focused")){Y.focus();}Y.setContent(k._status);Y.setStyle("display","");k._srcNode.setContent("");k._srcNode.setStyle(T,k._maxLength+"px");}}},_prefetch:function(){var h=this,Y=h._model.get(F),g=h.stop();if((g<Y.length)&&!Y[g+Q]){h._model.request(g,h.get(J));}},_setSelection:function(j){var k=this,g,h=k._model.get(F),i={};k._clearSelect();j=j?(G.isObject(j)?c.keys(j):(G.isArray(j)?j:[j])):[];function Y(){h=k._model.get(F);M.each(j,function(l){i[l]=h[l]||1;g=l;});k._sel=i;}Y();if(g){if(!h[g]){k.once(U,Y,k);}k.set("page",Math.floor(g/k.get(J)),{noupdate:1});}k._sync();},_blur:function(){return;},_moveToItem:function(h,i){var k=this,j=true,g={188:1,190:1},Y;if(h){k._focusItem(h);if(!(i.metaKey||i.ctrlKey)||(i.ctrlKey&&!i.keycodeOverride&&g[i.keyCode])){if(i.shiftKey&&k._lastSel){k._select(k._lastSel,0,h,1);}else{k._clearSelect();}k._lastSel=h;k._select(h,1,k._lastSS,i.shiftKey);if((k.selCount()==1)||(!i.shiftKey)){k._lastSS=h;}j=false;}if(i.subselect){if((Y=this._getSubindex(k._getIndexN(h)))>=0){k._subselIndex=Y;k.fire("subselect");k._subselIndex=-1;}}k.set("showFocus",j);}i.halt();},_expandItem:function(i,g,h){var l,Y,k=this,j=k._model;if(!j.expanding){j.expanding=true;if((l=k._getSubitemContainer(h))){k._showSubitems(l,i);j.expanding=false;}else{if(j.getSubitem(i,0)){j.update(g,i,true);h=k.getItemEl(g);Y=k._getItemContainer(h);Y.removeClass("expanded");j.expanding=false;k._expandItem(i,g,h);}else{j.requestSub(i,g);}}k.set("activeItem",h);k.set("showFocus",null);k.fire("expand");}},_getNeighborItem:function(k,j){var m=this,i,h,l,g=m._getIndexN(k),Y=I+m.ITEM_DETAIL_CLASS_NAME;if(m._isSubindex(g)){h=k[j?"next":"previous"](Y);if(!h){h=m._getMasterItem(k);if(j){h=m._getNeighborMasterItem(h,j);}}}else{if(j&&(i=m._getSubitemContainer(k))){if((h=m._getEndDetailItem(i,true,false))){return h;}}h=m._getNeighborMasterItem(k,j);if(h&&!j&&(i=m._getSubitemContainer(h))){if((l=m._getEndDetailItem(i,false,false))){return l;}}}return h;},_resetSelection:function(g){var n=this,j,l,Y,k,h=null,m=c.keys(n._sel);if(m){for(j=0;j<m.length;j++){l=n._toIndexN(m[j]);if(n._getMainindex(l)==g){Y=n._getSubindex(l);if(Y==-1){h=l;break;}else{if(h==null||n._getSubindex(l)<n._getSubindex(h)){h=l;}}}}}if(h!=null){n._clearSelect();if((k=n.getItemEl(h))){n._set("activeItem",k);n._select(k,1);}if(!(n.get("isActive"))){n._set("activeItem",null);}}},_disableMouseHover:function(){var g=this,Y=D.one("#msg-list");if(!Y){return;}if(!g.keyboardActiveEvent){Y.addClass("keyboard-active");g.keyboardActiveEvent=Y.on("mousemove",g._enableMouseHover,g);}},_enableMouseHover:function(Y){var h=this,g=D.one("#msg-list");if(h.clientX&&h.clientY){if(Y.clientX!==h.clientX&&Y.clientY!==h.clientY){g&&g.removeClass("keyboard-active");h.keyboardActiveEvent.detach();h.keyboardActiveEvent=null;h.clientX=null;h.clientY=null;}}else{h.clientX=Y.clientX;h.clientY=Y.clientY;}},_keydown:function(v){var p=this,j=p.get("activeItem"),u,l,t=I+p.ITEM_CLASS_NAME,h,Y=p._getListItem(v,1),i,s,x,k,o,q,m,n=Y?Y.hasClass(H):0,g=NeoConfig.infiniteScroll?0:p.start(),r;p._disableMouseHover();r=j?p._getIndexN(p.get("activeItem")):(p._lastSel?p._getIndexN(p._lastSel):g);if(!j){j=p.getItemEl(r);}if(!j||!p._srcNode.contains(j)){var w=Math.floor(r/p.get("pageSize"));p._renderPage(w,p._srcNode.all("."+p.PAGE_CLASS_NAME).item(w));j=p.getItemEl(r);}p._set("activeItem",j);
switch(v.keyCode){case 37:case 39:if(p.selCount()==1){if(p.get("previewPaneEnabled")){}else{k=p._getIndexN(j);o=p.getItemEl(k);q=p._getItemContainer(o);if((q.hasClass("expanded")&&v.keyCode===37)||(!q.hasClass("expanded")&&v.keyCode===39)){s=p._isSubindex(k);x=p._model.valueAt(k);i=p._model.isCollapsible(x);if(s){k=p._getMainindex(k);}if(i||s){o=V(N+p._id(k));p._expandItem(x,k,o);v.halt();}}}}break;case 38:case 40:case 188:case 190:if(v.altKey){u=p.getItemEl(v.keyCode===38||v.keyCode===188?p.start():(p.stop()-1));if(u&&(v.keyCode===40||v.keyCode===190)){if((l=p._getEndDetailItem(u,false,false))){u=l;}}}else{if(j){u=p.selCount()?p._getNeighborItem(j,v.keyCode===40||v.keyCode===190):j;if(v.keyCode===38||v.keyCode===188&&!p.selCount()){l=u;u=u&&u.previous(t);if(!u){u=l;}}if(u&&(p._isSubindex(p._getIndexN(u)))){m=v.ctrlKey;v.shiftKey=false;v.ctrlKey=v.metaKey=true;v.subselect=!m;if(!m&&p.selCount()==1&&(p.get("selection")[0]!=p._getMainindex(p._getIndexN(u)))){p._clearSelect();p._select(p._getMasterItem(u),1);}}if(!v.shiftKey&&!(v.metaKey||v.ctrlKey)&&p._lastSel&&(p._lastSel.get("id")!==j.get("id"))&&(!p._isSubindex(p._getIndexN(j)))){u=j;}}}if(u){if(!v.shiftKey&&!(v.metaKey||v.ctrlKey)&&p.selCount()){p._clearSelect();}u=p.getItemEl(p._getIndexN(u));p._moveToItem(u,v);}v.halt();break;case 32:if(v.metaKey||v.ctrlKey||v.altKey){return;}if(p._isSubindex(p._getIndexN(Y))){return;}if(!p._checkbox(v)){if(v.shiftKey){p._selectRange(p._lastSS,!p._sel[p._getIndexN(j)],Y);}else{if(n&&!p.checkmode){h=1;}else{h=!n;}p._select(Y,h,0,1);p._lastSel=p._lastSS=h?Y:0;}if(!p._isTextField(v)){v.halt();}}break;case 13:if(p.selCount()==1){k=p._getIndexN(j);x=p._model.valueAt(k);s=p._isSubindex(k);i=p._model.isCollapsible(x);if(s||!i||!p.get("expandOnClick")){p.fire("command",{e:v,index:s?p._getSubindex(k):p._getMainindex(k),subindex:s?p._getSubindex(k):-1,mainindex:p._getMainindex(k),item:x});}else{o=V(N+p._id(k));p._expandItem(x,k,o);v.halt();}}break;case 36:if(NeoConfig.infiniteScroll){p.scrollToTop();if(p.infScrollMsgCount){p.fire("infiniteScroll:checkMail");}v.halt();}break;case 33:if(NeoConfig.infiniteScroll){p.pageUpOrDown(true);v.halt();}break;case 34:if(NeoConfig.infiniteScroll){p.pageUpOrDown(false);v.halt();}break;}},_isCheckboxBorder:function(l){var k=l.target,j,i=0,g=0,h,Y;if(k.hasClass("list-view-item")){if(!NeoConfig.hoverPreview){Y=k.one("div.info");if(Y){i=Y.get("offsetWidth");}}h=k.one("input");if(h){g=h.get("offsetWidth");}j=k.getX()||0;return((l.clientX>j)&&(l.clientX<j+g+i));}},getPageIndex:function(j){var l=this,i=l.get("page"),Y=l.get("pageSize"),h=l._getListItem(j,1),g=l._getIndexN(h),k=g-(i*Y);return k;}},1);D.mix(D.common.ui.ConvListModel.prototype,{setRange:function(m,j){var l=this,h=j.length,g=j||[],k=l.get(F),Y=k.length;if(l._refresh){k=[];k.length=Y;l._refresh=0;}while(h--){k[m+h]=g[h];}l.set(F,k,{subtype:X,start:m});},update:function(Y,i,h){var j=this.get(F);try{j[Y]=i;this.set(F,j,{subtype:b,index:Y,expand:h});}catch(g){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:2",g,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:2");E.error.report("ConvView-ListExt update error",g,1,1,1);}},remove:function(g){var k=this,Y=G.isObject(g)?c.keys(g):M(g).sort(M.numericSort),h=Y.length,j=k.get(F);Y=M(Y).sort(M.numericSort);D.fire(k.NAME+":remove",j,Y);while(h--){j.splice(Y[h],1);}k.set(F,j,{subtype:P,list:Y});},reverse:function(){var g=this,Y=g.get(F);Y.reverse();g.set(F,Y,{subtype:f});},indexesOf:function(p,v,g){var k,h,m=this,u,r,q,t,s=m.get(v?L:C),o=m.get(F),Y={},n={},l=o.length;p=G.isArray(p)?p:[p];M.each(p,function(i){Y[i[s]]=i;});for(k=0;k<l;k++){u=o[k];if(v){q=m.getSubitemCount(u);for(h=0;h<q;h++){r=m.getSubitem(u,h);if(r&&Y[r[s]]){t=k+a+h;n[k+a+h]=r;}}}else{if(u=o[k]&&Y[u[s]]){n[k]=u;}}}g&&g(n);return n;}},1);},"1.0.0",{requires:["common-ui-conv-listview","transition","common-ui-notification"]});