YUI.add("mail-controller-messages-ops",function(F){var K,d,j=F.mail,Q=j.model.DataStore,i=Q.Messages,a=F.common.Utils,C=j.Controller,I=C.Folders,X=F.Lang,f={passthru:{move:"MoveMessages",flag:"FlagMessages",remove:"DeleteMessages",fullHeader:"GetMessageRawHeader",redirectMsg:"RedirectMessage",addFilter:"AddFilters"},isdup:{FlagMessages:function(m,l){var k=m.setFlags,Y=l.setFlags;if(m.mid&&l.mid&&m.mid.length===1&&l.mid.length===1&&m.mid[0]===l.mid[0]&&k.read===Y.read&&k.flagged===Y.flagged){return true;}}}},N,W,E="%40C%40Chats",g="Trash",J="%40B%40Bulk",c={"replied":"isReplied","flagged":"isFlagged","read":"isRead","draft":"isDraft","forwarded":"isForwarded","ham":"isHam","spam":"isSpam","notmymail":"notmymail"},M=strings.str_cfg_tog_set_spam_read_flag,Z={};f.batchable=f.passthru;N=C.extend("Messages",f);W=N.Error;d=f.order;function e(n,u,m){var l,o,t=u.parms,Y=u.reason,p=u.api,s=n.error,v,k,q;if(NeoConfig.scanMoveAction&&u.method==="MoveMessages"){for(o=0;o<t.mid.length;o++){v=false;if(t.mid[o]){q=typeof t.mid[o];if(q==="string"){v=U(t.mid[o]);}else{if(q==="object"&&t.mid[o].hashKey){v=t.mid[o].hashKey;}else{if(q==="object"&&t.mid[o].mid){v=U(t.mid[o].mid);}}}}if(v&&Z[v]){delete Z[v];}}}if(s){for(o=0;o<s.length;o++){if(s[o].code==="-1400"){a.rocketstats.stat("msgops","TAE4:-1400:"+u.method);}if(s[o].code==="WARN"){a.rocketstats.stat("msgops","TAE4:CODE:WARN:"+u.method);}}for(o=0;o<s.length;o++){if(s[o].code!=="WARN"){m("failure");return N._error(n,W.invalidmid);}}}if((u&&u.origParms&&((u.origParms.sourceFid&&u.origParms.sourceFid==="%40S%40Search")||u.origParms.fromSearch))||(n&&n.fromSearch)){k=k||{};k.fromSearch=true;}if(u&&u.origParms&&u.origParms.fromConv){k=k||{};k.fromConv=true;}if(p==="move"){i.move(t.sourceFid,t.destinationFid,t.mid,n.mid,Y,k);}l=n.sourceFolder;if(l&&u.custom.isSparse){Q.Folders.set(l,"ds:msg:",1);}l=n.destinationFolder;if(l){Q.Folders.set(l,"ds:msg:",1);}}function P(n,s){var p,o=n.destinationFid&&n.destinationFid===J,l,q=s.origParms,k=q.destinationFid,m=q.sourceFid,r=s.origParms.mid,Y;if(o){l={};if(k===J){l[c.spam]=1;l[c.ham]=0;}if(m===J&&k!==g){l[c.ham]=1;l[c.spam]=0;}i.update(n.sourceFid||n.fid,r,{flags:l},"flag");if(M){for(p=0;p<r.length;p++){r[p].flags.isRead=1;}}}if((s&&s.origParms&&((s.origParms.sourceFid&&s.origParms.sourceFid==="%40S%40Search")||s.origParms.fromSearch))||(n&&n.fromSearch)){Y=Y||{};Y.fromSearch=true;}if(s&&s.origParms&&s.origParms.fromConv){Y=Y||{};Y.fromConv=true;}i.remove(n.sourceFid||n.fid,r,!n.destinationFid,n.destinationFid,Y);}function R(m,o,n){var l=o.origParms,k,Y=m.returnCodes;if(Y&&Y.length){for(k=0;k<Y.length;k++){if(Y[k].code!=="WARN"){n("failure");return N._error(m,W.invalidmid);}}}else{if(!l.mid){I.refresh();}else{if(o.custom.isSparse&&T(l.setFlags,"read")){if(!o.noRefresh&&!NeoConfig.hasConvView){I.refresh();}}}}}function T(k,Y){return k&&(Y in k);}function L(n,k){var m,Y,l=n.setFlags;if(k.origParms.chain){return;}Y={};for(m in l){Y[c[m]]=l[m];}if(Y[c.spam]){Y[c.ham]=0;}else{if(Y[c.ham]){Y[c.spam]=0;}}if(X.isUndefined(l.spam)&&k.reason!=="move"){i.update(n.fid,k.origParms.mid||[],{flags:Y},k.reason);}}function S(l,Y){var n,k=0,m=Y.origParms.mid;while(m[k]){n=m[k++];if(!n.header){Y.custom.isSparse=1;}}}function V(Y,k){k("failure");a.rocketstats.stat("msgops","invalidparm_"+Y.api);return N._error({},W.invalidparams);}function O(k,m){var Y=0,l=k.mid;if(m){k.mid=X.isArray(l)?l[0].mid:l.mid;return 1;}if(!X.isArray(l)){l=(l?[l]:[]);}k.mid=[];for(;Y<l.length;Y++){k.mid[Y]=l[Y].mid||l[Y];}return Y||k.selection;}function H(m,r,AA){var z=X.isArray(m.mid)?m.mid:new Array(m.mid),t,s,p,k={},u,q,o,v,n,x=[],w=10,y=m.sourceFid,Y=y||m.fid;if(Y==="%40S%40Search"||NeoConfig.hasConv){m.enableRetry=true;if(!z[0]){return;}for(s=0,t=z.length;s<t;s++){u=z[s].fid||Y;if(Y==="%40S%40Search"||!(r.api==="move"&&(u==="Draft"||u==="Sent")&&m.destinationFid!==g)){if(!k[u]){k[u]=[];}k[u].push(z[s]);}}if((o=a.size(k))===1&&u==="%40S%40Search"){return;}if(r.api==="remove"){if(Y==="%40S%40Search"){m.sourceFid=m.sourceFid||m.fid;delete m.fid;m.destinationFid=g;r.newApi("move","MoveMessages",m);AA("pre","move");AA(1,m);return;}}delete m.mids;for(s in k){n=F.clone(m);if(y){n.sourceFid=s;}else{n.fid=s;}n.mid=k[s];if(m.sourceFid==="%40S%40Search"){n.fromSearch=true;}x[x.length]=n;}a.assert(o===x.length);if(o>1){var l=AA(function(){r.cbk.abort();});v=Math.ceil(o/w);for(p=0;p<v;p++){q=C.batch().Messages;for(s=p*w;(s<o&&s<p*w+w);s++){if(s===o-1){q[r.api](x[s],{success:function(AB){l(AB,"success",d.usercbk);},failure:function(AB){l(AB,"failure",d.usercbk);}});}else{q[r.api](x[s]);}}q.execute();}}else{return x[0];}}}function h(k,Y){var m=k.mid,l=k.fid;if(l==="%40S%40Search"){k.enableRetry=true;if(m.fid&&(m.fid!==l)){k.fid=m.fid;}O(k,Y.api==="fullHeader");}}function b(u,x,n){var l,Y,k,v,y,p,t,m=0,r,s,o=u.mid,q=u.setFlags,w=u.mid=[];if(a.isEmpty(q)){return V(x,n);}if(!X.isArray(o)){o=(o)?[o]:[];}if((q.spam&&(u.fid!==J))||(q.ham&&(u.fid===J))||(q.sendercompromised&&(u.fid!==J))||(q.phished&&(u.fid!==J))||(q.notmymail)){k=1;}while(o[m]){l=o[m++];if(!a.isEmpty(l.flags)){l=i.get(u.fid,l.mid)||l;for(Y in q){if((l.flags[c[Y]]!==q[Y])||k){w.push(l);break;}}}else{w.push(l);x.custom.isSparse=1;}}if(o.length&&!w.length){n("success");return;}if(!O(u)){return V(x,n);}if(!u.spam&&((t=q.notmymail)||(v=q.spam)||(y=q.sendercompromised)||(p=q.phished)||q.ham)){r=x.getBatch();s={sourceFid:u.fid,destinationFid:(v||y||p||t)?J:"Inbox",mid:o||x.origParms.mid,spam:1,enableRetry:u.enableRetry||false};if(u.fromConv){s.fromConv=u.fromConv;}x.noRefresh=1;if((v||y||p)&&!t&&M){q.read=1;}n(1,u);r.Messages.move(s);r.execute(x.cbk);}delete u.spam;}function A(p,q,k){var o,l,n=p.destinationFid,r=p.sourceFid,m={fid:r,mid:p.mid,spam:1,enableRetry:p.enableRetry||false},Y=function(){var u,s=p.mid.length;if(s>100){return;}for(var t=0;t<s;t++){u=p.mid[t]&&p.mid[t].mid&&U(p.mid[t].mid);if(u&&Z[u]){k("failure");}else{Z[u]=true;}}};if(n===r){k("success");return;}if(!p.spam){if(n===J){l=m.setFlags={spam:1};if(M){l.read=1;
}}if(r===J&&n!==g){l=m.setFlags={ham:1};}}!l&&NeoConfig.scanMoveAction&&Y();if(l){q.newApi("flag","FlagMessages",m);o=q.getBatch();q.noRefresh=1;k("pre","flag");k(1,m);p.spam=1;p.bidiDetection=NeoConfig.bidi;o.Messages.move(p);o.execute(q.cbk);}delete p.spam;if(!O(p)){return V(q,k);}}function U(Y){var k=Y.split("_");return k[k.length-1];}function D(k,Y,l){if((k.fid!==g)&&(k.fid!==J)&&(k.fid!==E)&&!k.force){k.sourceFid=k.fid;delete k.fid;k.destinationFid=g;Y.api=Y.reason="move";Y.method=f.passthru.move;l("pre","move");return k;}delete k.force;if(!O(k)){return V(Y,l);}}function B(k,Y){if(NeoConfig.scanMoveAction&&Y.method==="MoveMessages"&&k.fault==="aborted"){Z=[];}if(k&&(k.reason===W.invalidparams)){return;}if(Y.parms.sourceFid){i.flush(0,1);}I.refresh();}function G(l,Y){if(l&&(l.reason===W.invalidparams)){return;}var k=Y.parms;if("read" in k.setFlags){I.refresh();}else{i.flush(k.fid);}}K={success:e,failure:B};N.hook({move:K,remove:K,flag:{success:R,failure:G}});K={pre:P};N.hook({move:K,remove:K},0,d.optimistic);N.hook({move:{pre:H},remove:{pre:H},flag:{pre:H},fullHeader:{pre:h},redirectMsg:{pre:H}},0,d.fixParms);N.hook({move:{pre:A,aborted:B},remove:{pre:D,aborted:B},flag:{pre:b,aborted:G},redirectMsg:{pre:function(Y){O(Y);}}},0,d.fixParms);N.hook({move:{pre:S},flag:{pre:L}},0,d.optimistic);F.mix(W,{invalidmid:W._reservedIdx+1,invalidparams:W._reservedIdx+1,noitems:W._reservedIdx+2});},"3.0.0",{requires:["rocket-stats","mail-controller-base","mail-model-datastore","json-stringify"]});