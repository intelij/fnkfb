YUI.add("mail-ui-searchutils",function(F){var D=F.common.Utils.substitute,A=F.common.persist.UserData,C=NeoConfig.grayoutEnabled,B=F.common.Utils.unescapeHtml;var E=42;F.namespace("mail.ui");F.mail.ui.SearchUtils={showAlert:function(I,G){var H=G||{};H.hd=H.hd||strings.str_branding_mail;switch(I){case"emptySelection":if(C){return;}H.bd=strings.str_modal_zero_selected;break;case"multipleSelection":if(C){return;}H.bd=strings.str_modal_select_single_message;break;case"fullHeader":H.hd=strings.str_menu_view_full_headers;H.modal_classes="lg";H.focusedNode=".default";break;case"fullHeaderError":H.hd=strings.str_menu_view_full_headers;H.bd=strings.str_error_no_body_returned;break;case"MultiFromRefinement":H.bd=strings.str_modal_multi_from_refinement;break;case"MultiFolderRefinement":H.bd=strings.str_modal_multi_folder_refinement;break;case"SearchPuncError":H.hd=strings.str_srch_punc_header;H.bd=D(strings.str_srch_punc_body,null,null,null,strings);break;case"searchNoChat":H.bd=strings.str_srch_no_chats;break;case"redirectMsgSuccess":H.hd="Redirect Messages";H.bd="Message redirection <b>successful.</b>";break;case"redirectMsgFailure":H.hd="Redirect Messages";H.bd="Message redirection <b>failed.</b>";break;default:return;}F.use("common-ui-dialog-helper",function(J){J.common.ui.DialogHelper.alert(H);});},showConfirm:function(I,G){var L,J,K,H;switch(I){case"removeAll":L="str_modal_message_delete_all_title";J="str_modal_message_delete_all_question";break;case"redirectMsg":K="Redirect messages";H='Redirect to: &nbsp; <input id="redirectMsg" class="field-name " type="text" size="30" value="buggy_messages@yahoo.com" name="redirectMsg">';break;default:return;}F.use("common-ui-dialog-helper",function(M){M.common.ui.DialogHelper.confirm({hd:K||strings[L],bd:H||strings[J]},{ok:{handler:function(O,N){G();N.destroy();},stopDestroy:true}});});},getPaginationControls:function(G,H){return"";},getAttachmentProperties:function(J){var H=J?J.split("/"):[""],I=H[0].toLowerCase(),G=H[1]&&H[1].toLowerCase();switch(I){case"image":return{"type":strings["str_srch_photo"],"icon":"img","refineBy":"image"};case"text":case"application":return F.mail.ui.SearchUtils.getAttachmentProperties(G);case"plain":return{"type":strings["str_srch_plain"],"icon":"txt","refineBy":"plain"};case"html":return{"type":strings["str_srch_html"],"icon":"","refineBy":"html"};case"htm":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_html"]+")","icon":"","refineBy":"htm"};case"excel":case"vnd.ms-excel":return{"type":strings["str_srch_excel"],"icon":"xls","refineBy":"excel"};case"mp3":case"audio":case"x-wav":case"x-ms-wma":return{"type":strings["str_srch_music"],"icon":"audio","refineBy":"audio"};case"mspowerpoint":return{"type":strings["str_srch_powerpoint"],"icon":"ppt","refineBy":"mspowerpoint"};case"vnd.ms-powerpoint":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_powerpoint"]+")","icon":"ppt","refineBy":"vnd.ms-powerpoint"};case"mpeg":return{"type":strings["str_srch_video"],"icon":"video","refineBy":"mpeg"};case"mpg":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_video"]+")","icon":"video","refineBy":"mpg"};case"video":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_video"]+")","icon":"video","refineBy":"video"};case"msword":return{"type":strings["str_srch_word"],"icon":"doc","refineBy":"msword"};case"vnd.ms-word":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_word"]+")","icon":"doc","refineBy":"vnd.ms-word"};case"zip":return{"type":strings["str_srch_zip"],"icon":"zip","refineBy":"zip"};case"x-compress":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_zip"]+")","icon":"zip","refineBy":"x-compress"};case"x-compressed":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_zip"]+")","icon":"zip","refineBy":"x-compressed"};case"x-gzip":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_zip"]+")","icon":"zip","refineBy":"x-gzip"};case"x-tar":return{"type":strings["str_srch_other"]+" ("+strings["str_srch_zip"]+")","icon":"zip","refineBy":"x-tar"};case"pdf":return{"type":strings["str_srch_pdf"],"icon":"pdf","refineBy":"pdf"};default:return{"type":strings["str_srch_other"]+" ("+(H[1]||H[0])+")","icon":"","refineBy":H[1]||H[0]};}},isEnableAddToContacts:function(J){var I=this,H;if(J.total!=1){return false;}for(var G in J.hash){H=J.hash[G];return((H&&H.from)?!I.isKnownEmailAddress(H.from[0].address):false);}},isKnownEmailAddress:function(H){if(F.contacts&&F.contacts.utils&&F.contacts.api){var G=F.contacts,I=G.utils,J=G.api;if(!H||H===""){return 1;}if(A.isUsersEmailAddress(H)||I.isEmailKnown(H)){return 1;}if(!I.areContactsLoaded()){J.load();return 1;}return 0;}else{return 1;}},processListData:function(H,G){var I=0,J=H.hits?H.hits.length:0,P,N=[],O=H,L,M=[];for(I=0;I<J;I++){M[I]=[];P=H.hits[I];try{if(P.fromObj){P.from=F.JSON.parse(B(P.fromObj));}M[I][0]={displayname:P.from.name,address:P.from.email};}catch(K){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-ui-msearch-utils-searchUtils:1",K,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-ui-msearch-utils-searchUtils:1");}N[I]={fid:G,mid:P.mid,subject:P.subject?B(P.subject):"",subjectDir:(NeoConfig.bidi&&P.subjectDir)?P.subjectDir:"",xapparentlyto:P.xapparentlyto,date:P.rawDate||P.receivedDate,snippet:(NeoConfig.hasConv&&P.snippet)?P.snippet:"",size:P.size,inboxservices:(P.inboxservices&&F.Lang.isString(P.inboxservices)&&P.inboxservices.match("data-certified"))?[{name:"crt",value:"transactional"}]:[],from:(G=="Sent"||G=="Draft")?[{displayname:P.toEmail}]:M[I],flags:{flagged:(typeof P.flags.isFlagged!="undefined")?P.flags.isFlagged:P.flags.match("flagged"),read:(typeof P.flags.isRead!="undefined")?P.flags.isRead:!P.flags.match("unread"),forwarded:(typeof P.flags.isForwarded!="undefined")?P.flags.isForwarded:P.flags.match("forwarded"),replied:(typeof P.flags.isReplied!="undefined")?P.flags.isReplied:P.flags.match("replied")},msgicon:(P.msgicon?P.msgicon:""),attachments:{length:(typeof P.flags.hasAttachment!="undefined")?P.flags.hasAttachment:((P.hasOwnProperty("hide_attachments_else"))?0:1)}};
}O.hits=N;return O;}};},"1.0.0",{requires:[]});YUI.add("mail-ui-search-model",function(B){var K=B.common.Utils,I=K.escapeHtml,D=K.unescapeHtml,J=B.mail.ui.SearchUtils,M=B.mail.ui.common.StringUtils,C=B.common.persist.UserData,H=B.common.net.SessionMgr,A=K.ymmastats,L=B.common.net.Error;var G=function(Q){var T,O,R=/((unflagged|flagged|unread|read|replied|forwarded)\:1)|(attachmenttypes:((\"[^"]+\")|[^ ]+))|(from:((\"[^"]+\")|[^ ]+))/gi,S,N,P;if(Q.query.keyword){S=Q.query.keyword.match(R);if(S){Q.query.flags=Q.query.flags?Q.query.flags:{};N=S.length;for(P=0;P<N;P+=1){T=S[P].split(":");O=T[1].replace(/\"/g,"");switch(T[0]){case"unflagged":Q.query.flags.flagged=0;break;case"flagged":Q.query.flags.flagged=1;break;case"read":Q.query.flags.read=1;break;case"unread":Q.query.flags.read=0;break;case"replied":Q.query.flags.replied=1;break;case"forwarded":Q.query.flags.forwarded=1;break;case"attachmenttypes":Q.query.attachmenttypes=O;break;case"from":Q.query.from=O;break;}}}}return Q;};var E=function(N){var Q=this,P={},O={start:{value:0},count:{getter:function(S){var R;if(typeof S==="undefined"){R=NeoConfig.pagedResults?C.get("userUIPref.messagesPerPage")*1:10;return(R<100)?100:R;}return S;}},query:{setter:function(){Q.set("response","");}},sorting:{setter:function(R){if(R.sortKey==="date"){Q.sorting=(R.sortOrder==="up"?"%2B":"%2D")+R.sortKey;}else{Q.sorting=(R.sortOrder==="up"?"%2B":"%2D")+R.sortKey+"%2Ddate";}},getter:function(){return Q.sorting;}},response:{setter:function(R){Q.response=R;}}};B.augment(Q,B.Attribute);Q.addAttrs(O,N||{});B.augment(Q,B.EventTarget);Q.on("Request:start",function(){P=new K.Stopwatch("MSWS-Request");});Q.on("Request:complete",function(){P.stop&&P.stop();});};B.mix(E.prototype,{req:null,prepareResponse:function(R){var V=this,U,P,W=5,b,Z=V.get("query"),N=R.folders,T=R.fids;b={};if(Z.date&&!Z.date.start){b.date=Z.date;}if(Z.flags){b.flags={};for(var S in Z.flags){if(S==="read"){if(parseInt(Z.flags[S],10)===1){b.flags.read=1;}else{b.flags.unread=1;}}else{b.flags[S]=Z.flags[S];}}}if(Z.attachmenttypes){b.attachmenttype=J.getAttachmentProperties(Z.attachmenttypes);}if(Z.from){b.from=Z.from;}if(Z.fnums){b.fnums=[];if(N){for(U=0,P=Z.fnums.length;U<P;U++){b.fnums[U]=N[Z.fnums[U]];}}}R.refinedby=b;if(R.hits&&R.hits.length&&N){for(U=0,P=R.hits.length;U<P;U++){R.hits[U].folder=N[R.hits[U].fnum];R.hits[U].fid=T[R.hits[U].fnum];if(!R.hits[U].flags){R.hits[U].flags={};}}}R.grouplist=R.grouplist||{};if(Z.date&&Z.date.start){delete R.grouplist.date;}if(R.grouplist.attachmenttype&&!Z.attachmenttypes){var O={},a;b=[];for(U=0,P=R.grouplist.attachmenttype.length;U<P;U++){a=J.getAttachmentProperties(R.grouplist.attachmenttype[U].id);if(O[a.type]){O[a.type].count=parseInt(O[a.type].count,10)+parseInt(R.grouplist.attachmenttype[U].count,10);}else{O[a.type]=B.mix(a,R.grouplist.attachmenttype[U]);}}b=B.Object.values(O);b.sort(function(d,c){return(d.type===c.type)?0:((d.type>c.type)?1:-1);});R.grouplist.attachmenttype=b;}if(R.grouplist.folder&&N){b=[];var X="";for(U=0,P=R.grouplist.folder.length;U<P;U++){R.grouplist.folder[U].folder=N[R.grouplist.folder[U].id];X=encodeURIComponent(R.grouplist.folder[U].folder);R.grouplist.folder[U].displayName=M.getSystemFolderName(X,X);b.push(R.grouplist.folder[U]);}b.sort(function(d,c){return(d.displayName===c.displayName)?0:((d.displayName>c.displayName)?1:-1);});R.grouplist.folder=b;}if(R.grouplist.from){b=[];for(U=W,P=R.grouplist.from.length;U<P;U++){b.push(R.grouplist.from[U]);}b.sort(function(d,c){return(d.id===c.id)?0:((d.id>c.id)?1:-1);});R.grouplist.from=[].concat(R.grouplist.from.slice(0,W),b);}if(R.grouplist.date){b=[];for(U=0,P=R.grouplist.date.length;U<P;U++){b.push(R.grouplist.date[U]);}b.sort(function(d,c){return(d.id===c.id)?0:((d.id<c.id)?1:-1);});R.grouplist.date=b;}if(R.grouplist.flags){b=[];var Q,Y={id:"unread",count:R.total};for(U=0,P=R.grouplist.flags.length;U<P;U++){Q=R.grouplist.flags[U];if(R.refinedby.flags&&R.refinedby.flags[Q.id]){continue;}if(Q.id==="read"){Y=null;if((R.total-Q.count)>0){b.push({id:"unread",count:R.total-Q.count});}}else{b.push(Q);}}if((Z.flags&&parseInt(Z.flags.read,10)===0)||(R.refinedby&&R.refinedby.flags&&R.refinedby.flags.unread)){Y=null;}Y&&b.push(Y);R.grouplist.flags=b;}return R;},execute:function(P,N,T){var S=this,U,V=[],X,Y=function(b,d){var f={total:0,hits:null},c=(d)?d.status:"",a=L.show,Z=false;S.req=null;switch(c){case 200:try{f=B.JSON.parse(d.responseText);}catch(g){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-ui-msearch-model-msws:1",g,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-ui-msearch-model-msws:1");}A.stat("search","result=>success,env=>"+NeoConfig.mailEnv+",farm=>"+NeoConfig.farm.substr(1));break;case 400:a(null,strings.str_error_BadRequest,strings.str_error_MailErrorTitle,{modal_classes:"lg"});A.stat("search","result=>failure,env=>"+NeoConfig.mailEnv+",farm=>"+NeoConfig.farm.substr(1));break;case 401:case 402:a(null,strings.str_error_MissingCredentials,strings.str_error_MailErrorTitle,{modal_classes:"lg"});A.stat("search","result=>failure,env=>"+NeoConfig.mailEnv+",farm=>"+NeoConfig.farm.substr(1));break;case 500:A.stat("search","result=>failure,env=>"+NeoConfig.mailEnv+",farm=>"+NeoConfig.farm.substr(1));break;default:A.stat("search","result=>failure,env=>"+NeoConfig.mailEnv+",farm=>"+NeoConfig.farm.substr(1));}S.fire("Request:complete");f.start=S.get("start");f.count=S.get("count");f.query=S.get("query");S.set("response",{query:S.get("query"),response:S.prepareResponse(f)});P&&P.call(N||this,B.mix(S.get("response"),{responseCode:c}));};if(!S.get("query")||!(S.get("query").keyword||S.get("query").date||S.get("query").fnums)){Y();return;}if(S.get("query").keyword){var Q=S.get("query").keyword;if(Q.match(/subject:.*/)){Q=D(I(Q));}var R,O;if((R=/after:([^\s]+)/.exec(Q))){if((O=B.Date.parse(R[1]))){S.get("query").date=S.get("query").date||{};S.get("query").date.start=O.getTime()/1000;}}if((R=/before:([^\s]+)/.exec(Q))){if((O=B.Date.parse(R[1]))){S.get("query").date=S.get("query").date||{};
S.get("query").date.end=O.getTime()/1000;}}S.get("query").keyword=Q.replace(/([\#|\%|\&])/g," ");}S.fire("Request:start");var W=new Date().getTimezoneOffset()*60*-1;U=NeoConfig.launch_protocol+document.location.host+"/mailsearch/v2/search"+"?appid=YahooMailNeo";V.push("appid=YahooMailNeo");V.push("foldername=1");V.push("tzoffset="+W);V.push("start="+S.get("start"));V.push("count="+S.get("count"));S.get("sorting")&&V.push("sorting="+S.get("sorting"));X=B.clone(S.get("query"));if(X&&!X.flags){X.flags={};}B.mix(X.flags,{"softdelete":0},true);V.push("query="+encodeURIComponent(B.JSON.stringify(X)));S.req=H.requestProxy(U,{on:{success:Y,failure:Y},method:"POST",data:V.join("&"),service:"msws",serviceCredType:"strict"});if(T&&T.origin){A.stat("search_query","type=>searchsuggestion");}else{A.stat("search_query","type=>normal");}},abort:function(){var N=this;N.req&&N.req.abort();}},true);function F(V,P,S){var Q=(S)?S.status:"",N=false,U,R,T,W=[];function O(X){var Y,a,Z=B.common.Utils.rocketstats.stat;if(X){a=X.length||0;for(Y=0;Y<a;Y++){Z("mailnet",X[Y]);}}return X;}if(S.callback&&S.callback.service==="msws"){U=S.callback.service;R=S.callback.method;T=S.statusText?S.statusText.replace(/\s/g,"_"):"";switch(Q){case 400:W.push("E_BadRequest400_"+U+"_"+T);N=true;break;case 500:W.push("ue_alert_tae20");break;default:break;}O(W);return N;}return false;}L.onError(F);B.namespace("mail.ui");B.mail.ui.SearchRequest=E;B.mail.ui.parseSearchRequest=G;},"1.0.0",{requires:["mail-ui-searchutils","json","rocket-stats","mail-ui-common-string-utils","datatype-date"]});YUI.add("mail-ui-list-mgr",function(E){var B=E.common.persist.UserData,A="userUIPref.defaultSortOrder",C={};var D=function(){var J=this,g,T,m,M,F,d,e,a,o,t,l,z,I=E.mail.model.DataStore.Messages,y=I.toMessage,R={};function s(){T=[];m={};o=0;d=0;e=0;if(C[g]&&C[g].sortObj){M=C[g].sortObj;}else{M={sortKey:"date",sortOrder:B.get(A)};}t=0;l=NeoConfig.pagedResults?B.get("userUIPref.messagesPerPage")*1:10;V(l);F={all:false,rangeFrom:null,total:0,hash:{}};R={};}function V(AA){a=(AA<100)?100:AA;z=(AA<100)?100:AA;}function W(){if(!C[g]){C[g]={_sortObj:M};return true;}return false;}function p(AB){var AA;g=AB;if(!C[g]){return false;}AA=C[g]._sortObj;if(AA){M={sortKey:AA.sortKey,sortOrder:AA.sortOrder};}return true;}function r(AA){var AB=AA.split("_");return AB[AB.length-1];}function G(AD){var AA=AD.hits,AF=AA.length,AB=0,AE=AD.start||0,AC;d=AD.total||AF;e=AD.start||0;a=AF;for(;AB<AF;AB++){if(!AA[AB]||!AA[AB].mid){continue;}AC=r(AA[AB].mid);m[AC]=AE+AB;o++;AA[AB].hashKey=AC;T[AE+AB]=AA[AB];k(AC,F.all);}}function x(AB){var AC=false,AA=F;if(M.sortKey!==AB.sortKey){O();M.sortKey=AB.sortKey;M.sortOrder=AB.sortOrder;F=AA;}if(M.sortOrder!==AB.sortOrder){if(d===o){T.reverse();N();AC=true;}else{O();}F=AA;M.sortKey=AB.sortKey;M.sortOrder=AB.sortOrder;}t=0;e=0;C[g]._sortObj=M;return AC;}function N(){var AD,AF,AC,AE=o-T.length,AA,AB=F;if(AE>0){e=e-AE;if(e<0){e=0;}if(AE>l){t=(t&&AE/l<=t)?t-(AE/l):t;}else{t=(t&&t*l>=(o-AE))?Math.floor((o-AE)/l)-1:t;}if(d&&AE){d=d-AE;}}AD=T;AF=e;AC=t;AA=d;AB.serverTotal=AA;O();F=AB;G({hits:AD,total:AA});e=AF;t=AC;}function b(){return{list:T};}function u(AF,AA){var AC=(AF*AA),AE=(((AF+1)*AA)<d)?((AF+1)*AA)-1:d-1,AD=[];if(T[AC]){for(var AB=AC;AB<=AE;AB++){if(T[AB]){AD.push(T[AB]);}}}return AD;}function i(AA){return m[r(AA)];}function S(AA){return(AA>=0)&&T[AA];}function H(AB){var AA=m[r(AB)];if(typeof AA==="undefined"){return;}return T[AA];}function L(AB){var AA=m[r(AB)];if(typeof AA==="undefined"){return;}return(AA===0)?T[AA]:T[--AA];}function P(AB){var AA=m[r(AB)];if(typeof AA==="undefined"){return;}return(AA===o-1)?T[AA]:T[++AA];}function Y(AE){var AD={serverTotal:d,serverIndex:e,serverSize:a,cacheIndex:t,cacheSize:l,list:[]},AB,AA;switch(AE){case"first":if((t-1)<0&&NeoConfig.pagedResults){AD.cacheIndex=-1;return AD;}t=0;break;case"prev":if((t-1)<0){AD.cacheIndex=-1;return AD;}t=t-1;if((t*l)<e){AB=e-z;e=(AB>0)?AB:0;}break;case"next":if((t+1)>Math.ceil(d/l)-1){AD.cacheIndex=t+1;return AD;}t=t+1;AA=t*l;if((AA>e)&&!(T[AA])){AB=e+z;e=(AB<=d)?AB:e;}break;case"last":if((t+1)*l>=d){AD.cacheIndex=t+1;return AD;}e=((Math.ceil(d/z)-1)*z);t=Math.ceil(d/l)-1;break;default:var AC=parseInt(AE,10);if(d<1){return AD;}if(!isNaN(AC)){if(AC>0&&AC<=Math.ceil(d/l)){t=AC-1;e=(Math.floor((t*l)/z))*z;break;}}if(R.list&&R.list.length){return R;}break;}AD.cacheIndex=t;AD.serverIndex=e;AD.list=u(t,l);R=AD;return AD;}function Z(){return Y("first");}function Q(AB){var AA={serverTotal:d,serverIndex:e,serverSize:a,cacheIndex:t,cacheSize:l,list:u(AB,l)};return AA;}function h(){return Y("prev");}function f(){return Y("current");}function n(){return Y("next");}function K(){return Y("last");}function O(){s();}function j(AH,AN,AB){if(AH<=-1){return;}var AG=this,AM=AG.getItemFromIndex(AH),AF=AM?I.isCached(AB,AM.mid):false,AJ=((NeoConfig.prefetchMsgsCheckMail==1)?4:(AF?4:2)),AK=[],AI=1,AC=0,AA=0,AE=2,AD=1;function AL(AO){var AP=AG.getItemFromIndex(AO);if(AP&&!I.isCached(AB,AP.mid)){AK.push(AP);return 1;}return 0;}while(AI){if(AA<AE&&!AL(AH-AD)){AA++;}if(AC<AE&&!AL(AH+AD)){AC++;}AI=(AK.length<AJ)&&!(AA==AE&&AC==AE);AD++;if(AD>100){break;}}for(AD=0;AD<AK.length;AD++){AN.push(AK[AD]);}}function c(AB,AC){var AA;if(!AB){return;}AA=m[r(AB)];if(typeof AA!=="undefined"){T[AA]=AC;return true;}}function X(AE,AH){AH=(typeof AH!="undefined")?AH:true;var AF,AB,AG,AD=0,AC,AA=[];if(!AE){return;}AG=(E.Lang.isArray(AE))?AE:[AE];AC=AG.length;for(;AD<AC;AD++){AF=r(AG[AD]);AB=m[AF];if((typeof AB!=="undefined")&&(AH==true)){T.splice(AB,1);if(NeoConfig.pagedResults){F.all=false;}N();AA.push(AF);}else{if(AH===false){d=d-1;}}}return{cacheTotal:o,serverTotal:d,removedItems:AA};}function v(AD){var AC=f();F.all=AD;for(var AB=0,AA=AC.list.length;AB<AA;AB++){AC.list[AB]&&k(r(AC.list[AB].mid),AD);}}function w(AC){F.all=AC;for(var AB=0,AA=T.length;AB<AA;AB++){T[AB]&&k(r(T[AB].mid),AC);}}function k(AC,AD){var AB=r(AC),AA=m[AB];if(typeof AA==="undefined"){return;}if(!AD){if(F.hash[AB]){F.total--;if(F.total===0){F.rangeFrom=null;}delete F.hash[AB];}else{return F;}}else{if(T[AA]&&!F.hash[AB]){F.total++;if(F.total===1){F.rangeFrom=AA;}E.mix(T[AA],y(T[AA].fid,T[AA]));F.hash[AB]=T[AA];}else{return F;}}T[AA].selected=(AD)?"checked":"";F.allSelected=!NeoConfig.pagedResults?(d===F.total):(R.list&&R.list.length===F.total);F.allCacheSelected=!NeoConfig.pagedResults?(o===F.total):F.allSelected;F.serverTotal=d;F.index=AA;J.fire("itemSelect",{key:AC,state:AD,selection:F});return F;}function U(AB){for(var AA in AB){switch(AA){case"cacheSize":l=(AB[AA]<10)?10:AB[AA];V(l);break;default:break;}}}function q(){return({sortInfo:M,selection:F,serverTotal:d,serverIndex:e,serverSize:a,cacheTotal:o,cacheIndex:t,cacheSize:l,origServerSize:z});}E.augment(J,E.EventTarget);s();E.mix(J,{generateKey:r,persist:W,warmCache:p,store:G,sort:x,getAllCachedItems:function(){return T;},getItemIndex:i,getItemFromIndex:S,getPrevItem:L,getItem:H,getNextItem:P,getFirstPage:Z,getPrevPage:h,isPageInCache:Q,getCurrentPage:f,getNextPage:n,getLastPage:K,getPage:Y,getNeighbors:j,updateCacheInfo:U,getCacheInfo:q,update:c,remove:X,flush:O,select:k,selectAll:w,selectPage:v,getAllLoadedPages:b,getSelectedItems:function(){return F;},getSortInfo:function(){return M;}});};E.namespace("mail.ui");E.mail.ui.ListMgr=D;},"1.0.0");YUI.add("mail-ui-mailSearchController",function(B){var C=B.common.Utils,G=C.escapeHtml,K=C.unescapeHtml,J=C.Stopwatch,O=B.mail.ui.SearchBar,F=B.common.persist.UserData,L=B.mail.persist.MetaData,Q=B.mail.model.DataStore,A=["open","forward","reply_sender","reply_all","edit","fullheader","addcontact","set_encodings","print","quick_filter"],I=B.mail.ui.SearchUtils,P=[48,49,50,51,52,53,54,55,56,57],R=[strings.str_cfg_sc_keycode_reply_to_all,strings.str_cfg_sc_keycode_movemenu_display,strings.str_cfg_sc_keycode_message_forward,strings.str_cfg_sc_keycode_mark_as_read,strings.str_cfg_sc_keycode_flag_selected_messages,strings.str_cfg_sc_keycode_reply_to_sender,strings.str_cfg_sc_keycode_print,strings.str_cfg_sc_keycode_close_tab],D=[65,68,70,75,76,82,80,220],S={},N=R.length,M,H=NeoConfig.refineTop;var T=42;for(M=0;M<N;++M){S[R[M]]=D[M];}var E=function(U){var X=this,V,W={fid:{setter:function(Y){X.fid=Y||"%40S%40Search";X.listMgr.warmCache(X.fid);if(U.type==="list"){X.listMgr.persist();}}},customTitle:{},isSnippet:{setter:function(Y){L.set("neo.pref.showSnippetsFresh",Y);},getter:function(){if(X.type==="list"){return false;}return L.get("neo.pref.showSnippetsFresh");}},query:{value:{},setter:function(Y){var Z=B.Lang.trim(Y.keyword);if(typeof Z==="undefined"){return;}X.fire("search:start");if(NeoConfig.tabs){X.set("title",strings.str_tabs_search+(Z.length?": "+G(Z):""));}else{X.set("title",(Z.length?G(Z):""));}X.abort();X.reset();X.listMgr.flush();}},prefilterRefinements:{value:true},showDDWithSearchResults:{value:false},addToRecentSearches:{value:true},searchRequestId:{},displayQueryInSearchBar:{value:true},tabNode:{setter:function(Y){Y.appendChild(B.Node.create('<div class="s-loader srchloading"></div>'));X.on("closeChange",X.close);},validator:function(Y){return Y;},writeOnce:true},searchingContact:{value:"",setter:function(Y){var Z=B.Lang.trim(Y);if(typeof Z==="undefined"){return;}if(NeoConfig.tabs){X.set("customTitle",(Z.length?": "+G(Z):""));}else{X.set("customTitle",(Z.length?G(Z):""));}}},data:{},stopWatchRT:{},responseTime:{value:0}};E.superclass.constructor.call(X);X.listMgr=new B.mail.ui.ListMgr();X.modules={};X.type=U.type;X.supportPreview=(X.type==="list");X.evt=[];X.bulkThreshold=X.listMgr.getCacheInfo().origServerSize;X.listMgr.on("itemSelect",X.listMgrItemSelectHandler,X);X.on("search:start",X.onSearchStartHandler,X);X.on("search:complete",X.onSearchCompleteHandler,X);X.after("activeChange",X.afterActiveChangeHandler,X);X.requests=[];X.delRequests=[];X.dsconvRefresh=false;X.before("titleChange",function(Z){var Y=X.get("customTitle");if(Y){if(Y==="#"){Z.newVal=strings.str_tabs_search;}else{if(Y.noLabel){Z.newVal=Y.value;}else{Z.newVal=strings.str_tabs_search+": "+Y;}}}},X);X.on("search:start",function(){V=(new Date()).getTime();});X.on("darlaEvent",function(){X.set("responseTime",(new Date()).getTime()-V);});X.on("darlaEvent",function(){var c=this,Z=c.listMgr.getCurrentPage(),b,Y,a=c.listMgr.isPageInCache(Z.serverSize/Z.cacheSize+Z.cacheIndex);if(!a.list.length){if((Z.cacheIndex+1)*Z.cacheSize<Z.serverTotal&&Z.serverIndex+Z.serverSize<Z.serverTotal){b={query:c.get("query"),startMid:Z.serverIndex+Z.serverSize};Y=function(d){if(c.type==="list"){d.hits=d.messageInfo;d.count=d.numInfo;d.total=d.folder.total;d.fid=c.fid;d=I.processListData(d,c.fid);}if(d.hits||d.response){d.start=d.startInfo;c.listMgr.store(d.response||d);}};if(c.type==="search"){}else{B.Lang.later(100,c,function(){c.makeRequest("list",b,Y);});}}}});X.evt.push(B.on("ds:msg:remove",X.removeMsgHandler,X));X.evt.push(B.on("ds:msg:change",X.changeMsgHandler,X));X.evt.push(B.on("ds:msg:add",X.addMsgHandler,X));X.evt.push(B.on("ds:conv:change",X.changeConvHandler,X));X.evt.push(B.on("ds:conv:remove",X.removeConvHandler,X));X.evt.push(B.on("ds:folder:change",function(d,b,a,c){if(X.type!=="list"){return;}if(c==="ds:msg:"){var Z;for(M=0;M<b.length;M++){if(b[M].folderInfo.fid===X.fid){Z=" <i>("+b[M].total+")</i>";break;}}Z&&X.set("title",X.fid+Z);return;}var Y;for(M=0;M<b.length;M++){if(b[M].folderInfo.fid==="Inbox"){Y=true;break;}}if(c==="checkmail"&&X.fid==="Inbox"&&Y){X.fire("search:start");X.listMgr.flush();X.abort();X.makeRequest("list",{fid:"Inbox"});}},X));X.evt.push(B.on("msgsview:movetonewfolder",function(){var Y=B.mail.Tabs.getActiveTab();if(Y&&Y.widget&&Y.widget===X){X.toolbarHandler.call(X,{dataAction:"folder-new"});}},X));X.evt.push(B.on("ds:msg:remove",function(Z,Y){if((Z==="Trash"||Z==="%40B%40Bulk")&&Y==0){C.rocketstats.stat("msearch","TAE4:EmptyFolder:"+Z);}},X));X.addAttrs(W,U||{});X.listMgr.persist();B.augment(X,B.EventTarget);X.set("charCodes","13,27,33,34,37,38,39,40,46,188,190,"+P.join(",")+","+R.join(","));};B.extend(E,B.mail.ui.BaseWidget);B.mix(E.prototype,{NAME:"MailSearch",type:"searchlist",reset:function(){var W=this,V=W.modules;if(V){for(var U in V){if(V[U]){if(typeof V[U].close==="function"){V[U].close();V[U]=null;}}}V={};}},render:function(U){var V=this;V.set("tabNode",B.Node.one(U));if(V.type==="list"){V.listMgr.flush();V.renderLaunchToInbox();}},renderLaunchToInbox:function(){var a=this,U=a.listMgr.getSortInfo(),Z=NeoConfig.pagedResults?F.get("userUIPref.messagesPerPage")*1:10,W,V=NeoConfig.folders.numberOfFolders,Y={fid:"Inbox",numInfo:(Z<100)?100:Z,bidiDetection:NeoConfig.bidi,sortKey:(U.sortKey==="from")?"sender":U.sortKey,sortOrder:U.sortOrder},X={hits:NeoConfig.msgListObj,count:NeoConfig.msgListObj.length,type:"list",fid:"Inbox",sortOrder:U.sortOrder};a.set("fid","Inbox");for(W=0;W<V;W++){if(NeoConfig.folders.folder[W].folderInfo.fid===Y.fid){X.total=NeoConfig.folders.folder[W].total;break;}}X.start=(U.sortOrder==="up")?(X.total-NeoConfig.msgListObj.length):0;a.set("searchRequest",Y);a.searchResponseHandler({response:X,rendered:(U.sortOrder==="up")?false:true});},updateSearchQueryDisplay:function(){var V=this.get("query"),U=(V&&V.keyword)||"",X=B.Lang.trim(U),W=this.get("searchingContact");if(this.get("displayQueryInSearchBar")){if(!W){O.getSearchField().set("value",K(G(X)));}else{O.getSearchField().set("value",K(G(W)));
}}},sync:function(){var V=this,U=B.Lang.trim(V.get("query").keyword||"");this.updateSearchQueryDisplay();V.stopWatchRT=V.getStopwatch({source:"workspace"});if(NeoConfig.tabs){V.set("title",strings.str_tabs_search+(U.length?": "+G(U):""));}else{V.set("title",(U.length?G(U):""));}B.mail.ui.SearchRequest.headerSearch=0;V.makeRequest("search",{query:V.get("query"),prefilterRefinements:V.get("prefilterRefinements")},V.searchResponseHandler);V.preloadDependencies();},getStopwatch:function(V){var W=this,U={};if(V.source==="workspace"){U=W.get("stopWatchRT");}else{U=new J("Search","start");}U.source=V.source;return U;},preloadDependencies:function(){var Y="_shared_module_search_with_snippet_rollup",Z=(NeoConfig.isSSL?"https://s.yimg.com":"http://mail.yimg.com")+"/ok/u/assets/img/display-img/",V=["profile_16a.png","profile_16b.png","profile_16c.png","profile_16d.png","profile_16e.png"],W;B.use("mail-ui-advancedSearchController","mail-ui-searchGroupsController","mail-ui-searchListController","mail-ui-toolbarController","contacts-api","contacts-api-utils","stylesheet","mail-ui-messageaction","mail-ui-inboxmenu-base","mail-common-inline-edit",Y);for(var X=0,U=V.length;X<U;X++){W=new Image();W.src=Z+V[X];}},getSortParam:function(){var X=this,U=X.listMgr.getSortInfo(),W,V="none";if(U.sortKey==="attachmentcount"){W="date";V="hasAttachment";}else{if(U.sortKey==="flagged"){W="date";V="flagged";}else{if(U.sortKey==="unRead"){W="date",V="unRead";}}}return(V==="none")?{reqMix:false}:{reqMix:true,sortKey:W,groupBy:V};},makeRequest:function(W,Y,X){var b=this,d=b.listMgr.getSortInfo(),Z={start:Y.startMid||0,query:Y.query,sorting:d,prefilterRefinements:("prefilterRefinements" in Y)?Y.prefilterRefinements:true},U,c,V,a=NeoConfig.pagedResults?F.get("userUIPref.messagesPerPage")*1:10;if(W==="list"){if(Y.fid){b.set("fid",Y.fid);}Z={fid:Y.fid||b.fid,startInfo:Y.startMid||0,numInfo:(a<100)?100:a,bidiDetection:NeoConfig.bidi,sortKey:(d.sortKey==="from")?"sender":d.sortKey,sortOrder:d.sortOrder},c={success:X||function(e){b.set("searchRequest",Z);b.searchResponseHandler.call(b,{response:{hits:e.messageInfo,count:e.numInfo,total:e.folder.total,type:"list",fid:Y.fid||b.fid,start:Y.startMid||0}});},failure:function(){},timeout:NeoConfig.wsListTimeout||60000,suppressCodes:["*"],suppressLogs:(Y.fid==="%40C%40Chats")&&["Client.FolderIdDoesntExist"],exceptCodes:[999]},V=b.getSortParam();if(V.reqMix){B.mix(Z,{sortKey:V.sortKey,groupBy:V.groupBy},true);}b.requests.push(B.mail.Controller.Messages.list(Z,c));}else{b.stopWatchRT&&b.stopWatchRT.start(1,"serverRequest");if(!Y.disableRefinements){if(Y.prefilterRefinements){Z=B.mail.ui.parseSearchRequest(Z);}Z.query=B.mix(Z.query,{"group":{"from":{},"folder":{},"flags":{order:"desc"},"attachmenttype":{},"date":{unit:(Y.query.date&&Y.query.date.year)?"month":"year"}}},true);}if(Y.count){Z.count=Y.count;}U=new B.mail.ui.SearchRequest(Z);b.set("searchRequest",U);U.execute(X,b);b.makeDmRequest();}},makeDmRequest:function(){var a=this,Z,Y=true,V=a.get("query").keyword||"",U=V.match(/^from:/i)?true:false,X,W;if(NeoConfig.hasAds&&NeoConfig.dmEnabled&&V&&(B.Lang.trim(V)!=="")&&(!U||(U&&Y))){X=function(){var b;if(Z&&V&&(B.Lang.trim(V)!=="")&&(!U||(U&&Y))){b=Z.get("responseTime");if((!b||b>NeoConfig.dmSLA)&&a.get("responseTime")>NeoConfig.dmSLA){C.rocketstats.stat("dmsearch","failure:missedsla");B.fire("mbEvent",{action:"show",source:"search"});C.rocketstats.stat("dmsearch","mbbackfill");return;}var d=a.get("tabNode"),c=d.one(".content.search")!==null?d.one(".content.search"):d.one(".result>.list-view");Z.set("rootNode",c);Z.render();}};if(a.get("dmDarlaEvent")){a.get("dmDarlaEvent").detach();}a.set("dmDarlaEvent",a.after("darlaEvent",X));B.use("mail-ui-dmsearch-controller",function(b){Z=new b.mail.ui.dmsearchController({seedTerm:V,partner:NeoConfig.dmSrcTag});Z.process();});}else{W=NeoConfig.intl+(NeoConfig.partnerType?"_"+NeoConfig.partnerType:"");C.rocketstats.stat("dmsearch","notenabled");C.rocketstats.stat("dmsearch","notenabled"+"_"+W);if(NeoConfig.isMailPlus){C.rocketstats.stat("dmsearch","mailplus");C.rocketstats.stat("dmsearch","mailplus"+"_"+W);}}},abort:function(){var W=this,U,V=W.get("searchRequest");if(W.type==="list"){for(U=0;U<W.requests.length;U++){W.requests[U].abort();}}else{V&&V.abort();}},openInPreviewPane:function(X){var Y=this,V=B.mail.model.DataStore.Messages.toMessage(Y.fid,X),W=[],U=Y.msgPane.get("message");if(Y.type==="list"&&NeoConfig.pageMode==0){if((U==null||U.message.mid!==V.mid)){Y.listMgr.getNeighbors(Y.listMgr.getItemIndex(X.mid),W,Y.fid);Y.msgPane.set("message",{fid:Y.fid,message:V,neighbors:W,index:null});Y.msgPane.render("#inboxcontainer");}return;}},requestAction:function(W,Y,U){var Z=this,X=B.one("#redirectMsg"),V=X&&X.get("value");B.use("mail-ui-messageaction",function(e){var b={action:W,fid:Z.fid,forwardAsAttachment:Y.forwardAsAttachment||false,msgs:Y.msgs,msgInfo:Y.msgInfo,destinationFid:Y.destinationFid,redirectToEmail:V,index:Y.index};if(W==="openInPane"){Z.openInPreviewPane(Y.msgs[0]);return;}if(W==="open"){var a,d=Z.listMgr,c=[];if(NeoConfig.prefetchMsgsFolders){d.getNeighbors(b.index,c,b.fid);}if(Z.type==="search"){a=Z.get("searchRequest")&&Z.get("searchRequest").getAttrs();}else{if(Z.type==="list"){a=Z.get("searchRequest");}}if(a){delete a.response;}e.mix(b,{fid:(Y.msgs&&Y.msgs[0].fid)||Z.fid,sortCol:d.getSortInfo(),query:Z.get("query"),neighbors:c,arrMsgSeq:d.getAllCachedItems(),searchRequestAttrs:a,searchListMgr:e.clone(d),processData:I.processListData,type:Z.type},true);}e.mail.ui.MessageAction.handle(W,b,U);});},retainSelection:function(W){var a=this,V=a.modules.listview,Y,Z,U={"read":true,"unread":true,"flagged":true,"unflagged":true,"fullheader":true,"set_encodings":true,"spam":true,"sendercompromised":true,"phished":true,"delete":(a.type==="list")?true:false,"move":(a.type==="list")?true:false,"trash":(a.type==="list")?true:false};if(!U[W]){a.listMgr.selectAll(false);V&&V.selectItems(false);if(NeoConfig.pagedResults&&V){Y=V.get("focusNode");if(Y){Z=a.listMgr.getNextItem(Y.getAttribute("data-key"));
try{V.setFocusNode(a.listMgr.generateKey(Z.mid),true,true);V.set("firstSelectedMid",Z.mid);a.listMgr.select(Z.mid,true);}catch(X){}}}}},handleMessageAction:function(X,W){var a=this,e=a.modules.listview,b=a.listMgr.getSelectedItems(),c=a.listMgr.getCacheInfo(),V=W.fid,Y=W.selectedItems,d=W.cbk,Z=W.forwardAsAttachment;switch(Y.total){case 0:I.showAlert("emptySelection");return;case 1:break;default:if(B.Array.indexOf(A,X)!==-1){I.showAlert("multipleSelection");return;}break;}var U=(b.all&&!NeoConfig.pagedResults)?c.serverTotal-c.cacheTotal+b.total:b.total;if(!NeoConfig.pagedResults&&!Y.singleOp&&U>=a.bulkThreshold){B.use("mail-ui-bulk-progress",function(g){var h=g.mail.ui.BulkProgressbar,f;a.modules.bulkProgress=h;h.set("action",X);h.set("progress",0);h.render();h.once("cancelProgress",function(){a.modules.bulkProgress=null;f=(NeoConfig.pagedResults)?a.listMgr.getCurrentPage():a.listMgr.getFirstPage();if(e){e.pruneItems();e.appendPageData(f);a.retainSelection(X);}},a);if(c.serverTotal!=c.cacheTotal&&b.all){a.bulkActionHandler(X,V,{startMid:0,serverTotal:b.serverTotal},b.serverTotal);}else{a.cacheActionHandler(X,V,g.clone(Y));}});}else{if(X==="delete"&&W.selectedItems.total>1&&a.listMgr.getCurrentPage().list.length==W.selectedItems.total){I.showConfirm("removeAll",function(){a.cacheActionHandler(X,V,B.clone(Y),d,Z);});}else{a.cacheActionHandler(X,V,B.clone(Y),d,Z);}}},cacheActionHandler:function(X,W,Z,f,a){var c=this,j=0,V=Z.total>c.bulkThreshold,d=c.modules.bulkProgress,Y=[],h=[],i,U,g=c.modules.listview,b=Z.index;if(V&&!d){return;}for(var e in Z.hash){j=j+1;Y.push(Z.hash[e]);U=Z.hash[e].mid;h.push(U);delete Z.hash[e];if(j>=c.bulkThreshold||B.Object.size(Z.hash)===0){c.requestAction(X,{msgs:Y,msgInfo:Y,destinationFid:W,forwardAsAttachment:a,index:b},{success:function(k){if(c.type==="list"&&c.delRequests.length>0){g.appendPageData(c.delRequests[c.delRequests.length-1]);}else{if(NeoConfig.pagedResults&&(c.listMgr.getCacheInfo().cacheSize>=100)&&c.isMutableAction(X,{response:c.get("data")})){g.appendPageData(c.listMgr.getCurrentPage());}else{if(NeoConfig.pagedResults&&(c.listMgr.getCacheInfo().cacheSize<100)&&c.isMutableAction(X,{response:c.get("data")})){g.pruneItems();g.appendPageData(c.listMgr.getCurrentPage());}}}if(k===X){c.retainSelection(X);return;}i=((Z.total-B.Object.size(Z.hash))/Z.total)*100;d&&d.set("progress",i);if(i<100){c.cacheActionHandler(X,W,Z,f,a);}if(i===100){f&&f.success&&f.success(k);c.retainSelection(X);}},failure:function(k){f&&f.failure&&f.failure(k);c.retainSelection(X);}});return;}}},bulkActionHandler:function(X,Z,V,U){var a=this,Y,W;Y={query:a.get("query"),count:a.bulkThreshold,startMid:V.startMid||0,disableRefinements:true};W=function(g){var c=g.response.hits,f=[],h=a.listMgr.getSelectedItems(),d;for(var e=0,b=c.length;e<b;e++){d=a.listMgr.getItem(c[e].mid);if((!d&&h.all)||(d&&d.selected==="checked")){f.push(c[e]);}}if(f.length>0){a.requestAction(X,{msgs:f,msgInfo:f,destinationFid:Z},function(){var k,i,m,l=a.modules.bulkProgress;if(!l){return;}if(!g.response||!g.response.hits){l.set("progress",100);return;}if(a.isMutableAction(X,g)){k=0;i=U-g.response.hits.length;m=((V.serverTotal-i)/V.serverTotal)*100;}else{k=V.startMid+g.response.hits.length;i=U;m=(k/i)*100;}l.set("progress",Math.floor(m));if(k<U){a.bulkActionHandler(X,Z,{startMid:k,serverTotal:V.serverTotal},i);}});}else{var j=a.modules.bulkProgress;j&&j.set("progress",100);}};if(a.type==="search"){a.makeRequest("search",Y,W);}},isMutableAction:function(V,U){if(U&&U.response.refinedby&&B.Object.size(U.response.refinedby)){if(typeof U.response.refinedby.flags!=="undefined"&&typeof U.response.refinedby.flags.unread!=="undefined"&&V==="read"){return true;}if(typeof U.response.refinedby.flags!=="undefined"&&typeof U.response.refinedby.flags.flagged!=="undefined"&&V==="unflagged"){return true;}if(typeof U.response.refinedby.fnums!=="undefined"&&typeof U.response.refinedby.fnums[0]!=="undefined"){switch(V){case"inbox-move":case"folder-new":case"move":case"delete":return true;}}}else{switch(V){case"inbox-move":case"folder-new":case"spam":case"sendercompromised":case"phished":return true;}}return false;},searchResponseHandler:function(Y){var Z=this,X=Y.response,U=B.mail.Tabs.getActiveTab(),V=Z.stopWatchRT,W;X.responseCode=Y.responseCode;if(V){V.matches=(X.hits&&X.hits.length)||0;V.start(1,"renderSearch");V.start(2,"renderSearchContent");}if(U&&U.widget&&U.widget!=Z){Z.once("activeChange",function(){if(Z.type==="list"&&(Y.response&&Z.fid!==Y.response.fid)){return;}B.Lang.later(2,Z,function(){Z.searchResponseHandler(Y);});},Z);delete Y.rendered;return;}B.fire("tictac:search:complete",{data:X,tab:U});X.type="search";X.showDD=Z.get("showDDWithSearchResults");Z.get("tabNode")&&this.get("tabNode").one(".srchloading")&&Z.get("tabNode").one(".srchloading").addClass("hidden");Z.set("data",X);Z.reset();Z.listMgr.flush();if(!X||!X.total||(X.hits&&X.hits.length===0)){Z.renderAdvancedSearch(X);V&&V.stop();return;}Z.listMgr.store(X);W=(Z.type==="list"&&Y.response.sortOrder==="up")?Z.listMgr.getLastPage():Z.listMgr.getCurrentPage();W.rendered=(Z.type==="list"&&W.list.length===0)?true:X.rendered;Z.renderSearchList(W);if(Z.type==="search"){Z.renderSearchGroups(X);}V&&V.stop();},renderAdvancedSearch:function(V){var X=this,U,W;U=new J("renderAdvancedSearch");B.fire("navigation:switch",{"type":"empty-search"});if(X.type==="list"){B.use("mail-ui-emptyFolderController",function(Z){W=new Z.mail.ui.EmptyFolderController({rootNode:X.get("tabNode")});W.process();U.stop();X.fire("search:complete");});}else{B.use("contacts-api","contacts-api-utils",function(b){var Z=b.contacts,a=Z.utils,c=Z.api;if(!a.areContactsLoaded()){c.load();}});B.use("mail-ui-advancedSearchController",function(a){var Z;X.renderToolbar("");Z=new a.mail.ui.AdvancedSearchController({data:X.get("data"),query:X.get("query"),searchingContact:X.get("searchingContact"),rootNode:X.get("tabNode"),responseCode:V.responseCode});X.modules.AdvancedSearch=Z;Z.process();Z.on("doMailSearch",function(Y){X.stopWatchRT=X.getStopwatch({source:"advancedSearch"});
X.set("query",Y.query);X.updateSearchQueryDisplay();X.makeRequest("search",{query:Y.query},X.searchResponseHandler);});U.stop();X.fire("search:complete");});}},renderToolbar:function(W){var X=this,U,V;U=new J("renderToolbar");V=NeoConfig.hasConv?"minty_module_toolbar_inbox_search_thread_rollup":"minty_module_toolbar_inbox_search_fresh_rollup";B.use("mail-ui-toolbarController","mail-ui-button-ctxt",V,function(a){var Z;if(!X.modules.topToolbar){X.set("contentToolbar","");Z=new a.mail.ui.ToolbarController({data:W,rootNode:a.one("#toolbar"),template:a.ui.Templates[V],listMgr:X.listMgr,fid:X.fid,position:"top"});X.modules.topToolbar=Z;Z.process();Z.after("activeChange",function(Y){X.set("contentToolbar",Y.newVal?Z.get("widget"):"");},X);Z.on("close",function(){X.set("contentToolbar","");});Z.on("itemSelected",X.toolbarHandler,X);X.set("contentToolbar",Z.get("widget"));}a.one("#pagetoolbar").addClass("hideReplyGroup");U.stop();});},renderSearchList:function(W){var Y=this,X=Y.get("isSnippet"),V="_shared_module_search_with_snippet_rollup",U;U=new J("renderSearchList");W.type=Y.type;W.showDD=Y.get("showDDWithSearchResults");B.use("mail-ui-searchListController",V,function(a){var Z=new a.mail.ui.SearchListController({listMgr:Y.listMgr,isSnippet:X,data:W,rawData:Y.get("data"),query:Y.get("query"),rootNode:Y.get("tabNode"),makeRequest:a.bind(Y.makeRequest,Y),fid:Y.fid});Y.modules.listview=Z;Z.process();Z.on("doMailSearch",function(b){Y.stopWatchRT=Y.getStopwatch({source:"searchList"});Y.set("query",b.query);Y.updateSearchQueryDisplay();Y.makeRequest("search",{query:b.query},Y.searchResponseHandler);});Z.on("messageAction",function(b){Y.handleMessageAction(b.action,b.params);});Z.on("toggleSearchView",function(){Y.toggleSearchViewHandler();},Y);Z.on("openInPreviewPane",function(c){var b=c.mid.split("_");Y.openInPreviewPane(c.message.hash[b[b.length-1]]);},Y);Z.on("updatePagination",function(d){var f=this,b=f.modules.topToolbar,c=f.modules.bottomToolbar;if(b){b.updatePaginationStatus(d.pageData);}if(c){c.updatePaginationStatus(d.pageData);}(f.type==="list")?f.handleDarlaEvent():f.fire("darlaEvent",{action:"search_results"});},Y);Y.modules.bottomToolbar=null;Y.stopWatchRT&&Y.stopWatchRT.start(3,"renderToolbar");Y.renderToolbar(Y.get("data"));U.stop();Y.fire("search:complete");if(Y.type==="list"&&NeoConfig.pageMode==0){if(!Y.msgPane){Y.msgPane=new a.mail.ui.MessagePane();}Y.msgPane.set("message",null);Y.msgPane.render("#inboxcontainer");}});if(NeoConfig.useDD&Y.supportPreview){B.use("mail-ui-messagesview-dd","mail-ui-messagesview-resize",function(Z){if(typeof Z.mail==="object"&&typeof Z.mail.MessagesViewDD==="object"){Z.mail.MessagesViewDD.setDD(Y);}else{}if(typeof Z.mail==="object"&&typeof Z.mail.ui.MessagesViewColResize==="object"){}else{}});}},renderSearchGroups:function(V){var W=this,U;U=new J("renderSearchGroups");B.use("mail-ui-searchGroupsController",function(Z){var X=new Z.mail.ui.SearchGroupsController({data:V,query:W.get("query"),searchingContact:W.get("searchingContact"),rootNode:NeoConfig.refineTop?W.get("tabNode"):Z.one("#shellnavigation")});W.modules.SearchGroups=X;X.process();X.on("doMailSearch",function(Y){W.stopWatchRT=W.getStopwatch({source:"searchGroups"});W.set("query",Y.query);Z.fire("contactdetail:filter",Y);W.updateSearchQueryDisplay();W.makeRequest("search",{query:Y.query,prefilterRefinements:W.get("prefilterRefinements")},W.searchResponseHandler);});U.stop();});B.fire("navigation:switch",{"type":"searchNav"});},onKeyDown:function(W){var Y=this,V=W.metaKey,U=W.ctrlKey,X="";W.keyCode=S[W.keyCode]||W.keyCode;switch(W.keyCode){case 68:B.fire("toolbar:ui-automation","menu","move");return true;case 220:if(V||U){Y.set("close",1);X=B.one("body").getAttribute("data-open");if(X==="searchNav"){X="";}B.fire("navigation:switch",{"type":X});B.mail.Tabs.switchToTab(B.mail.Tabs.tabs[0]);return true;}break;case 27:if(Y.type==="search"){Y.set("close",1);X=B.one("body").getAttribute("data-open");if(X==="searchNav"){X="";}B.fire("navigation:switch",{"type":X});B.mail.Tabs.switchToTab(B.mail.Tabs.tabs[0]);}return true;}return Y.modules.listview.keydownHandler(W);},toolbarHandler:function(Y,W){var Z=this,X,U=Z.modules.listview;switch(Y.dataAction){case"selectAll-message":var V=!Z.listMgr.getSelectedItems().all;Z.listMgr.selectAll(V);U.selectItems(V);Z.setSelectAllNode(V);break;case"select-dd":U.createSelectMenu(Y.item);break;case"sender":case"subject":case"date":case"unRead":case"attachment":case"sort-flagged":U=Z.modules.listview;Y.currentTarget=Y.item;U.viewClickHandler(Y);break;case"fullpage-view":case"scroll-view-prev":case"scroll-view-prev-beside":case"scroll-view-noprev":X=new B.mail.ui.MailView();X.switchView(Y.dataAction);break;case"tab":B.use("common-ui-navtabs",function(){B.common.ui.NavTabs.setTabs(1);});break;case"recent":B.use("common-ui-navtabs",function(){B.common.ui.NavTabs.setTabs(0);});break;default:Z.modules.listview.actionHandler(Y,W);break;}},toggleSearchViewHandler:function(){var W=this,V=!W.get("isSnippet"),U;U=W.listMgr.getCurrentPage();if(!NeoConfig.pagedResults&&U.cacheIndex>0){U=W.listMgr.getFirstPage();}if(U.list.length){W.set("isSnippet",V);W.modules.listview.close();W.modules.listview=null;W.renderSearchList(U);}W.updateToolbars();},listMgrItemSelectHandler:function(){var U=this;U.updateToolbars();},setSelectAllNode:function(V){var W=this,U=B.one(".cbox input");B.Lang.later(0,W,function(){U.set("checked",V);});},updateToolbars:function(){var Z=this,U,V,W,Y=[Z.modules.topToolbar,Z.modules.bottomToolbar],X=Z.listMgr.getSelectedItems();if(NeoConfig.grayoutEnabled){for(U=0;U<2;++U){V=Y[U];if(V){W=V.get("widget");if(W&&W.setButtonContext){W.setButtonContext(X.total);}}}}},removeMsgHandler:function(b,g){var c=this,a,d=g?g.length:0,j=c.modules.listview,Z={},X,V,U,Y=j.get("focusNode"),h=c.get("tabNode"),e=0,W,f;for(a=0;a<d;a++){if(!g[a].flags.isSpam&&c.type==="search"){continue;}c.listMgr.select(g[a].mid,false);X=c.listMgr.generateKey(g[a].mid);if(Y&&Y.getAttribute("data-key")==X){V=c.listMgr.getItemIndex(g[a].mid);
U=c.listMgr.getItemFromIndex(V+1)||c.listMgr.getItemFromIndex(V-1);}if(c.listMgr.getSelectedItems().all===true){if(NeoConfig.pagedResults){Z=c.listMgr.remove(g[a].mid);}else{if(c.listMgr.getSelectedItems().index===(d-1)){Z=c.listMgr.remove(g[a].mid,false);}else{Z=c.listMgr.remove(g[a].mid);j.removeItem(X);}}}else{Z=c.listMgr.remove(g[a].mid);j.removeItem(X);}e=e+1;}if(Z.serverTotal===0){c.reset();c.renderAdvancedSearch();}else{if(NeoConfig.pagedResults){j.pruneItems();j.setStatus(strings.str_msg_list_loading);W=c.listMgr.getCurrentPage();f=!(W.list.length===0&&(W.cacheIndex*W.cacheSize<W.serverTotal));if((c.type==="search")||f){j.appendPageData(W);}else{c.delRequests.push(W);}}else{e&&j.appendPageData(c.listMgr.getNextPage());if(c.listMgr.getSelectedItems().all&&(c.listMgr.getSelectedItems().index!==(d-1))){j.clearLoadingStatus();}}Z.serverTotal&&j.updateTitle(Z);}if(U){j.setFocusNode(c.listMgr.generateKey(U.mid),false,true);if(c.type==="list"&&NeoConfig.pageMode==0){c.listMgr.select(U.mid,true);c.openInPreviewPane(U);}}},addMsgHandler:function(W,U,V){var X=this;(V==="encoding")&&X.changeMsgHandler(W,U,U,U,V);},changeMsgHandler:function(a,U,V,j,Z){var b=this,X,c=V.length,g=b.modules.listview,e,h,W,f,Y=B.mail.model.DataStore.Messages.toMessageInfo;for(X=0;X<c;X++){W=b.listMgr.getItem(V[X].mid);f=Y(a,V[X]);if(W&&f){h=C.merge(W,f);}if(!h){continue;}if(e=j[X].folderInfo){h.folder=Q.Folders.get(e.fid).folderInfo.name;h.fid=e.fid;}if(j[X].flags){if(typeof j[X].flags.isRead!=="undefined"){h.flags.read=j[X].flags.isRead;}if(typeof j[X].flags.isFlagged!=="undefined"){h.flags.flagged=j[X].flags.isFlagged;}}if(j[X].header){C.merge(h,Y(a,j[X]));}b.listMgr.update(V[X].mid,h);switch(Z){case"move":case"remove":(b.type==="search")&&g.updateItemFolder(b.listMgr.generateKey(V[X].mid),h);g.updateItemClass(V[X].mid,(a==="Trash")?"Trash-move":"move");break;case"flag":for(var d in j[X].flags){g.updateItemClass(V[X].mid,d+"-"+j[X].flags[d]);}break;case"encoding":g.updateItemSubject(b.listMgr.generateKey(V[X].mid),h);break;}}},changeConvHandler:function(U){var V=this;if(U==="move"){V.dsconvRefresh=true;}},removeConvHandler:function(){var U=this;U.dsconvRefresh=true;},onSearchStartHandler:function(){var X=this,W=X.get("tabNode"),U=NeoConfig.intl+(NeoConfig.partnerType?"_"+NeoConfig.partnerType:""),V;X.searchStopwatch=new J("MailSearch");if(W){V=W.all("div.content");V&&V.remove();W.one("h3.loading")&&W.one("h3.loading").removeClass("hidden");}C.rocketstats.stat("msearch","startsearch");C.rocketstats.stat("msearch","startsearch"+"_"+U);},onSearchCompleteHandler:function(){var Y=this,X=Y.get("tabNode"),V=Y.get("data"),U=Y.get("searchRequestId"),W=Y.stopWatchRT||{};X&&X.one("h3.loading")&&X.one("h3.loading").addClass("hidden");Y.searchStopwatch&&Y.searchStopwatch.stop&&Y.searchStopwatch.stop();W.action="results";if(V&&V.refinedby&&B.Object.size(V.refinedby)){Y.fire("darlaEvent",{action:"search_refinement"});W.action="refinement";}else{if(Y.get("query").keyword){Y.fire("darlaEvent",{action:"search_results",value:Y.get("query").keyword});}else{if(Y.type==="list"){Y.handleDarlaEvent();}else{Y.fire("darlaEvent",{action:"search_results"});}}}if(NeoConfig.recentSearch&&Y.get("query").keyword&&B.mail.ui.searchTab.widget.get("addToRecentSearches")){B.mail.ui.RecentSearches.addNewSearchItem(Y.get("query").keyword);}B.fire("global:search:complete",U);B.fire("search-stat:renderComplete");},handleDarlaEvent:function(X){var Z=this,Y={Inbox:"folderview_inbox","%40C%40Chats":"folderview_chat",Draft:"folderview_draft",Sent:"folderview_sent",Trash:"folderview_trash","%40B%40Bulk":"folderview_bulk"},U,V,W=Z.get("data");V=X||(!W||!W.total||(W.hits&&W.hits.length===0));U=Y[Z.fid]||"folderview_custom";Z.fire("darlaEvent",{action:V?U+"_empty":U});},afterActiveChangeHandler:function(Z){var a=this,X=a.modules,V=a.get("query").keyword,Y=a.get("data"),U=B.one("#shellnavigation");if(X){for(var W in X){if(X[W]){X[W].set("active",Z.newVal);}}}if(a.type==="search"){if(Z.newVal){if(a.dsconvRefresh){a.dsConvRefresh=false;a.sync();}if(typeof Z.prevVal!=="undefined"){if(Y&&Y.refinedby&&B.Object.size(Y.refinedby)){a.fire("darlaEvent",{action:"search_refinement"});}else{if(V){a.fire("darlaEvent",{action:"search_results",value:V});}else{a.fire("darlaEvent",{action:"search_results"});}}}}else{U.all(".items").removeClass("hidden");}}else{if(Z.newVal){a.handleDarlaEvent();}}},close:function(){var W=this,U=W.evt,V;W.abort();W.reset();O.getSearchField().set("value","");B.one("#shellnavigation").all(".items").removeClass("hidden");for(V in U){B.detach(U[V]);}B.mail.ui.searchTab=null;}},true);B.namespace("mail.ui");B.mail.ui.Search=E;},"1.0.0",{requires:["json","mail-ui-basewidget","common-utils","mail-ui-searchutils","mail-ui-search-model","mail-ui-list-mgr","mail-recent-searches"]});