YUI.add("mail-ui-composeview-compose-loader",function(B){var A=function(C){this.context=C.context||{};this.workspace=C.workspace||null;this.is_tab_deactive=C.force||false;this.tabs=C.tabs||null;this.strings=C.strings||{};this.openAsDraft=C.openAsDraft||false;this.composeDeps=["_shared_module_toolbar_compose","_shared_module_compose_message_header","_shared_module_offscreen_bin_compose","_shared_module_offscreen_bin_compose_menu_color_picker","_shared_module_offscreen_bin_compose_menu_spellcheck","_shared_module_offscreen_bin_compose_modal_cancel_compose","_shared_module_offscreen_bin_compose_menu_spell_langs","_shared_module_compose_reply","mail-ui-authorview-conv"];};A.prototype.addModule=function(C){this.composeDeps.push(C);};A.prototype.load=function(){var E=this,D=new B.common.Utils.Stopwatch("Compose","start"),C=[].concat(E.composeDeps);E.stopwatch=D;B.fire("Y.mail.ui.Workspace:composeMessage:start");E.prefetch_message();C.push(this.show_compose.bind(E));B.fire("load-load-address-book-contacts");D.start(1,"moduleLoad");B.use.apply(B,C);};A.prototype.prefetch_message=function(){var E=this;if(E.context.cdo&&!E.context.cdo.get("passive")){var F=E.context.oMsg,D=E.context.fid,C=new B.mail.Services.MessageService({stopwatch:E.stopwatch,cacheKey:"ComposeOrigin"});C.get(F.mid,D);}};A.prototype.show_compose=function(){var D=this,H,G=D.strings.str_tabs_compose_fresh,F=D.context.action,E=D.context.widget,C=D.stopwatch;C.start(1,"initView");window.UploaderService=window.UploaderService||B.mail.UploaderService;H=new B.mail.ui.AuthorViewConv();C.action=F;D.context.stopwatch=C;H.initCompose(D.context,D.openAsDraft);if(D.context.oMsg&&D.context.oMsg.header){G=B.common.Utils.escapeHtml(B.common.Utils.unescapeHtml(D.context.oMsg.header.subject));}H.set("title",G);if(E){D.prepare_tab_for_compose(H,E,F);}else{var I=D.composify_tab(H);if(!I){return;}}H.bindComposeView();B.common.Utils.log({"m":"composeView bound to the tab with which it is housed"});D.show_compose_end(H);};A.prototype.prepare_tab_for_compose=function(D,G,F){var I=this,J=G&&G.msgPane,C=G.tab||I.tabs.getActiveTab(),E=F==="reply_all"||F==="reply_sender"||F==="forward",K=!I.context.hasMsgList&&E&&J&&NeoConfig.send_confirm_nav_enabled;if(K){var H=I.context.oMsg&&I.context.oMsg.header&&I.context.oMsg.header.subject;D.backToMessageTab=function(M){var L=function(){if(H){C.set("title",H);}else{C.set("title",null);}C.set("canDeactivate",-1);C.once("widgetChange",function(N){C.set("canDeactivate",1);B.fire("bindContentWidget",{cw:N.newVal,tab:C});});D.after("closeChange",function(){C.set("widget",G);});C.removeChild(D);};if(M==="next"||M==="prev"){B.use("mail-ui-messagelist-base","mail-ui-messagepane-next-prev",function(){J&&J.stepMail(M,L,0,0,1);});}else{L();}};}C.set("title",D.get("title"));C.once("widgetChange",function(L){L.prevVal.after("closeChange",function(M){if(M.newVal){C.removeChild(L.prevVal);}});L.newVal.after("closeChange",function(M){if(M.newVal){C.set("close",1);}});B.fire("bindContentWidget",{cw:L.newVal,tab:C});});C.set("hideToolbar",true);C.set("widget",D);};A.prototype.composify_tab=function(F){var D=this,C=D.stopwatch;var E=D.workspace.addContentWidget({s_label:F.get("title"),widget:F,forcePane:false,noToolbar:true,sync:true,isRemovable:true,noScroll:D.context.noScroll});if(!E){return false;}else{E.detach("closeHalted");E.on("closeHalted",function(G){G.halt(true);});}F.subview.once("renderComplete",function(){C.stop();});return true;};A.prototype.show_compose_end=function(D){var C=this;B.fire("Y.mail.ui.Workspace:composeMessage:complete");if(C.context.callFromLaunch){!NeoConfig.noDarla&&B.common.Utils.loadDarlaAndExecute(function(E){E.fire("darlaEvent",{action:(NeoConfig.low_bandwidth)?"launch_compose_low":(NeoConfig.isSSL?"launch_compose_ssl":"launch_compose")});},false);}D.on("closeChange",function(){B.fire("Nav:ComposeClosed");});};A.prototype.create_conv_compose_view=function(E,D,C,G,F){return new B.mail.ui.ConvComposeView(E,D,C,G,F);};B.namespace("mail.ui.Compose").ComposeLoader=A;},"1.0.0",{requires:["common-utils","common-utils-stats","mail-services-message-service","mail-ui-authorview-conv"]});