YUI.add("common-ui-lozengeDD",function(B){B.namespace("common.ui");var H=B.common.Utils;var F=function(J){var K=this;K.inputUl=null;K.insertBefore=null;K.dummyElement=null;K.targetNode=null;K.selectMultipleLozenges=false;K.composeView=J.composeView,K.composeHeader=J.composeView.baseNode.one(".compose-header");K.firstMove=true;K.allInputBoxes=K.composeHeader.all("div div.ac-input");K.clonedLozenge=null;K.wasHighlighted=false;K.dd=new B.mail.DD({start:K.start,end:K.end,move:K.move,scope:K,node:K.composeHeader,dragSelector:J.dragSelector});H.setSelect(this.composeHeader,false);};var A=function(K){this.init(K);var J=this.getTargetNode(K);if(J){K.dd.proxy.setXY([-100,-100]);this.dummyElement.setStyle("opacity",0);}};var D=function(N){var O=this,M=O.getTargetNode(N),K=N.dd.proxy,J;var L=function(R,P){var Q=O.insertBefore;if(K.inRegion(P)){O.inputUl=P.one("ul");O.allInputBoxes.removeClass("focus");P.addClass("focus");Q=null;J=O.inputUl.all("li");J.each(function(S){if(O.clonedLozenge.inRegion(S)){if(!Q){Q=S;}}});if(!Q){Q=J.item(J.size()-1);}Q.insert(O.dummyElement,Q);}else{if(P.hasClass("focus")){P.removeClass("focus");O.inputUl=null;}}O.insertBefore=Q;};if(K){if(O.firstMove){O.firstMove=false;M.setStyle("display","none");O.composeHeader.all(".hLozenge").each(function(P){P.removeClass("focus");});}K.setStyle("top",N.pageY);K.setStyle("left",N.pageX);K.setXY([N.pageX,N.pageY]);if(K.inRegion(O.composeHeader)){O.allInputBoxes.each(function(P){L(N,P);});}}};var E=function(L){var M=this,K=this.getTargetNode(L),J=M.insertBefore;if(K){L.dd.proxy.remove().destroy(true);if(M.inputUl&&J){K.remove();M.inputUl.get("parentNode").removeClass("focus");if(!this.selectMultipleLozenges){J.insert(K,J);}else{K.each(function(N){J.insert(N,J);N.removeClass("focus");});}M.composeView.dirty=true;}else{if(this.wasHighlighted){K.addClass("focus");}}M.dummyElement.remove().destroy(true);M.dummyElement=null;K.setStyle("display","inline-block");K.removeAttribute("style");L.dd.proxy=null;M.targetNode=null;M.selectedLozenges=false;M.firstMove=true;M.insertBefore=null;L.notDragging=false;M.wasHighlighted=false;M.selectMultipleLozenges=false;}};var C=function(){return this.targetNode||null;};var I=function(L){var P=this,K,J=0,O;var N=function(){M(L);if(P.targetNode){var Q=P.targetNode.cloneNode(true);Q.replaceClass("hLozenge","dd-hLozengeBox");Q.one("input").remove();L.dd.proxy=B.Node.create('<div style="position:absolute"></div>');L.dd.proxy.appendChild(Q);P.clonedLozenge=Q;P.dummyElement=P.targetNode.cloneNode(true);}};var M=function(R){var S,Q=R.target;S=(B.Node.getDOMNode(Q)).nodeName;if(S==="LI"&&Q.hasClass("hLozenge")){P.targetNode=Q;}else{P.targetNode=Q.ancestor("li.hLozenge");}return P.targetNode;};K=L.target.ancestor("ul");if(!K){P.targetNode=null;}else{if(L.target.hasClass("lozenge-edit")){P.targetNode=null;L.notDragging=true;}else{if(K.one("li.focus")){O=M(L);P.targetNode=K.all("li.focus");J=P.targetNode.size();if(J===1||!O.hasClass("focus")){if(O.hasClass("focus")){P.wasHighlighted=true;}N();}else{P.wasHighlighted=true;L.dd.proxy=B.Node.create('<div style="z-index: 999" class="contactDragProxy"><span></span><b class="counter">'+J+"</b></div>");P.clonedLozenge=L.dd.proxy;if(!P.dummyElement){P.dummyElement=P.targetNode.item(0).cloneNode(true);}P.selectMultipleLozenges=true;}}else{N();}}}if(L.dd.proxy){B.one("body").append(L.dd.proxy);}};var G=function(){this.dd.destroy();};F.prototype={destroy:G,start:A,end:E,move:D,getTargetNode:C,init:I};B.common.ui.lozengeDD=F;},"1.0.0",{requires:["common-ui-dd","common-utils"]});