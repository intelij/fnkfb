YUI.add("tictac-flickr-uploader-form",function(e){var t=e.Tictac.flickr,a=e.Tictac.base.utils,i=a.log,r=t.Webservice,n="https://secure.flickr.com",o="flickr-form-upload-id",c=['<form method="post" enctype="multipart/form-data" ','class="flickr-attachment-form"></form>'].join(""),l=['<input type="file" id="flickr-attachment-input" ','name="photo" accept="image/*" style="position:absolute; right:30px; ',"filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0); ",'top:22px; height:16px; width: 45px; opacity:0; -moz-opacity:0; cursor: pointer;">'].join(""),p=['<iframe id="',o,'" name="',o,'" ','style="display:none;"></iframe>'].join("");function s(){var e=this;e.type="FORM";e.evtHandles=[]}s.NAME="tictac-flickr-uploader-form";e.mix(s.prototype,{cleanup:function(){var t=this;e.Array.each(t.evtHandles,function(e){e.detach()})},cleanupUpload:function(){var t=this,a=this.parent.one("#"+o);if(a){a.remove(true)}this.form.all("input[type=hidden]").remove(true);t.form.remove(true);t.fileInput=e.Node.create(l);t.form=e.Node.create(c);t.form.append(this.fileInput);t.parent.append(this.form);t.evtHandles=t.evtHandles.concat([t.fileInput.on("change",t.onFileSelected,t)])},cancel:function(){this.cleanupUpload();this.cleanup()},onFlickrMessage:function(e){var t=e._event,r;if(t.origin!==n){return}i(t.data);r=a.parseJSON(t.data);if(r.stat==="ok"){this.fire("alluploadscomplete")}else{this.fire("uploaderror")}this.cleanupUpload()},onFileSelected:function(t){var a=this,n=t.currentTarget,c=e.Node.create(p),l={name:n.get("value")};if(!l.name){return}a.parent.append(c);r.signUploadURL({success:function(a){var i=a.split("?")[0],r=e.QueryString.parse(a.split("?")[1]),n=t.currentTarget.ancestor("form");n.set("target",o);n.set("action",i);e.each(r,function(e,t){n.append('<input type="hidden" name="'+t+'" value="'+e+'" />')});n._node.submit()},failure:function(){i("failure")}},"postmessage");a.fire("fileselect",t)},render:function(t){var a=this;a.parent=t;a.fileInput=e.Node.create(l);a.form=e.Node.create(c);a.form.append(this.fileInput);t.append(this.form);a.evtHandles=a.evtHandles.concat([e.one(window).on("message",a.onFlickrMessage,a),a.fileInput.on("change",a.onFileSelected,a)])}});e.namespace("Tictac.flickr").UploaderForm=s;e.augment(s,e.EventTarget)},"1.0.0",{requires:["tictac-base-utils","tictac-flickr-stats","tictac-flickr-strings","tictac-flickr-rollups","tictac-flickr-ws","common-ui-dialog-helper"]});