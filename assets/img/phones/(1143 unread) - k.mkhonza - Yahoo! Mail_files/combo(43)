YUI.add("tictac-dropbox-footer",function(e){var t=e.Tictac.dropbox.strings,o=e.Tictac.att.filter,r=e.Tictac.dropbox.Stats.stat,n=/[\w\W]+\.([^\.]+$)/;function a(e,t,o){var r=this;r.rte=e,r.model=t;r.username=o;r.needRefresh=false;r.evtHandles=[r.model.on("added",r.onModelUpdated,r),r.model.on("deleted",r.onModelUpdated,r),r.model.on("updated",r.onModelUpdated,r),r.model.on("commit",r.onCommit,r),r.rte.on("beforeModeSwitch",r.beforeModeSwitch,r),r.rte.on("afterModeSwitch",r.afterModeSwitch,r),r.rte.on("nodeChange",r.nodeChange,r)]}function i(e){return e.isDropbox()&&e.isUploadValid()}function d(e){return e.rte.getDocRoot()}e.mix(a.prototype,{cleanup:function(){var t=this;e.each(t.evtHandles,function(e){if(e.detach){e.detach()}});delete t.evtHandles},onModelUpdated:function(e){var t=this;t.needRefresh=t.needRefresh||i(e)},onCommit:function(){var e=this;if(e.needRefresh){e.removeFooter();e.appendFooter()}e.needRefresh=false},removeFooter:function(){var e=this,t;t=d(e).all('div[class$="tictac-att-dropbox-container"]').pop();if(t){t.remove(true)}return},getIconBgColor:function(e){var t=function(e){return"background-color:rgb("+e+");"},o={doc:t("20, 118, 208"),pdf:t("193, 60, 19"),ppt:t("229, 112, 23"),xls:t("31, 131, 13")};return o[e]?o[e]:t("111, 111, 111")},appendFooter:function(){var r=this,a=d(r),c=e.Tictac.dropbox.rollups,l=t.str_dropbox_msg_footer,s=r.model.getAll(true),f,p;s=e.Array.filter(s,i);if(!s.length){return}if(s.length>1){l=t.str_dropbox_msg_footer_plural}l=l.replace("{{username}}",r.username);if(r.rte.get("isRich")){e.each(s,function(e){e.filetype=o.map(e.mimetype,n.test(e.rawFilename)?e.rawFilename.replace(n,"$1"):null);e.iconcolor=r.getIconBgColor(e.filetype)});f=e.Node.create(c.richfooter({preamble:l,attachments:s}))}else{f=e.Node.create(c.plainfooter({preamble:l,attachments:s}))}a.append(f);p=f.all("div.db-attachment");p.on("mouseenter",function(e){e.currentTarget.one(".db-attachment-delete").setStyle("visibility","visible")});p.on("mouseleave",function(e){e.currentTarget.one(".db-attachment-delete").setStyle("visibility","hidden")})},beforeModeSwitch:function(){var e=this;e.removeFooter()},afterModeSwitch:function(){var e=this;e.appendFooter()},nodeChange:function(t){var o,n;if(t.changedType==="mousedown"){if(e.Array.indexOf(t.classNames,"db-attachment-delete")!==-1){if(this.rte.get("isRich")){n=t.changedNode.get("parentNode");o=n.getAttribute("id").split("-")[2]}else{o=t.changedNode.getAttribute("id").split("-")[2]}this.model.del(o);r("dropbox_rte_footer_delete")}}}});e.namespace("Tictac.dropbox").footer=a},"1.0.0",{requires:["tictac-base-utils","tictac-dropbox-strings","tictac-dropbox-stats","tictac-att-filter","array-extras"]});