YUI.add("mail-controller-sendconfirm",function(E){var g=E.mail,D=g.Controller,b=D.extend("SendConfirm"),F=E.common.Utils,K=D.Messages,a=E.contacts,V=F.ymmastats,G=a.config,I=a.api,W=a.utils,S=g.model.DataStore,e=F.log,f=S.Messages,Q="forward",P=E.common.persist.UserData,M=F.rocketstats,C=null,Z,B=45000,T=90000,R=T+15000;function A(m,q,l,o){var x,p=m.get("origin"),u,r=m.get("cid"),h=(P.get("userSendPref.autosaveOnSend")==="yes")?true:false,s=(r&&NeoConfig.hasConvPerf&&h?true:false),w=[],i=(m.get("disableaddcontact")||(P.get("userSendPref.addUnknownContact")==="prompt"))?false:true,Y=m.get("api"),v=function(){},y={success:v,failure:v},k=g.model.ConvStore,n=k?k.Conversations.getPermCidPart:null,j=function(AA){try{if(AA){E.mail.Controller.Messages.remove({fid:"Draft",mid:AA,force:true},y);}}catch(z){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:1",z,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:1");M.stat("SEND","PostSend:FailedToDeleteDraft");}};x={success:function(AC,AI){var AA=AI.args.batchSend?AC.send:AC;c();u=m.get("draftMID");var AE=N(AI.args.sdo);AE.contactsAdded=0;if(!NeoConfig.isAMT&&i&&AE.unknown.length>0){var AB={guid:NeoConfig.neoguid,requestFn:E.common.net.SessionMgr.requestProxy,wspath:NeoConfig.socdirProxyPath,success:v,failure:v};G.setAttrs(AB);AE.contactsAdded=AE.unknown.length;e({"m":"Autosaving contact info..."});E.Array.each(AE.unknown,function(AM){if(AM.name!==undefined){w.push({fields:[{type:"name",value:{"givenName":AM.name}},{type:"email",value:AM.email}]});}else{w.push({fields:[{type:"email",value:AM.email}]});}});AE.known=AE.known.concat(AE.unknown);AE.unknown=[];I.saveContacts(w);}m.set("sendaction",{action:"success",args:{addy:AE,mid:AA.mid}});try{if(p.fid&&p.oMsg&&p.action&&(p.action!=="edit")){var AG={fid:p.fid,mid:[p.oMsg],setFlags:p.action===Q?{"forwarded":1}:{"replied":1}};K.flag(AG,{suppressCodes:["*"]});}}catch(AH){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:2",AH,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:2");M.stat("SEND","PostSend:FailedToSetFlag");}if(!strings.str_cfg_tog_sendconfirm_keep_draft){j(u);}try{if(r&&((!AI.args.batchSend)||(AI.args.batchSend&&(n(AC.map.midscids[0].cid)===n(r))))){var AK=m.get("cascade").message,AD=AC.get,z={sdo:m},AL={mid:AA.mid,cid:r,fid:"Sent",snippet:AD?AD.snippet:J(m),sourceFolderInfo:{fid:"Sent"},receivedDate:AD?AD.header.sentDate:Math.floor((new Date().getTime())/1000),flags:AD?AD.flags:{"isRead":1},from:AK.from,toEmail:AD?AD.header.to:AK.to,subject:AD?AD.header.subject:AK.subject};e({"m":"Add message to conversation"});g.model.ConvStore.Conversations.msgAdd(r,null,AL,z,true);}else{f.set("Sent",AA.mid,"add");}}catch(AH){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:3",AH,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:3");M.stat("SEND","PostSend:FailedToSetSent");}if(Y===true){if(!NeoConfig.tmpForceAdSendTest){var AJ=S.Folders.get(p.fid),AF=g.ui.common.StringUtils.getSystemFolderName(p.fid,AJ.folderInfo.name);E.use("mail-ui-messagepane-utils",function(AM){AM.fire("darlaEvent",{action:"sent_api",value:{siteAttr:g.ui.MessagePaneUtils.getAdSiteAttribsFromMesgObj(p.oMsg,p.fid),foldername:AF}});});}}else{E.fire("SentSuccess",p,AA);}q&&q.stop();M.stat("SEND","Success");E.fire("stat:feature_latency",{"message":"UI_SEND_COMPLETE","feature_group":"SEND","value":q.d});E.fire("stat:feature_complete",{"message":"UI_SEND_COMPLETE_SUCCESS","feature_group":"SEND"});if(l==="autocompose"){M.stat("autocompose","send_success");V.stat("autocompose_send_success");}},failure:function(AC,AG){var z,AB,AD,AF,AE,AA;if(AG.args.batchSend&&AC.sendResult){AG.args.batchSend=false;x.success(AC.send,AG);e({"m":"Failure: send success but batch call failed"});return;}z=AG.args.batchSend?AC.send.fault.detail[0]:AC;AB=AG.args.sdo;AD=z.code;AF=z.fault;AE=AF&&AF.message;AA=(NeoConfig.mailEnv==="prod")?NeoConfig.hostName.split(".")[3]:"";if(AG.args.batchSend){AF.detail=z.detail;}AB.set("requestId",0);c();switch(AD){case"Client.HumanVerificationRequired":case"Client.WrongInput":case"Client.InputTooEarly":case"Client.CannotSendThisMessage":case"Client.AccountVerificationRequired":AB.set("sendaction",{action:"captcha",args:{fault:AF}});M.intlStat("SEND","Failure:Captcha");E.fire("stat:feature_complete",{"message":"UI_SEND_CAPTCHA_RECIEVED","feature_group":"SEND"});break;case"Client.TimedOut":AB.set("sendaction",{action:"captcha",args:{fault:AF}});M.intlStat("SEND","Failure:Captcha");break;case"Client.UserAbuseDetected":AB.set("sendaction",{action:"abuse",args:null});u=AB.get("draftMID");j(u);M.intlStat("SEND","Failure:Error:"+AD);break;case"Server.SendMessageFailed":if(o&&o.isSaveTimedOut){V&&V.stat("ue_client_error_13","api=>SendMessage"+",code=>"+AD+",tae_type=>SaveOver30SecondsAndSendFailed");}if(o&&o.isMailboxBusy){V&&V.stat("ue_client_error_13","api=>SendMessage"+",code=>"+AD+",tae_type=>MailboxBusy");}V.stat("ue_client_error","api=>SendMessage"+",tae=>13"+",code=>"+AD+",farm=>"+NeoConfig.farm.substr(1)+",colo=>"+AA);if(AE){E.use("common-utils-error",function(){F.error.report("Send Failure: "+AE);});}AB.set("sendaction",{action:"error",args:{fault:AF}});M.intlStat("SEND","Failure:Error:"+AD);break;default:AB.set("sendaction",{action:"error",args:{fault:AF}});M.intlStat("SEND","Failure:Error:"+AD);break;}},args:{sdo:m,batchSend:s},timeout:T,suppressCodes:"*",urlParams:{debugmid:m.get("draftMID")||"",debugts:new Date().getTime()}};if(q){q.bodySize=0;if(m.get("contenthtml")){q.bodySize+=m.get("contenthtml").length;}if(m.get("contenttext")){q.bodySize+=m.get("contenttext").length;}q.attachCount=m.get("attachments").length;q.start(1,"msgSend");}M.stat("SEND","Attempt");if(l==="autocompose"){M.stat("autocompose","send_attempt");
V.stat("autocompose_send_attempt");}if(parseInt(m.get("requestId"),10)!==0){M.stat("SEND","DuplicateSend");}else{m.set("requestId",Math.random());}var t=m.get("cascade");e({"m":"Make back end call for sending message to cascade..."});U(s,t,x);if(NeoConfig.hasConvView&&!t.message.inreplyto&&p.oMsg){M.stat("conv","inReplyToMissing");}O(m);E.fire("Y.mail.sendMessage",m);E.fire("stat:feature_invoke",{"message":"UI_SEND_START_SUCCESS","feature_group":"SEND"});}function L(h,Y){if(!E.Lang.isUndefined(h.sendResult)&&!E.Lang.isUndefined(h.mapResult)&&!E.Lang.isUndefined(h.getResult)){if(h.sendResult&&h.mapResult&&h.getResult){Y.success(h,Y);}else{Y.failure(h,Y);}}}function U(j,i,o){var Y=((i&&i.messageReference)?i.messageReference.mid:"no-mid");if(j){var k=D.batch(),m,h,l={},n={suppressCodes:["*"],urlParams:o.urlParams||""};Y="[batch]"+Y;i.chain={id:"sendmessage"};k.Messages.send(i,function(r,p,q){l.send=r;l.sendResult=(q==="success");L(l,o);});m={fid:"Sent",mids:["_chainedMid"],chain:{id:"getcids",parameter:[{source:"sendmessage.mid",destination:"getcids.mids[0]"}],dependency:["sendmessage"]}};k.Conversations.map(m,function(r,p,q){l.map=r;l.mapResult=(q==="success");L(l,o);});h={chain:{id:"getmessage"},fid:"Sent",ovparams:{},cachekey:"Prime"};h.chain.parameter=[{source:"sendmessage.mid",destination:"getmessage.message[0].mid"}];h.chain.dependency=["sendmessage"];k.Messages.get(h,function(r,p,q){l.get=r;l.getResult=(q==="success");L(l,o);});e("#SS: executeSend: "+Y);k.execute(n);}else{Y="[single]"+Y;e("#SS: executeSend: "+Y);E.mail.Controller.Messages.send(i,o);}}function O(Y){if(C){C.cancel();}C=E.later(R,this,function(h){h.set("sendaction",{action:"error",args:{fault:{code:strings.str_modal_generic_err}}});M.stat("SEND","Send: NetTimeout");},[Y],false);}function c(){if(C){C.cancel();C=null;}}function J(h){var Y=40,i=E.Lang.trim(h.get("contenttext"));i=i.substring(0,Y);return i.replace(/\n/g," ");}function X(i,h){var Y,k;if(i<1){Y=1;}else{if(i<2){Y=2;}else{if(i<3){Y=3;}else{if(i<5){Y=5;}else{if(i<8){Y=8;}else{if(i<10){Y=10;}else{if(i<15){Y=15;}else{if(i<20){Y=20;}else{Y="long";try{k=["*** SaveSuccessLongTime","Client Time: "+i+" seconds","User: "+NeoConfig.emailAddress,"Response: "+E.JSON.stringify(h)].join(" - ");if(!Z){E.use("comms-log4js",function(l){Z=l.comms.log4js.getLogger("saveLogger",1,"ajax");Z.log(k);});}else{Z.log(k);}}catch(j){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:4",j,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:4");}}}}}}}}}M.stat("SaveMessage","time:"+Y);}function H(i,h){var p=i.auto,k=i.silent,Y=(new Date()).getTime(),o={chain:{id:"savemessage"},destination:{fid:"Draft"},message:i.sdo.get("cascade").message},n={success:function(w){var t=o.message,AA=((new Date()).getTime()-Y)/1000,x=i.cid,z=i.sdo.get("origin"),u,s,r={sdo:i.sdo},q={mid:w.mid,flags:{},header:{from:t.from,to:t.to,cc:t.cc,bcc:t.bcc,subject:t.subject,replyto:t.replyto}};X(AA,w);if(!w.mid){M.stat("SaveMessage","EmptyMID");n.failure(w);return;}try{if(x){q.cid=x;q.fid="Draft";q.flags={"isRead":1};q.snippet=J(i.sdo);q.sourceFolderInfo={fid:"Draft"};q.header.receivedDate=Math.floor((new Date().getTime())/1000);if(z){s=z&&z.parentMsg;if(s){u=s.mimeMsgId;}else{u=z&&z.oMsg&&z.oMsg.mimeMsgId;}if(u){q.inReplyTo=u;}}g.model.ConvStore.Conversations.msgAdd(x,null,q,r);}else{f.set("Draft",q,"add");}if(i.mid){f.remove("Draft",i.mid,true,null,{reason:"savedraft"});}}catch(v){typeof globals!=="undefined"&&globals.report?globals.report("caughterror:..-build-mail-controller-sendconfirm:5",v,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-controller-sendconfirm:5");M.stat("SaveMessage","SaveSuccessException");E.use("common-utils-error",function(){F.error.report("SaveSuccessException",v,1,1,1);});}if(h){var y=false;h(w.mid,0,y);}},failure:function(r){var q=false,s=false;if(NeoConfig.hasConvView){if(r.fault&&r.fault.detail&&r.fault.detail.length>0){E.Array.each(r.fault.detail,function(t){if(E.Object.getValue(t,["fault","id"])==="savemessage"){q=true;}if(t.code==="Server.MailboxOpenFailed.Busy"){s=true;}});}}else{q=true;}if(h){h(r.mid,q?-1:-2,s);}e("#SS: _SaveMessage:fail: "+r.mid);},args:{sdo:i.sdo,auto:p},timeout:!p&&B,suppressCodes:k?["*"]:["Client.MessageNotFound"],suppressLogs:k?["*"]:[]},j,m,l;if(i.mid){o.destination.mid=i.mid;}if(i.appid){n.appid=i.appid;}h&&h(null,1);j=D.batch();j.Messages.save(o,n);if(NeoConfig.hasConvView){l={chain:{id:"flagmessages",parameter:[{source:"savemessage.mid",destination:"flagmessages.mid[0]"}],dependency:["savemessage"]},mid:"_chainedmid",fid:"Draft",setFlags:{read:1}};j.Messages.flag(l,function(s,q,r){if(r==="failure"){}});}m={urlParams:{action:i.action||"",actionCount:i.actionCount||"",debugmid:i.mid||"",debugts:new Date().getTime()}};if(k){m.suppressCodes=["*"];m.suppressLogs=(i.isRetryable&&!i.retry)?["*"]:[];}j.execute(m);}function d(){return function(l){var s=[],Y=[],n,q,j=[],o=l.get("recipients"),k=[o.to,o.cc,o.bcc],m,p,r,h=function(i){j.push(i);};for(n=0,q=k.length;n<q;++n){m=E.Array.each(k[n],h);}for(n=0,q=j.length;n<q;++n){p=(W.getContactsByEmail(j[n].email)||[])[0];if(p&&p.id>=0){if(!j[n].name){r=W.getFirstFieldValue(p,"name")||{};j[n].givenName=r.givenName;j[n].familyName=r.familyName;}j[n].cid=p.id;s.push(j[n]);}else{if(P.isUsersEmailAddress(j[n].email)){s.push(j[n]);}else{Y.push(j[n]);}}}return{known:s,unknown:Y};};}var N=d();E.mix(b,{sendMessage:A,saveMessage:H},true);},"3.0.0",{requires:["mail-controller-base","mail-model-send","mail-model-datastore","contacts-api-utils","contacts-api","mail-controller-messages-ops","rocket-stats","common-utils-stats"]});YUI.add("minty_module_toolbar_inbox_sent_msg_rollup",function(A){A.namespace("ui.Templates");A.ui.Templates.minty_module_toolbar_inbox_sent_msg_rollup={base:'<div id="pagetoolbar" class="{{msgliststate}}"> {{is_reply}} {{sending_error}}</div>',is_reply:'<span class="btn left right hidden"><a href="#" data-action="back-to-message" title="{{str_toolbar_back_to_message}}">{{str_toolbar_back_to_message}}</a></span> <span class="btn left hidden"><a class="icon prev" href="#" data-action="prev" title="{{str_next_attr}}"><i>{{str_next}}</i></a></span><span class="btn right hidden"><a class="icon next" href="#" data-action="next" title="{{str_previous_attr}}"><i>{{str_previous}}</i></a></span> ',backtomsg:'<span class="btn left right btn-back"><a href="#" data-action="backtomsg" title="{{str_comp_back_to_msg_attr}}">{{str_comp_back_to_msg}}</a></span>',tryagain:'<span class="btn left right btn-retry"><a href="#" data-action="retry" title="{{str_comp_try_again_attr}}">{{str_comp_try_again}}</a></span>',abuse:'<span class="btn left right"><a href="#" data-action="navigate">{{str_comp_done}}</a></span>',sending_error:"{{backtomsg}}{{tryagain}}{{abuse}} "};},"1.0.0");YUI.add("_shared_module_send_confirm_rollup",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_send_confirm_rollup={base:'<div class="content send-confirm"> <div class="col-a" aria-live="polite" role="document"> <div class="box box-iso"> <h3 class="loading">{{str_comp_sending}}</h3></div> <div class="box box-iso hidden"> {{sending_error_else}} </div> <div class="box box-iso hidden"> {{sending_error}} </div> </div> <div class="col-b"> {{is_mon}} {{is_lrec}} </div> </div>',msg_replied_to:'<h3 class="from">{{from}}</h3> <p class="subj">{{subject}}</p> <p class="snippet">{{snippet}}</p> ',is_reply:'<div class="items replied-to"> <h2 class="legend"><span class="label"><b>{{str_comp_original_msg}}</b></span></h2> {{msg_replied_to}} <div> <span class="btn left right small menu" data-action="menu"> <a title="{{str_move}}" href="#">{{str_move}}<b></b></a> </span> <span class="btn left right small"> <a title="{{str_delete}}" href="#">{{str_delete}}<b></b></a> </span> </div></div> ',message_sent_success:'<h3 class="success"><i></i><span class="msg">{{str_comp_email_sent}}</span></h3><div class="offset"> <span class="btn default left right"><a href="{{url_minty_inbox}}" data-action="navigate" role="button">{{str_comp_done}}</a></span></div>',new_recipients:"underline",contacts_not_in_ab:'<li> <span class="btn lozenge btn-contact small left" data-name="{{name}}" data-address="{{email_id}}" data-action="contact-menu"> <a role = "button" title="{{str_btn_recipient_lozenge_attr}}" href="#">{{msg_display_name}}</a> </span><span class="btn lozenge lozengeadd right small btn-kiosk-addcontact" data-name="{{name}}" data-address="{{email_id}}" data-action="modal"> <a role = "button" title="{{str_btn_add_recipient_attr}}" href="#">&nbsp;</a> </span> </li> ',contacts_in_ab:'<li> <span class="btn lozenge btn-contact left small right" data-name="{{name}}" data-address="{{email_id}}" data-action="contact-menu"> <a role = "button" title="{{str_btn_recipient_lozenge_attr}}" href="#">{{msg_display_name}}</a> </span> </li> ',global_auto_add_contacts:'checked=""',new_recipients1:'<div class="field"> <div class="checkbox"> <label><input type="checkbox" {{global_auto_add_contacts}} class="checkbox"> {{str_comp_auto_add_to_contacts}} </label> </div> </div>',sending_error_else:'{{message_sent_success}} <div class="items {{new_recipients}}"> <h2 class="legend"><span class="label"><b>{{str_comp_recipients}}</b></span></h2> <ul class="inline-items"> <span class = "lozengeContainer"> {{contacts_not_in_ab}} {{contacts_in_ab}} </span> </ul></div>{{new_recipients1}} {{is_reply}} ',sending_error:'<h3 class="error"> <span class = "error-logo"></span> {{sending_error_msg}}</h3><div>{{sending_error_detail}}</div> ',is_mon:'<div id="slot_MON_sent" class="ch_mod gxBoom boom"><div id="tgtMON_sent" ></div></div> ',is_lrec:'<div id="slot_LREC_sent"><div id="tgtLREC_sent" class="darla" tabindex="-1" hidefocus="true"></div></div> '};},"1.0.0");YUI.add("_shared_module_send_confirm_captcha_blocked",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_send_confirm_captcha_blocked={base:"{{message_blocked}}{{account_blocked}}",message_blocked:'<div class="error"> <span class="error-logo"></span> <strong>{{str_comp_captcha_msg}}</strong> <p>{{str_comp_captcha_msg_suspicious_activity}}</p> <p>{{str_comp_captcha_apology}}</p></div>',account_blocked:'<div class="error"> <span class="error-logo"></span> <strong>{{str_comp_captcha_account}}</strong> <p>{{str_comp_captcha_account_suspicious_activity}}</p> <p>{{str_comp_captcha_apology}}</p></div>'};},"1.0.0");YUI.add("comms-lozenge",function(C){var B=C.comms.Utils.escapeHtml;function A(){A.superclass.constructor.apply(this,arguments);}A.NAME="lozenge";A.ATTRS={data:{value:{value:""},setter:"_setData"},segmentCount:{value:1},segmentTypes:{value:[]},segmentHovers:{value:[]},labelSegment:{value:0},label:{valueFn:"_defEscapeDataValueFn"},validate:{value:false},error:{value:false},selectable:{value:true},selected:{value:false}};A.LOZENGE_TEMPLATE='<span class="lozengeSegment {segclass}"><a tabindex="0" role="button">{label}</a></span>';C.extend(A,C.Widget,{initializer:function(E){var D=E.data||{};if(this.get("validate")){this.set("error",this._isError(D));}},destructor:function(){this._lozengeNode=null;},renderUI:function(){var H,D,I,F,G,K,L,E=[],J;D=this.get("segmentCount");I=this.get("segmentTypes");K=this.get("labelSegment");J=this.get("contentBox");L=this.get("label");for(H=0;H<D;H++){F=C.substitute(A.LOZENGE_TEMPLATE,{label:(K===H)?L:"",segclass:I[H]});G=C.Node.create(F);E.push(G);if(H===K){this._lozengeNode=G;}J.appendChild(G);}E[0].addClass("left");E[D-1].addClass("right");},bindUI:function(){this.after("dataChange",this._afterDataChange);this.before("selectedChange",this._beforeSelectedChange);this.after("selectedChange",this._afterSelectedChange);this.after("errorChange",this._afterErrorChange);this.get("contentBox").delegate("click",this._onClick,".lozengeSegment",this);},syncUI:function(){this._updateUI();var D=this.get("boundingBox");D.lozengeObj=this;},removeSegment:function(E){var J,D,H,I,G,F;J=this.get("segmentCount");if(E<0||E>(J-1)){return;}D=this.get("segmentTypes");H=this.get("labelSegment");I=this.get("contentBox");G=I.all(".lozengeSegment");F=G.item(E);J--;if(J){if(E===0){G.item(1).addClass("left");}else{if(E===J){G.item(J-1).addClass("right");}}}F.remove(true);D.splice(E,1);this.set("segmentCount",J);if(E==H){H=null;}},_defDataValueFn:function(){var D=this;return function(){return D.get("data").value||"";};},_defEscapeDataValueFn:function(){var D=this;return B(D.get("data").value||"");},_isError:function(D){D=D||this.get("data");return !!(D.value);},_setData:function(D){D=D||"";if(typeof(D)!=="object"){return{value:D.toString()};}return D;},_afterDataChange:function(E){var D=B((E.newVal.value)?E.newVal.value:E.newVal);this.set("label",D);this.get("segmentHovers")[this.get("labelSegment")]=D;this._updateUI();},_afterSelectedChange:function(E){var D=this.get("boundingBox");if(E.newVal){D.addClass("lozengeSelected");}else{D.removeClass("lozengeSelected");}},_beforeSelectedChange:function(D){if(!this.get("selectable")){D.preventDefault();}},_afterErrorChange:function(E){var D=this.get("boundingBox");if(E.newVal){D.addClass("lozengeError");}else{D.removeClass("lozengeError");}},_onClick:function(F){var D=this.get("contentBox");var H=this.get("segmentTypes");var G=D.all(".lozengeSegment");var E=G.indexOf(F.currentTarget);this.fire(this.name+":segmentClick",E,H[E]);},_updateUI:function(){var E,H,J,G=this.get("boundingBox"),I=this.get("contentBox").all(".lozengeSegment"),K=this.get("segmentCount"),D=this.get("segmentHovers"),F=this.get("labelSegment");for(E=0;E<K;E++){H=I.item(E);J=H.one("a");H.setAttribute("title",D[E]);if(E==F){J.setContent(this.get("label"));}else{J.setContent("&nbsp;<b></b>");}}if(this.get("error")){G.addClass("lozengeError");}else{G.removeClass("lozengeError");}if(this.get("selected")){G.addClass("lozengeSelected");}else{G.removeClass("lozengeSelected");}}});A.prototype.BOUNDING_TEMPLATE="<li></li>";A.prototype.CONTENT_TEMPLATE="<span></span>";C.namespace("comms");C.comms.Lozenge=A;C.comms.LozengeUtils={updateABSegments:function(S,D){var J,I,N,G=[],K=[],M=[],R,L,F,O,Q,P,H,E=[];for(N in D){Q="";L=D[N].fields;for(J=0,I=L.length;J<I;J++){R=L[J];if(R.type==="email"){O=R.value;}else{if(R.type==="name"){F=R.value;Q=C.common.Utils.substitute(strings.str_name_format,{given_name:F.givenName,family_name:F.familyName});}}}G.concat(D[N].id||null);K=K.concat(O);M=M.concat(Q||O);}H=S.all(".plus");H.each(function(X){var U=X.ancestor(".yui3-lozenge"),W=U.lozengeObj,T=W.get("data.email"),V="";for(P=0;P<K.length;P++){V=K[P];if(V===T){E.push(U);W.removeSegment(1);W.set("data",{name:M[P]||V,email:V,cid:G[P]});}}});return E;}};},"0.0.1",{requires:["node","widget","substitute","comms-utils"]});YUI.add("comms-lozenge-address",function(D){var C=D.Lang;var A=D.comms.Utils.escapeHtml;function B(){}B.ATTRS={data:{value:{name:"",email:"",isNN:""},setter:"_setData"},segmentCount:{value:2},segmentTypes:{value:["name","plus"]},labelSegment:{value:0},label:{valueFn:function(){var E=this.get("data");return A(E.name||E.email||"");}},segmentHovers:{valueFn:function(){var E=this.get("data");if(E.name==E.email){return["",""];}else{return[E.email,""];}}},validate:{value:true}};B.prototype={_isError:function(E){var F=(E&&E.data&&E.data.email)||this.get("data.email");if(F){return !(this._isValidEmail(F));}return false;},_setData:function(F,G){var E,H;if(typeof(F)!=="object"){E=F.toString();F={name:"",email:E};}else{if(!F.email){return D.Attribute.INVALID_VALUE;}}return F;},_isValidEmail:function(F){var K=this,J,I,E,G,H=/^([^@ ;:()\[\],<>\\]+@[^@ ;:()\[\],<>\\]+\.[^@ ;:()\[\],<>\\]+)/;F=F||K.get("data").email;if(!H.test(F)){return false;}G=F.split("@");J=G[0];I=G[1];if(!I||!J){return false;}G=I.split(".");E=G[1];if(!E){return false;}return F;},_afterDataChange:function(I){var H,G,J,F=I.newVal.name,E=I.newVal.email;if(!F||(F===E)){F=A(E);G="";}else{F=A(F);G=E;}this.set("label",F);J=this.get("labelSegment");this.set("segmentHovers."+J,G);if(this.get("validate")){H=this._isValidEmail(E);this.set("error",!H);}this._updateUI();}};D.namespace("comms");D.comms.LozengeAddressMod=B;D.comms.AddressLozenge=D.Base.create("addressLozenge",D.comms.Lozenge,[D.comms.LozengeAddressMod]);},"0.0.1",{requires:["base-build","comms-lozenge"]});YUI.add("mail-ui-sendconfirmview-base-conv",function(C){var F=C.mail.Controller.SendConfirm,Z=C.mail.Controller.Compose,M=C.ui.Templates,D=C.common.Utils,T=D.substitute,P=M._shared_module_send_confirm_rollup,O=C.Node.create,V=C.mail.ui.SearchBar,K=D.rocketstats,U=D.ymmastats,R;var a=function(Y){var g=this,f,d,e,c=Y.sdo;g.parent=null;g.isAbuseDetected=false;g.container=Y.container;g.sendingError=false;g.sendingErrorElse=false;a.superclass.constructor.call(g);g.neoEvent("sendConfirmEvent",{emitFacade:true,broadcast:1});g.bindSDO(c);};function S(Y){var c=this;c.sdo=Y;c.sdo.after("sendactionChange",function(d){var e=d.newVal.action;switch(e){case"success":R=d.newVal.args.addy;c.showSuccess(d.newVal.args.mid);U.stat("send","result=>success,env=>"+NeoConfig.mailEnv);break;case"captcha":c.showCaptcha(d.newVal.args.fault);U.stat("send","result=>captcha,env=>"+NeoConfig.mailEnv);break;case"error":c.showError(null,null,d.newVal.args.fault);U.stat("send","result=>error,env=>"+NeoConfig.mailEnv);break;case"abuse":c.showAbuse(null,null,null);U.stat("send","result=>abuse,env=>"+NeoConfig.mailEnv);break;default:break;}});}function W(){var Y=this;Y.container.showComposeShim(false);if(Y.sendingError){Y.sendingError=false;}Y.set("forceClose",1);Y.neoFire("sendConfirmEvent",{action:"removeChild",subview:Y});Y.container.showCompose(true);}function X(){}function b(d){var e=this,c,Y;if(d){e.parent=d;e.bindUI();}}function B(Y){var c=this;}function E(d,h,i){var f=this,j,e,k,Y,l,c={sending_error_detail:""},g=["str_cascd_ExceededMaxTo","str_cascd_ExceededMaxCc","str_cascd_ExceededMaxBcc","str_cascd_ExceededMaxRecipients","str_cascd_ExceededMaxHourlyMessages","str_cascd_ExceededMaxDailyMessages","str_cascd_InvalidRecipientAddress","str_cascd_MessageContentReject"];f.sendingError=true;f.container.composeView.lastSendState="sndError";if(!d){Y=i.code.replace(/[^\.]*\./,"");c.sending_error_detail=strings["str"+"_cascd_"+Y]||"["+Y+"]";l=C.mail.Errormap.getMessage({fault:i})||"";c.sending_error_detail=l+" "+c.sending_error_detail;c.sending_error_msg=strings.str_comp_not_sent;d=T(P.sending_error,c,null,null,strings,M);}f.backToMessage();f.container.notifyError({title:strings.str_error_SendMessageFailed,body:d});}function Q(c,Y,d){var e=this;e.isAbuseDetected=true;e.sendingError=true;e.container.composeView.lastSendState="sndError";e.container.notifyAbuse();e.neoFire("sendConfirmEvent",{action:"closeAction"});}function L(Y){var c=this;if(/AccountVerificationRequired/.test(Y.code)){c.doBlocked({type:"account"},Y);return;}else{if(/CannotSendThisMessage/.test(Y.code)){c.doBlocked({type:"message"},Y);return;}}C.use("mail-ui-captcha-controller",function(f){var d,e={data:Y.detail,contCbk:f.bind(function(g){c.retrySendMessageWithCaptcha(g);},c),cancelCbk:f.bind(function(){c.backToMessage();},c)};if(/Client.WrongInput/.test(Y.code)){e.data.inputError=true;}else{e.data.inputError=false;}d=new f.mail.ui.CaptchaController(e);if(!c.container.composeView.get("active")){c.neoFire("sendConfirmEvent",{action:"showCaptcha",fault:Y});}else{d.show();}});}function G(g,f){var h=this,c,Y,d,e=M._shared_module_send_confirm_captcha_blocked;Y={tryagain:false,backtomsg:true,abuse:false};d=g.type==="message"?e.message_blocked:e.account_blocked;c=T(d,{locale:NeoConfig.lang},null,null,strings,M);h.showError(c,Y,f);}function A(c){var d=this,Y;if(c.value){d.sendingError=false;if(c.captchaView==="audio"){d.sdo.set("captcha",{"X-HumanVerification-AudioUrl":c.url,"X-HumanVerification-Answer":c.value});}else{d.sdo.set("captcha",{"X-HumanVerification-ImageUrl":c.url,"X-HumanVerification-Answer":c.value});}Y=new D.Stopwatch("SendConfirm","start");Y.action="captcha";F.sendMessage(d.sdo,Y);}}function J(){var c=this,Y;Y=new D.Stopwatch("SendConfirm","start");Y.action="retry";F.sendMessage(c.sdo,Y);}function I(Y){var c=this;c.responseMid=Y;c.neoFire("sendConfirmEvent",{action:"closeAction"});if(c.container.composeView.flavor==="autocompose"){c._showDialog();}else{D.log({"m":"show message sent success notification","mid":Y});c._showNotification();}}function N(){var Y=this;C.use("common-ui-dialog-helper","_shared_module_offscreen_bin_modal_autocompose",function(f){var e=M._shared_module_offscreen_bin_modal_autocompose,d,c,g;f.common.ui.DialogHelper.createCommon({template:D.ezSub(e.base),centered:true,clearMask:true,noScroll:true},{ok:{handler:function(){f.fire("newMessage",{flavor:"autocompose"});U.stat("autocompose","launch=>another");}}},function(h){d=h.get("contentBox");g=f.later(50,{},function(){c=f.one("body").on("click",function(){h.destroy();});});h.on("destroy",function(){if(g){g.cancel();}if(c){c.detach();}});});});}function H(){var e=this,d=new C.common.ui.Notification({type:"fade",className:"top",parent:"shellcontent",parentType:"id"}),Y={msg:{mid:e.responseMid},fid:"Sent"},c=C.ui.Templates._shared_module_offscreen_bin_notification_notifications.send_success;d.on("clickEvent",function(f){switch(f.action){case"closeNotification":d.destroy();break;case"view":C.fire("openMessage",Y);break;}});d.notify(T(c,null,null,null,strings),4000);}C.extend(a,C.mail.ui.BaseWidget,{NAME:"SendConfirmView",render:b,postrender:B,bindUI:X,showAbuse:Q,showError:E,showCaptcha:L,showSuccess:I,retrySendMessageWithCaptcha:A,backToMessage:W,retrySendMessage:J,doBlocked:G,bindSDO:S,_showDialog:N,_showNotification:H});C.namespace("mail");C.mail.SendConfirmView=a;},"1.0.0",{requires:["common-utils","mail-controller-sendconfirm","minty_module_toolbar_inbox_sent_msg_rollup","_shared_module_send_confirm_rollup","_shared_module_offscreen_bin_notification_notifications","_shared_module_send_confirm_captcha_blocked","comms-lozenge-address","comms-ui-lozenge","mail-ui-searchbar","common-ui-notification","rocket-stats"]});