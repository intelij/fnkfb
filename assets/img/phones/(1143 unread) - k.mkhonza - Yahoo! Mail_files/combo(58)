YUI.add("messenger-conversationview",function(e){"use strict";var t,s=e.Tictac.mim.rollups,i=e.Messenger.Common.Utils,o=e.Messenger.View.ViewUtils,n=e.Tictac.mim.strings,a=e.Messenger.YMLUtil,r=e.Messenger.Common.Constants,c=e.Messenger.Model.UserSettings,l=e.Messenger.Common.SMSUtils,d=e.Messenger.Common.Stats,m=r.EVENTS,f={},u=40,g=90,h=4e3,p;function N(e){var t=e==="sms"?"yahoo":e||"yahoo",s=[],i=a.emoticonPickerEntries[t],o;if(f[t]){return f[t]}for(o in i){if(i.hasOwnProperty(o)){s.push({emotekey:o,emoteSmiley:i[o],emoteLabel:n["str_msgr_em_"+a.emoticonLabels[o]]})}}f[t]=s;return s}t=e.Tictac.base.View.extend({initialize:function(){var t=this;p=e.Messenger.Model.SystemSettings.get("isRTL");t.set("unreadCount",0);t.model.on(m.ACK_RECEIVED,function(){t.set("unreadCount",0);o.flashWindow(false)});t.model.on(m.SEND_ERROR,function(e){t._showSendErrorILN(e&&e.errorCode)});t.on("show",t._onShow,t);t._rteListeners=[]},onDestroy:function(){var e=this;e._setTypingState(false);if(e.RTE){while(e._rteListeners.length){e._rteListeners.pop().detach()}try{e.RTE.destroy()}catch(t){}}e.messageListNode.destroy();e.messageAreaNode.destroy();e.contact.off("change:presenceState change:presenceMessage",e._handlePresenceChange,this);e.contact.off("change:displayName",e._handleDisplayNameChange,this);e.model.off(m.ACK_RECEIVED);o.flashWindow(false)},createDOMNode:function(){var t=this.model.get("user"),a=this.model.get("network"),r=e.Messenger.Model.ContactList.getInstance(),c=r.getContact(t,a),l=c.get("displayName");this.contact=c;return e.Node.create(s.conversation({displayName:l,image:c.get("image"),mobileno:c.get("mobileno")||"",presenceMessage:c.get("presenceMessage")||o.getDefaultPresenceMessage(c.get("presenceState")),presenceClassName:o.getBuddyIconClass(c.get("presenceState")),emoticons:N(a),typingMessage:i.substitute(n.str_conv_typing,{conversation_user:l}),isRTL:p}))},_updateBuddyIcon:function(){var e=this,t,s;if((t=e.node.one(".mim-user-photo"))&&(s=e.contact.get("image"))){t.set("src",s)}},postRender:function(){var t=this.model.get("messages"),s=this,i,o;s.contact.on("change:image",e.bind(s._updateBuddyIcon,this));s.messageListNode=s.node.one("ul.mim-message-list");s.messageAreaNode=s.node.one(".mim-message-area");s._formatPane=s.node.one(".mim-format-pane");s._emoticonsPane=s.node.one(".mim-emoticons-pane");s.on("change:mode",s._handleModeChange,this);this.set("mode",this.options.mode||"im");for(i=0,o=t.length;i<o;i++){s.renderMessage(t[i])}s._handleModelDestroyEvents();if(s.contact.get("ignored")){this._showUnblockUserILN()}else if(s.contact.get("network")!=="sms"&&s.contact.get("type")==="unknown"){s._showUnknownUserILN()}s.contact.on("change:presenceState change:presenceMessage",s._handlePresenceChange,this);s.contact.on("change:displayName",s._handleDisplayNameChange,this);c.getPreference("mimEnableSSA",function(e){if(e){s.renderNotification({message:n.str_conv_btn_show_recent_conv,type:r.NOTIFICATION_SECTION_TOP,className:"mim-show-recent"});if(!c.getPreference("mimSSANotificationSeen")){s._showSSANotification()}}})},_onShow:function(){if(!this.RTE){this._renderRTE()}var e=this.get("unreadCount");if(e>0){o.flashWindow(false);this.model.ack();this.set("unreadCount",0)}if(this.model.get("ignored")){this._showUnblockUserILN()}this._forceScrollPane();this._updateLayout();this.focus()},_updateLayout:function(){if(!this.visible){return}var t=this.node.one(".mim-message-area"),s=this.node.one(".mim-notification-area");if(s.get("children").size()){if(s.get("offsetHeight")===0){e.later(0,this,function(){t.setStyle("top",s.get("offsetHeight"))})}else{t.setStyle("top",s.get("offsetHeight"))}}else{t.setStyle("top",0)}},_handleModeChange:function(){var e=this,t=e.get("mode");if(e.previous("mode")!==t&&t==="im"){if(e.RTE){e.RTE.enableFormatting();e.RTE.focus()}e.renderModeILN(t)}},_handlePresenceChange:function(e){var t=this.node.one(".mim-user-opi > b"),s=this.node.one(".mim-user-opi .mim-user-statusmsg"),i=e.get("presenceMessage")||o.getDefaultPresenceMessage(e.get("presenceState"));if(e.get("presenceState")!==e.previous("presenceState")){t.removeClass(o.getBuddyIconClass(e.previous("presenceState"))).addClass(o.getBuddyIconClass(e.get("presenceState")))}s.setHTML(i)},_handleDisplayNameChange:function(e){var t=e.get("displayName");this.node.one(".mim-user-opi b").setHTML(t);this.node.one(".mim-user-photo").setAttribute("title",t);this.messageListNode.all(".mim-message-other .mim-message-sender").setHTML(t);this.node.one(".mim-typing-notification").setHTML(i.substitute(n.str_conv_typing,{conversation_user:t}));this.trigger(m.DISPLAYNAME_UPDATED,this.model.get("id"),t)},_renderRTE:function(){var t=this,s,i=c.getPreference("mimDefaultFontSize"),o=c.getPreference("mimDefaultFontColor"),n=c.getPreference("mimDefaultFontFamily"),a,r;if(e.UA.ie===8){r="body {padding: 5px;overflow-y: visible;}"}else if(e.UA.ie){r="body {padding: 5px;overflow-y: hidden;box-sizing: border-box;}"}else{r="body {padding: 5px;overflow-y: hidden;}"}a={toolbarContainer:this.node.one(".mim-format-pane").getDOMNode(),rteHeight:"100%",rteWidth:"100%",defaultDirection:p?"rtl":"ltr",defaultFontSize:i,defaultFontColor:o,defaultFontFamily:n,initialCSS:r,showBackgroundColor:false,showLists:false,showLayout:false,showLink:false};t.RTE=new e.Tictac.base.RichTextEditor(a);if(window.strings&&window.strings.str_cfg_intl_fonts){s=t.RTE.get("fontFamilies");s=JSON.parse(window.strings.str_cfg_intl_fonts).concat(s);t.RTE.set("fontFamilies",s)}t.RTE.render(t.node.one(".mim-conversation-rte").getDOMNode());t.RTE.registerEventListener(e.bind(t._handleEditorEvents,t));t._rteListeners.push(t.RTE.on("defaultFontSizeChange",function(e){c.setPreference("mimDefaultFontSize",e.newVal);c.save()}));t._rteListeners.push(t.RTE.on("defaultFontFamilyChange",function(e){c.setPreference("mimDefaultFontFamily",e.newVal);c.save()}));t._rteListeners.push(t.RTE.on("defaultFontColorChange",function(e){c.setPreference("mimDefaultFontColor",e.newVal);c.save()}))},_handleModelDestroyEvents:function(){var e=this,t=e.model;t.on("destroy",function(){e.destroy()})},focus:function(){this.RTE.focus()},handleLogin:function(){this.node.all(".mim-notify-disconnect").remove(true);this.node.all("button").removeAttribute("disabled");this._disabled=false},handleLogout:function(){this.renderNotification({message:i.substitute(n.str_error_disconnected_error,{str_branding_messenger:n.str_branding_messenger}),type:r.NOTIFICATION_INLINE,error:true,className:"mim-notify-disconnect"});this.node.all("button").setAttribute("disabled","disabled");this._disabled=true},_handleEditorEvents:function(e){var t=this;if(t._disabled){return}if(e.type==="keydown"){return t._handleKeyDown(e)}else if(e.type==="keypress"){return t._handleKeyPress(e)}else if(e.type==="paste"){t._checkSize()}else if(e.type==="cut"){t._checkSize()}else if(e.type==="focus"){o.flashWindow(false);if(t._unreadMessage===true){t._unreadMessage=false;t.model.ack()}}return false},_handleKeyDown:function(t){var s=false,i=this.options.keyEvents,o=this;if(t.keyCode===27){o.close()}else if(t.keyCode===13){if(t.ctrlKey||t.shiftKey||t.altKey||t.metaKey){if(e.UA.gecko){s=true;e.later(0,this,function(){this.RTE.insertBR()})}}else{if(!this.contact.get("ignored")&&!(c.getPreference("mimBlockNonContacts")&&this.contact.collection.where({id:this.contact.id}).length===0)||this.get("mode")!=="im"){this._send()}s=true}}else if(i&&(t.metaKey||t.ctrlKey||t.shiftKey||t.keyCode<48)){_.each(i,function(e){var i=e.ctrlKey||false,n=e.metaKey||false,a=e.metaCtrlKey||false,r=e.shiftKey||false,c=a?t.metaKey||t.ctrlKey:n===t.metaKey&&i===t.ctrlKey;if(e.keyCode===t.keyCode&&c&&r===t.shiftKey){e.callback(o.RTE);s=e.halt}})}if(this._stoppedTypingTimerFast){clearTimeout(this._stoppedTypingTimerFast)}this._stoppedTypingTimerFast=e.later(100,this,function(){if(this.RTE&&this.node){this._checkSize()}});return s},_handleKeyPress:function(e){if(e.keyCode!==13){this._setTypingState(true)}},_startTypingTimer:function(){this._clearTypingTimer();this._stoppedTypingTimer=e.later(h,this,function(){this._setTypingState(false)})},_setTypingState:function(e){if(this.get("mode")!=="im"){return}if(this._isTyping!==e){this._isTyping=e;this.model.sendTypingNotification(e)}if(e){this._startTypingTimer()}else{this._clearTypingTimer()}},_clearTypingTimer:function(){if(this._stoppedTypingTimer){this._stoppedTypingTimer.cancel();this._stoppedTypingTimer=null}},_checkSize:function(){var t=this.node.one(".mim-conversation-rte"),s,i,o=u+"px",n=this.node.one(".mim-conversation-area"),a=n.one(".mim-message-area"),r=this.node.one(".mim-conversation-input-toolbar"),c=r.getY(),l=this.node.getY(),d=parseInt(this.node.getComputedStyle("height"),10),m=parseInt(n.getStyle("bottom"),10),f=l+d-c,_=a.get("scrollTop"),h=_+(f-m);if(t.getStyle("height")!==o){t.setStyle("height",o)}i=this.RTE.getScrollHeight();s=i;if(s>u){if(s>g){this.RTE.setBodyStyle("overflowY","auto");s=g}else{this.RTE.setBodyStyle("overflowY",e.UA.ie===8?"visible":"hidden")}t.setStyle("height",s+"px")}if(_!==h){n.setStyle("bottom",f+"px")}if(_!==h){a.set("scrollTop",h)}},_send:function(){var t=this.RTE.getTextContent(),s=this;if(t===""){return}s._doSend();s._clearTypingTimer();s._isTyping=false;e.later(0,null,function(){d.stat("message_send",{ltxt:s.get("mode")});o.triggerAds("978500261")})},_doSend:function(){var t=this.RTE.getContent();this.model.sendMessage(e.Messenger.YMLUtil.domToYml(e.Node.create(t).getDOMNode()));this.RTE.clear()},renderMessage:function(t){var a=this,l,m,f=new Date(t.timeStamp),_=e.Messenger.Neo.core,u="",g="",h=false,N=e.Tictac.base.bidi.bidiDirection(t.text())==="rtl",y="ltr",T,b=_.getDateFormat(f),I=new Date;if(t.fromSelf){m=n.str_conv_self_objective}else{m=a.contact.get("displayName");if(t.type==="sms"||t.type==="im"){d.stat("message_receive",{ltxt:t.type})}}if(!p){if(N){u="rtl";g="rtl"}}else{if(!N){u="ltr";g="ltr"}y="rtl"}if(t.type==="offline"&&!a._offlineNotification){a._offlineNotification=true;a.renderNotification({message:n.str_conv_user_offlineMessage_notice,type:r.NOTIFICATION_INLINE})}else if(t.type==="transfer"&&!a._transferNotification){a._transferNotification=true;a.renderNotification({message:i.substitute(n.str_conv_user_statexfer_notice,{conversation_user:m}),type:r.NOTIFICATION_INLINE})}else if(t.type!=="recent"&&t.type!==a.get("mode")){a.set("mode",t.type)}a._lastConversation=a.model.get("messages").slice(-1);if(I.getDate()!==f.getDate()||I.getMonth()!==f.getMonth()||I.getYear()!==f.getYear()){if(I.getYear()===f.getYear()&&I.getDate()-f.getDate()<7){b=_.getDateFormat(f,false,true).trim()}}l=e.Node.create(s.message({message:t.html(),isRTL:p,isTextRTL:N,fromSelf:t.fromSelf,displayName:m,rtlClass:u,messageDir:y,rtlTimestampClass:g,timestamp:_.dateFormatter(f,b)}));if(t.type==="recent"){a.node.one(".mim-recent-message-list").append(l);a._stopRecentMessageSpinner()}else{T=a.messageAreaNode.get("scrollHeight")-a.messageAreaNode.get("clientHeight")-a.messageAreaNode.get("scrollTop")<10;a.messageListNode.append(l);if(T){a._forceScrollPane()}}if(!t.fromSelf&&t.type!=="recent"){if(!a.isVisible()){a.set("unreadCount",a.get("unreadCount")+1);h=true}else if(a.RTE&&!a.RTE.isFocused()){h=true;a._unreadMessage=true}if(h){if(c.getPreference("mimEnableSounds")){o.playAudioNotification()}o.flashWindow(i.substitute(n.str_conv_new_message_browser_title,{conversation_user:m}))}}else if(t.fromSelf){a.set("unreadCount",0);o.flashWindow(false)}},_forceScrollPane:function(){if(this.messageAreaNode){this.messageAreaNode.set("scrollTop",this.messageAreaNode.get("scrollHeight"))}},setTypingNotification:function(e){if(e){this.node.one(".mim-typing-notification").setStyle("visibility","visible")}else{this.node.one(".mim-typing-notification").setStyle("visibility","hidden")}},close:function(){d.stat("conversation",{option:"close"});this.model.destroy({local:true})},getId:function(){return this.model.get("id")},events:{"click .mim-emoticon-list > .mim-emoticon":"_insertEmoticon","click [data-action]":"_handleActions",'click [data-autodestroy="true"]':"_destroyNotification","click .mim-notification-close":"_destroyNotification","click .mim-notification.mim-show-recent":"_toggleRecentMessages","click .mim-notification.mim-history-all":"_showConvHistory"},_toggleRecentMessages:function(t){var s=this,o=t.currentTarget,a=o.one(".mim-notification-text"),c=s.node.one(".mim-recent-message-list");if(o.hasClass("mim-hide-recent")){c.addClass("hidden");o.removeClass("mim-hide-recent");a.setHTML(n.str_conv_btn_show_recent_conv)}else{c.removeClass("hidden");if(!s._hasLoadedRecent){s.model.loadRecentMessages(s.get("mode"));s._hasLoadedRecent=true;s._hasNotLoadedRecent=true;e.later(5e3,s,function(){if(s._hasNotLoadedRecent){s._stopRecentMessageSpinner();o.addClass("hidden");s.renderNotification({message:i.substitute(n.str_error_recent_messages_empty,{contact:s._getContactDisplayName()}),type:r.NOTIFICATION_SECTION_TOP})}})}a.setHTML(n.str_conv_btn_hide_recent_conv);o.addClass("mim-hide-recent")}},_showConvHistory:function(){yui.fire("search:input",{customTitle:{noLabel:true,value:n.str_opt_msg_general_heading_history},query:{fnums:[8],from:this.model.get("user")}})},_getContactDisplayName:function(){var t=this.model.get("user"),s=this.model.get("network"),i=e.Messenger.Model.ContactList.getInstance(),o=i.getContact(t,s);return o?o.get("displayName"):""},_stopRecentMessageSpinner:function(){var e;if(this._hasNotLoadedRecent){e=this.node.one(".mim-recent-message-list .mim-recent-message-spinner");if(e){e.remove()}this._hasNotLoadedRecent=false;this.renderNotification({message:n.str_conv_show_all_history,type:r.NOTIFICATION_SECTION_TOP,className:"mim-history-all",selector:".mim-recent-message-list"})}},_insertEmoticon:function(e){var t=e.currentTarget,s=t.getAttribute("data-emotekey"),i=this.model.get("network"),o;if(i==="sms"){i="yahoo"}o=a.emoticonPickerEntries[i][s];if(this.RTE){this.RTE.insertText(o);this._emoticonsPane.addClass("hidden");this._updateToolbarState()}},_updateToolbarState:function(){var e=this.node.all(".mim-conversation-input-toolbar ul.cf li");e.removeClass("mim-toolbar-item-selected");if(!this._emoticonsPane.hasClass("hidden")){this.node.one(".mim-emoticons-link").addClass("mim-toolbar-item-selected")}else if(!this._formatPane.hasClass("hidden")){this.node.one(".mim-format-link").addClass("mim-toolbar-item-selected")}},_handleActions:function(e){var t=e.currentTarget.getAttribute("data-action");switch(t){case"closeconversation":this.close();break;case"format":d.stat("rte_format");this._formatPane.toggleClass("hidden");if(!this._emoticonsPane.hasClass("hidden")){this._emoticonsPane.toggleClass("hidden")}this._updateToolbarState();this.RTE.focus();break;case"emoticons":d.stat("rte_emoticon");this._emoticonsPane.toggleClass("hidden");if(!this._formatPane.hasClass("hidden")){this._formatPane.toggleClass("hidden")}this._updateToolbarState();this.RTE.focus();break;case"conv-mode":this.set("mode",e.currentTarget.getAttribute("data-mode"));break;default:break}},showAuthorizationILN:function(t){var s=e.Messenger.Model.ContactList.getInstance(),a=this,c=a.model.get("alias"),l=a.model.get("user"),m=a.model.get("displayName")||l,f=i.substitute(n.str_conv_no_contact_add_request,{conversation_yid:m}),_=a.model.get("network"),u=s.getContact(l,_),g,h;if(a.node.one(".mim-add-req")){return}if(a.node.one(".mim-unknownuser-iln")){a._destroyNotification(a.node.one(".mim-unknownuser-iln"))}if(!a.isVisible()){a.set("unreadCount",a.get("unreadCount")+1)}if(t){f+="<p class='mim-addreq-message'>"+e.Escape.html(t)+"</p>"}g=[{label:n.str_conv_btn_accept,title:i.substitute(n.str_conv_btn_accept_attr,{conversation_yid:l}),className:"mim-button-accept",callback:function(){d.stat("add_accept");u.sendAddResponse({accept:true,alias:c,err:function(e){a.renderNotification({type:r.NOTIFICATION_INLINE,error:true,message:o.convertErrorCodeToMessage(e.error.code)})}})}},{label:n.str_conv_btn_decline,className:"mim-button-decline",title:i.substitute(n.str_conv_btn_decline_attr,{conversation_yid:l}),callback:function(){d.stat("add_decline");u.sendAddResponse({alias:c,accept:false,err:function(e){a.renderNotification({type:r.NOTIFICATION_INLINE,error:true,message:o.convertErrorCodeToMessage(e.error.code)})}})}},{label:n.str_conv_btn_decline_block,title:n.str_conv_btn_decline_block,className:"mim-button-decline-block",callback:function(){d.stat("add_block");u.sendAddResponse({alias:c,accept:false});h={success:function(){a._showUnblockUserILN()},err:function(){}};u.ignoreUser(h)}}];a.renderNotification({message:f,type:r.NOTIFICATION_INLINE,buttons:g,className:"mim-add-req"})},_sendAddRequest:function(t){var s=this.model.get("alias"),i=e.Messenger.Model.ContactList.getInstance(),a=this.model.get("user"),c=this.model.get("network"),m=this,f,u;f=o.validateContactForm(t);if(f){return f}d.stat("conversation",{option:"add_to_contacts"});u=i.getContact(a,c);_.each(t,function(e,t){u.set(t,e);if(t==="mobileno"){u.set("normalizedNumber",l.normalizeNumber(e))}});u.sendAddRequest({addAs:s,group:n.str_conv_default_group,errorCallback:function(e){m.renderNotification({type:r.NOTIFICATION_INLINE,error:true,message:o.convertErrorCodeToMessage(e.error.code)})}})},_showSSANotification:function(){if(!this.node.one(".mim-ssa-notify")){this.renderNotification({message:n.str_opt_msg_general_history_description,type:r.NOTIFICATION_STATICTOP,className:"mim-ssa-notify",buttons:[{label:n.str_conv_user_notification_ssa_button,callback:function(){e.Messenger.GlobalEvents.trigger(r.EVENTS.SHOW_OPTIONS)}},{label:n.str_conv_user_notification_ssa_dismiss_button,callback:function(){c.setPreference("mimSSANotificationSeen",true);c.save()}}]})}},_showUnknownUserILN:function(){var t=this,a=e.Messenger.Model.ContactList.getInstance(),c=t.model.get("user"),l=t.model.get("network"),m=t.contact.get("firstName")||"",f=t.contact.get("lastName")||"",_,u=n.str_session_display_name_order.indexOf("{{lastName}}")===0,g=i.substitute(n.str_conv_wrn_unknown_user,{userid:c}),h=[{label:n.str_conv_btn_add_to_contacts,title:i.substitute(n.str_conv_btn_add_to_contacts_attr,{conversation_yid:c}),className:"mim-button-add",callback:function(){o.confirm({title:n.str_cont_add_to_cont,message:s.addcontact({user:c,lastNameFirst:u,isIE:!!e.UA.ie,firstName:m,lastName:f}),hasFormId:{formId:"mim-edit-contact"},callback:function(e){var s=o.validateContactForm(e);if(_&&!s){t._destroyNotification({currentTarget:_})}return t._sendAddRequest(e)}})}}],p={label:n.str_conv_btn_block_user,title:i.substitute(n.str_conv_btn_block_user_attr,{conversation_yid:c}),className:"mim-button-block",callback:function(){d.stat("conversation",{option:"block"});a.getContact(c,l).ignoreUser({success:function(){if(_){t._destroyNotification({currentTarget:_})}t._showUnblockUserILN()},err:function(e){t.renderNotification({type:r.NOTIFICATION_INLINE,error:true,message:o.convertErrorCodeToMessage(e.error.code)})}})}},N={label:n.str_conv_report_abuse,title:n.str_conv_btn_report_abuse_attr,className:"mim-button-abuse",callback:function(){d.stat("conversation",{option:"abuse"});o.confirm({title:n.str_conv_report_abuse_title,cssClass:"mim-report-abuse-dialog",message:s.report_abuse_spam({reportSpamText:n.str_conv_report_spam_radio,reportSpamDesc:n.str_conv_report_spam_description,reportAbuseText:n.str_conv_report_abuse_radio,reportAbuseDesc:n.str_conv_report_abuse_description}),callback:function(e){if(_){t._destroyNotification({currentTarget:_})}switch(e.abuseType){case"spam":d.stat("conversation",{option:"abuse_spam"});t._spam();t.close();break;case"abuse":d.stat("conversation",{option:"abuse_threat"});o.openReportAbuseWindow(n.str_urls_report_abuse_no_trans,t.model.get("messages"));t.contact.ignoreUser();t.close();break}}})}};if(!this.options.initiatedByMe){h.push(p);h.push(N)}if(t.node.one(".mim-add-req")){return}_=this.renderNotification({className:"mim-unknownuser-iln",message:g,type:r.NOTIFICATION_STATICTOP,buttons:h,showClose:true,autoDestroy:false})},_showUnblockUserILN:function(){var t=this,s=e.Messenger.Model.ContactList.getInstance(),a=this.model.get("user"),c=this.model.get("network"),l=i.substitute(n.str_conv_wrn_unblock_user,{userid:a}),m=[{label:n.str_conv_btn_unblock_user,title:i.substitute(n.str_conv_btn_unblock_user_attr,{conversation_yid:a}),className:"mim-button-unblock",callback:function(){d.stat("conversation",{option:"unblock"});t.focus();s.getContact(a,c).unignoreUser({err:function(e){t.renderNotification({type:r.NOTIFICATION_INLINE,error:true,message:o.convertErrorCodeToMessage(e.error.code)})}})}}];this.renderNotification({message:l,type:r.NOTIFICATION_STATICTOP,buttons:m,showClose:true})},_showSendErrorILN:function(e){var t=e&&o.convertErrorCodeToMessage(e)||"";this.renderNotification({message:e===1||!t?n.str_comp_send_error:t,type:r.NOTIFICATION_INLINE,error:true,showClose:true})},_spam:function(){var t=this,s=t.model.get("alias"),i=t.contact.get("displayName"),n=[],a=t.model.get("messages"),c,l,d,m,f,_;for(d=0,m=a.length;d<m&&d<50;d++){l={message:a[d].yml(),initiatedBy:a[d].fromSelf?1:2};if(a[d].hash){l.hash=a[d].hash}n.push(l)}c=n.length===0?1:n[0].initiatedBy;f={alias:s,initiatedBy:c,spims:n,err:function(e){t.renderNotification({type:r.NOTIFICATION_INLINE,error:true,message:o.convertErrorCodeToMessage(e.error.code)})}};if(n.length>0){t.contact.reportSpam(f)}_=e.merge(f,{success:function(){t._showUnblockUserILN()}});t.contact.ignoreUser(_);o.showSpamConfirm(i)},renderModeILN:function(t,i){var o=this,n=new Date,a=e.Messenger.Neo.core,c,l,d=o.model.get("messages");if(!d.length||d[d.length-1].type==="recent"){return}if(o._hasLoadedRecent||!o._lastConversation){l=o.messageAreaNode.one(".mim-section-notification:last-of-type");if(!l&&e.UA.ie>0){c=o.messageAreaNode.all(".mim-section-notification");if(c&&c.slice){l=c.slice(-1)}}if(l){l.remove()}}if(i||o.previous("mode")!==o.get("mode")){o.renderNotification({message:s.conv_section_modechange({IM:t==="im",dateTime:a.dateFormatter(n,a.getDateFormat(n))}),type:r.NOTIFICATION_SECTION});delete o._lastConversation}},renderNotification:function(t){if(this._destroyed){return}var i=t.buttons||[],o=t.type||r.NOTIFICATION_INLINE,n=t.message||"",a=this,c,l=t.autoDestroy,d=t.id,m=t.className||"",f,_,u,g,h;if(o===r.NOTIFICATION_SECTION||o===r.NOTIFICATION_SECTION_TOP){c=o===r.NOTIFICATION_SECTION?"append":"prepend";this.node.one(t.selector||".mim-message-list")[c](e.Node.create(s.conv_section_notification({message:n,notifyClass:m})));this._forceScrollPane();return}if(o===r.NOTIFICATION_STATICTOP){m+=" mim-notification-static"}else if(o===r.NOTIFICATION_INLINE||o===r.NOTIFICATION_INLINE_TOP){m+=" mim-notification-inline"}else{m+=" mim-notification-plain"}if(t.error){m+=" mim-notification-error"}if(typeof l==="undefined"){l=true}h={notifyClass:m,notifyId:d,showClose:!!t.showClose,notifyType:t.type,messageText:n};if(o===r.NOTIFICATION_INLINE_PLAINTEXT){h.showClose=false}else if(t.showClose!==false&&o===r.NOTIFICATION_STATICTOP){h.showClose=true}f=e.Node.create(s.conv_notification(h));if(i.length){_=f.one(".mim-notification-buttons");e.Array.each(i,function(t){if(!t.label||!t.callback){return}u=e.Node.create(s.conv_notification_btn({buttonClass:"mim-notification-button",buttonLabel:t.label,autoDestroy:l}));if(t.className){u.addClass(t.className)}u.on("click",t.callback);if(t.attrs){e.each(t.attrs,function(e,t){u.setAttribute(t,e)})}_.appendChild(u)});_.removeClass("hidden")}if(o===r.NOTIFICATION_STATICTOP){g=this.node.one(".mim-notification-area");g.append(f);g.removeClass("hidden");a._updateLayout()}else if(o===r.NOTIFICATION_INLINE_TOP){this.node.one(".mim-message-list").prepend(f)}else{this.node.one(".mim-message-list").append(f);this._forceScrollPane()}return f},_destroyNotification:function(e){var t=e.currentTarget||e,s,i;if(!t.hasClass("mim-notification")){t=t.ancestor(".mim-notification")}s=t.hasClass("mim-notification-static");t.ancestor(".mim-notification",true).remove(true);if(s){i=this.node.one(".mim-notification-area");if(i.get("children").size()===0){i.addClass("hidden")}this._updateLayout()}}});e.namespace("Messenger.View").ConversationView=t},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","messenger-contactlist","messenger-ymlutils","tictac-mim-strings","tictac-base-utils","base-bidi","tictac-base-richtexteditor","messenger-constants","messenger-utils","messenger-viewutils","messenger-conversation-css","messenger-usersettings","messenger-stats","messenger-smsutils","messenger-systemsettings"]});YUI.add("messenger-newconversationview",function(e){"use strict";var t,s=e.Tictac.mim.rollups,n=e.Messenger.Common.Utils,a=e.Messenger.View.ViewUtils,i=e.Messenger.Common.Stats,o=e.Messenger.Common.Constants,c=e.Messenger.Model.SystemSettings,r=0,l;function d(e){return e&&e.length>=4&&e.search(/[\\\|\!\#\$\%\^\*\(\)\+\[\]\{\}\?<>]/)<0}function m(e,t){return a.validatePhoneNumber(e,t)}function h(e){var t=/<[^>]*?>/gi;return e.replace(t,"")}function u(e){return e.replace(/\+/,"\\+")}t=e.Tictac.base.View.extend({initialize:function(){var e=this;l=c.get("isRTL");e.set("mode",e.options.mode||"im");e.on("show",e._onShow,e);e.on("hide",e._onHide,e);e._corpPresenceMap={}},createDOMNode:function(){var t=this.options.session,i=this.options.floaty,o=this._getContactsArray(),c=t.get("presenceState"),r=t.get("presenceMessage")||i&&a.getDefaultPresenceMessage(c),l;l=e.Node.create(s.newconversation({presenceName:a.getPresenceName(c),presenceClassName:a.getBuddyIconClass(t.get("presenceState")),presenceMessage:n.normalizePresenceMessage(r),stateName:a.getStateName(c),contacts:o,presenceUI:i?true:false}));return l},_contactOverlayClicked:function(t,s,n){var a=this,o=e.Messenger.Model,c=e.Messenger.View.ConversationListView.convListView,r=s.split("~"),l=this.collection.get(s)||this.collection.getContact(r[0],r[1]),d=l.get("user"),m=l.get("network"),h=o.Session.get("loggedInId");i.stat(t,{type:"search_action"});i.stat("frnd");switch(t){case"moremenu":a.showContextMenu(l,n,s);break;case"im":c.showConversation(d,m,h);break;case"sms":c.showConversation(d,m,h,"sms");break;case"email":var u={cbfn:function(e){var t=e.get("header");t.to=[{name:l.get("displayName"),email:l.get("email")||l.get("user")}];e.set("header",t)}};yui.fire("newMessage",u);break}},postRender:function(){this.options.session.on("change:presenceState",this._handlePresenceStateChange,this);this.options.session.on("change:presenceMessage",this._handlePresenceMessageChange,this);this.collection.on("change:presenceState add",this._handleUpdateContactState,this);this.collection.on("change:displayName",this._handleContactDisplayNameChange,this);this.collection.on("remove",this._handleContactRemoval,this);var e=this.node.all("#mim-newconversation-contact-list > li");if(e.size()>0){this._selectedContactNode=e.item(0);this._selectedContactNode.addClass("mim-contact-selected")}else{this._selectedContactNode=null}this._filterNode=this.node.one(".mim-contact-input");this._clearNode=this.node.one(".mim-contact-input-clear")},_onShow:function(){if(!this._filterValue){this._clearFilter()}this.focus()},_onHide:function(){this._corpPresenceMap={}},focus:function(){this._filterNode.focus()},onDestroy:function(){this.options.session.off("change:presenceState",this._handlePresenceStateChange,this);this.options.session.off("change:presenceMessage",this._handlePresenceMessageChange,this);this.collection.off("change:presenceState add",this._handleUpdateContactState,this);this.collection.off("change:displayName",this._handleContactDisplayNameChange,this);this.collection.off("remove",this._handleContactRemoval,this)},_sortScore:function(e,t){var s,n,a=this.get("mode")==="sms",i=o.STATE.AVAILABLE;if(typeof e==="object"){i=e.presenceState;n=e.network;e=e.displayName.toLowerCase()}else if(typeof e==="string"){e=e.toLowerCase()}else{}if(t&&e.indexOf(t)===0){s="0-"}else if(a&&n==="sms"){s="1-"}else if(!a&&i===o.STATE.OFFLINE){s="9-"}else{s="5-"}e=s+e;return e},_getMode:function(e,t){var s=this.get("mode"),n,a;if(e){n=e.get("mobileno");a=e.get("network");if(s==="sms"){if(!n&&a!=="sms"){s="im"}}else{if(a==="sms"||t&&n&&n.indexOf(t)>=0){s="sms"}}}else{s=m(t)?"sms":"im"}return s},_getContactObj:function(t,s,n){var i,o,r,d,m,h;function g(e,t){return e.get?e.get(t):e[t]}o=g(t,"displayName");r=s&&(typeof s==="string"?new RegExp(u(s),"i"):s);d=n||(this.get("mode")==="sms"?g(t,"mobileno"):g(t,"user"));d=e.Escape.html(d);m=!r?o:o.replace(r,'<span class="mim-contact-matched">'+"$&"+"</span>");h=!r?d:d.replace(r,'<span class="mim-contact-matched">'+"$&"+"</span>");if(d&&o!==d){i=m+(l?" &rlm;":" ")+'<span class="mim-contact-alternate">('+h+")</span>"}else{i=m}return e.merge(t.attributes,{className:a.getBuddyIconClass(g(t,"presenceState")),mergedDisplayName:i,contact:t,has_overlay:!this.options.floaty,has_email:!!g(t,"email"),has_im:g(t,"network")!=="sms",has_sms:c.get("smsEnabled")&&!!g(t,"mobileno")})},_byFieldsIncluding:function(e,t){var s,n,a,i,o,c;var r={firstName:false,lastName:false,nickname:false,mobileno:true,email:false,user:true,displayName:true,mergedDisplayName:false,id:false};for(n in r){if(r.hasOwnProperty(n)){a=r[n];if(a){i=e[n];o=typeof t==="string"?new RegExp(u(t),"i"):t;c=i&&o&&i.match(o);if(c||!o){e.mergedDisplayName=this._getContactObj(e.contact,o,i).mergedDisplayName;s=true}}}}return s},openConversation:function(t,s){var n,a,i,o=this._getMode(t,s),c=e.Messenger.View.ConversationListView.convListView;if(t&&!!t.get("user")){n=t.get("user");a=t.get("network")}else{n=(d(s)||m(s))&&s;a=o==="sms"?"sms":"yahoo";if(a==="yahoo"&&n.indexOf("@")>-1){n=e.Messenger.Common.ABUtils.extractYidFromEmail(n);if(n){n=n.id}}}if(c&&n){c.showConversation(n,a,i,o,true)}},_handlePresenceStateChange:function(e){var t=this.node.one(".mim-user-opi > .mim-presence-state");if(t){t.removeClass(a.getBuddyIconClass(e.previous("presenceState"))).addClass(a.getBuddyIconClass(e.get("presenceState")));t.setHTML(a.getPresenceName(e.get("presenceState")))}if(this.presencePlugin){this.presencePlugin.updateContactListState(e)}},_handlePresenceMessageChange:function(e){var t=this.node.one(".mim-user-opi .mim-presence-message");if(t){t.setHTML(n.normalizePresenceMessage(e.get("presenceMessage")))}if(this.presencePlugin){this.presencePlugin.updateContactListState(e)}},_handleUpdateContactState:function(e){var t=e.id,s=this.node.one("#mim-newconversation-contact-list"),n=s.one('li[data-id="'+t+'"]'),i=e.get("presenceState");if(n){n.removeClass(a.getBuddyIconClass(e.previous("presenceState"))).addClass(a.getBuddyIconClass(i))}},_handleContactDisplayNameChange:function(){this._clearFilter()},_handleContactRemoval:function(e){var t=this.node.one('li[data-id="'+e.get("id")+'"]'),s,n=this._getContactObj(e),a=n.mergedDisplayName,i=a.toLowerCase();if(t){t.remove(true)}this._buddyArr=this._buddyArr||[];s=_.indexOf(this._buddyArr,i);if(s!==-1){this._buddyArr.splice(s,1)}},_getContactsArray:function(){var e=this,t;t=_.map(this.collection.filter(function(t){var s=e.options.session.isMyself(t.get("user"));return!s&&(!t.get("ignored")||t.get("mobileno"))&&(e.get("mode")!=="sms"||t.get("mobileno"))&&(c.get("smsEnabled")||t.get("network")!=="sms")}),function(t){return e._getContactObj(t)});t=_.sortBy(t,function(t){return e._sortScore(t)});this._buddyArr=_.map(t,function(e){return e.mergedDisplayName.toLowerCase()});return t},_setFilter:function(t,n){var a,i,o=this,c=o._getContactsArray();if(c){a=_.map(_.filter(c,function(e){return t(e,n)}),function(e){return e});a=_.sortBy(a,function(e){return o._sortScore(e,n)});if(d(n)||m(n,1)){var r={className:"ymsg-new-contact",displayName:n,mergedDisplayName:n};a.push(r)}i=e.Node.create(s.newconvcontlist({contacts:a}));o.node.one(".mim-newconversation-area").replace(i);var l=o.node.all("#mim-newconversation-contact-list > li");if(l.size()>0){o._selectedContactNode=l.item(0);o._selectedContactNode.addClass("mim-contact-selected")}else{o._selectedContactNode=null}if(e.Messenger.Neo.NeoConfig.isCorpmail===true){if(o._pendingGabCall){o._pendingGabCall.abort()}o._showCorpContacts(n,o._normalizeCorpContactsAndAppend)}}},_showCorpContacts:function(t,s){var n=+new Date,a=this,i="/neo/gab/gab.php?q="+t+"&corpmail=1&windowId="+e.Messenger.Neo.NeoConfig.windowId+"&r="+n;a._pendingGabCall=e.io(i,{headers:{"Content-Type":"application/json"},on:{success:function(n,i){var o=e.JSON.parse(i.responseText.replace(/<!--[^>]*>\s*$/,""));a._pendingGabCall=null;s(o,t,a)},failure:function(){a._pendingGabCall=null}}})},_normalizeCorpContactsAndAppend:function(t,n,a){var i=a._normalizeCorpContacts(t.data,n),o;if(i.length>0){o=e.Node.create(s.newconvcorpcontlist({corpContacts:i}));e.one("#mim-newconversation-contact-list").append(o);a._corpContacts=i}},_normalizeCorpContacts:function(t,s){var n=[],i=this,o=[];if(!t.push){t=[t]}_.each(t,function(t){var c={firstName:t.firstname,lastName:t.lastname,email:t.email,user:t.email,clientCapabilities:1,type:"addressbook"},r=e.Messenger.Model.ContactList.getInstance().normalizeContact(c);r=i._getContactObj(r,s);r=e.mix(r,r.contact);r.className="ymsg-corp-contact ";if(typeof i._corpPresenceMap[t.email]!=="undefined"){r.presenceState=i._corpPresenceMap[t.email];r.className+=a.getBuddyIconClass(r.presenceState)}else{r.className+="ymsg-offline";o.push(t.email)}n.push(r)});if(o.length){i._getCorpContactsPresence(o)}return n},_getCorpContactsPresence:function(t){var s=this,i="/online/ws?m=1&p=1&t=1",o={context:s,method:"POST",on:{success:function(t,i){var o=e.JSON.parse(i.responseText);o=o&&o.buddyStatus;var c={};e.each(o,function(t){e.mix(c,t)});e.each(c,function(t,i){t.presenceState=t.statusCode;t.customDNDStatus=t.dndStatus;var o=e.one("[data-id="+i+"~yahoo]"),c=n.normalizePresenceState(t);if(o){a.replaceBuddyIcon(o,c)}s._corpPresenceMap[i]=c});s._pendingPresenceReq=null}},data:e.JSON.stringify({buddiesYid:t})};if(s._pendingPresenceReq){s._pendingPresenceReq.abort()}s._pendingPresenceReq=e.io(i,o)},_clearFilter:function(){var t,n,a=this,i=a._getContactsArray();i=_.sortBy(i,function(e){return a._sortScore(e)});t=e.Node.create(s.newconvcontlist({contacts:i}));a.node.one(".mim-newconversation-area").replace(t);n=a.node.all("#mim-newconversation-contact-list > li");if(n.size()>0){a._selectedContactNode=n.item(0);a._selectedContactNode.addClass("mim-contact-selected")}else{a._selectedContactNode=null}a._filterNode.set("value","");a._filterValue="";a._filterFunc=null;a._clearNode.setAttribute("disabled","disabled");a._clearNode.setAttribute("data-search",true)},_navUpDownNodes:function(e){var t=this.node.all("#mim-newconversation-contact-list > li"),s,n,a,i,o,c,l,d,m,h;if(t.size()>0){s=e>0?t.item(0):t.item(t.size()-1);if(!this._selectedContactNode){n=s}else{n=t.item(t.indexOf(this._selectedContactNode)+e);if(!n){n=s}}t.removeClass("mim-contact-selected");if(n){this._selectedContactNode=n;if(n.hasClass("mim-corp-contacts-separator")){if(t.size()>1){this._navUpDownNodes(e);return}else{this._selectedContactNode=null}}else{this._selectedContactNode.addClass("mim-contact-selected");a=this._selectedContactNode.get("parentNode");i=a.getY();o=parseInt(a.getComputedStyle("height"),10);c=i+o;l=this._selectedContactNode.getY();d=parseInt(this._selectedContactNode.getComputedStyle("height"),10);m=l+d;h=l>i&&m<c;if(!h){this._selectedContactNode.scrollIntoView(e<0)}}}}r=new Date},_mouseenter:function(e){var t=e.currentTarget;var s=new Date-r;if(t&&s>1e3){var n=this.node.all("#mim-newconversation-contact-list > li");n.removeClass("mim-contact-selected");t.addClass("mim-contact-selected");this._selectedContactNode=t}},_handleKey:function(t){var s=this,n=e.Escape.html(h(e.Lang.trim(s._filterNode.get("value")))),a;if(s.changeFilterTimeout){clearTimeout(s.changeFilterTimeout);s.changeFilterTimeout=null}if(!t||t.keyCode===27){s.trigger("escKeyDown");if(t&&s.options.floaty){t.halt()}}else if(t.keyCode===40){s._navUpDownNodes(1);t.halt()}else if(t.keyCode===38){s._navUpDownNodes(-1);t.halt()}else if(t.keyCode===13){if(s._selectedContactNode){a=s._getContactFromLI(s._selectedContactNode);s.openConversation(a,n)}s._clearFilter();t.halt()}else{s.changeFilterTimeout=setTimeout(function(){s._filterValue=e.Escape.html(h(e.Lang.trim(s._filterNode.get("value"))));var t=s._filterValue.length===0;if(t){s._clearNode.setAttribute("disabled","disabled");s._clearFilter()}else{s._clearNode.removeAttribute("disabled");s._setFilter(e.bind(s._byFieldsIncluding,s),s._filterValue)}s._clearNode.setAttribute("data-search",t)},100)}},_getContactFromLI:function(e){var t=this,s=e.getAttribute("data-id"),n,a,i,o=e.hasClass("ymsg-corp-contact"),c;if(s){a=s.split("~");i=t.collection.get(s);if(!i&&a[0]){i=t.collection.getContact(a[0],a[1]);if(o){c=_.find(t._corpContacts,function(e){return e.user===a[0]});if(c){i.set({firstName:c.firstName,lastName:c.lastName,displayName:c.displayName})}}}if(o&&i.get("type")==="unknown"){n=s.split("~")[0];if(typeof t._corpPresenceMap[n]!=="undefined"){i.set("presenceState",t._corpPresenceMap[n])}}}return i},getId:function(){return"new"},close:function(){},clickNewConversationList:function(t){var s,n,a,o,c;s=t.target;n=t.currentTarget;if(s.hasClass&&s.hasClass("mim-corp-contacts-separator")||n.hasClass&&n.hasClass("mim-corp-contacts-separator")){t.halt();return}o=this._getContactFromLI(n);a=n.getAttribute("data-id");c=e.Escape.html(e.Lang.trim(this._filterNode.get("value")));if(s.hasClass&&s.hasClass("mim-newconversation-overlay-btn")){this._contactOverlayClicked(s.getAttribute("data-action"),a,n);t.halt()}else{i.stat("im",{type:"search"});i.stat("frnd");this.openConversation(o,c);this._clearFilter()}},handleContextMenu:function(e){var t=this,s,n,a,i;if(t.contactPlugin){s=e.target;a=e.currentTarget;if(s.hasClass&&s.hasClass("mim-corp-contacts-separator")||a.hasClass&&a.hasClass("mim-corp-contacts-separator")){e.halt();return}n=this._getContactFromLI(a);i=a.getAttribute("data-id");t.showContextMenu(n,a,i);e.halt()}},showContextMenu:function(e,t,s){var n=this,a,i;i=n.node.one("#mim-newconversation-contact-list");a=i.getX()+i.get("offsetWidth")/2;n.contactPlugin.showContactMenu({contact:e,item:t,id:s,leftPos:a,hover:false,favorites:false})},handleLogin:function(){},handleLogout:function(){},events:{"mouseenter #mim-newconversation-contact-list > li":"_mouseenter","keydown .mim-newconversation .mim-contact-input":"_handleKey","click #mim-newconversation-contact-list > li":"clickNewConversationList","contextmenu #mim-newconversation-contact-list > li":"handleContextMenu","click .mim-contact-input-clear":"_clearFilter"}});e.namespace("Messenger.View").NewConversationView=t},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","messenger-contactlist","messenger-ymlutils","tictac-mim-strings","tictac-base-utils","base-bidi","messenger-systemsettings","messenger-constants","messenger-utils","messenger-viewutils","messenger-conversation-css","escape","messenger-abutils","io"]});YUI.add("messenger-addrequestview",function(e){"use strict";var t,s=e.Tictac.mim.rollups,n=e.Messenger.Common.Utils,i=e.Messenger.Model.ContactList.getInstance(),a=e.Messenger.Common.Stats,o={length:0},r=e.Messenger.View.ViewUtils;t=e.Tictac.base.View.extend({initialize:function(){var e=this;e.set("unreadCount",0);e.on("show",e._onShow,e)},createDOMNode:function(){var t=this,i,a=this.options.session,c=this.options.addRequests;_.each(c,function(e){var s=n.getUserId(e.user,e.network);e.id=s;o[s]=e;o.length++;t.set("unreadCount",t.get("unreadCount")+1)});i=e.Node.create(s.addrequests({presenceName:r.getPresenceName(a.get("presenceState")),presenceClassName:r.getBuddyIconClass(a.get("presenceState")),presenceMessage:n.normalizePresenceMessage(a.get("presenceMessage")),contacts:c}));return i},postRender:function(){a.stat("group_add");this._ulNode=this.node.one(".mim-addreq-container");if(this.isVisible()){this.set("unreadCount",0)}if(this.options.ContactList){i=this.options.ContactList}},_onShow:function(){if(this.isVisible()){this.set("unreadCount",0)}},onDestroy:function(){},getId:function(){return"addrequests"},close:function(){this.destroy()},events:{"click .mim-addreq-container button":"_handleIndividualAction","click .mim-block-all-btn":"_handleBlockAll"},_handleBlockAll:function(){var e,t;a.stat("group_add_block_all");for(var s in o){if(o.hasOwnProperty(s)&&s.indexOf("~")!==-1){e=o[s];t=i.getContact(e.user,e.network);t.sendAddResponse({accept:false,alias:e.alias});t.ignoreUser();this.node.one('li[data-id="'+s+'"]').remove();delete o[s]}}this.close()},_handleIndividualAction:function(e){var t=e.currentTarget.ancestor("li.mim-addreq-contact"),s=o[t.getData("id")],n=i.getContact(s.user,s.network);if(e.currentTarget.hasClass("mim-im-btn")){a.stat("group_add_im");this.trigger("openConversation",{contact:n})}else if(e.currentTarget.hasClass("mim-decline-btn")){a.stat("group_add_decline");n.sendAddResponse({accept:false,alias:s.alias});t.remove();o.length--}else if(e.currentTarget.hasClass("mim-block-btn")){a.stat("group_add_block");n.sendAddResponse({accept:false,alias:s.alias});n.ignoreUser();t.remove();o.length--}else{a.stat("group_add_accept");n.sendAddResponse({accept:true,alias:s.alias});t.remove();o.length--}if(o.length<=0){this.close()}}});e.namespace("Messenger.View").AddRequestView=t},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","messenger-contactlist","messenger-ymlutils","tictac-mim-strings","tictac-base-utils","base-bidi","messenger-utils","messenger-viewutils","messenger-conversation-css","messenger-stats"]});YUI.add("messenger-conversationlistview",function(e){"use strict";var t,i=e.Tictac.mim.rollups,n=e.Messenger.Common.Utils,o=e.Messenger.View.ViewUtils,s=e.Tictac.mim.strings,a=e.Messenger.Common.Constants,r=e.Messenger.Model.UserSettings,d=e.Messenger.Common.Stats,l=a.EVENTS,h=e.Messenger.Model.SystemSettings,c="new",f="addrequests",v={duration:.3,easing:"ease-in-out",top:o.getWindowHeight()-150+"px",left:h.get("isRTL")?+o.getWindowSize().width-150+"px":"150px",opacity:"0",width:"50px",height:"50px"};t=e.Tictac.base.DialogView.extend({hideButtons:true,hideClose:true,modal:false,initialize:function(){var t=this,i=e.Messenger.Model.Session,n=e.one("#toolbar #btn-new a"),s,r=e.one("#msg-preview");t.conversationViews={};t.visibleConvID=null;t.collection.on(a.EVENTS.MESSAGE,t._processMessage,t);t.collection.on("change:userTyping",t._processTypingNotification,t);t.collection.on("add",t._processAddRequest,t);if(t.options.floaty){t.options.collectionCL.on(l.ADD_REQUEST_RECEIVED,t.handleAddRequest,t)}else{i.on(l.LOGOUT_LOCAL,function(){t.close({},true)})}i.on("change:presenceState",t._handlePresenceChange,t);e.on("keydown",function(e){var i=e.altKey||e.ctrlKey||e.metaKey;if(!i&&!o.isInputNode(e.target)){if(e.keyCode===73){d.stat("im",{type:"shortcut_i"});d.stat("frnd");t.showNewConversation();e.halt();return false}else if(e.keyCode===84){d.stat("sms",{type:"shortcut_t"});t.showNewConversation("sms");e.halt();return false}}},e.UA.ie?document:window);function h(i){i=i||0;if(i>30){return}function o(e){var i=e.currentTarget;t.showNewConversation(i.getAttribute("data-mode")||"im")}n=e.one("#menu-new");if(!n){e.later(100,null,h,++i);return}s=n.all("[data-action='new-conv']");if(s.size()===2){s.item(0).setAttribute("data-mode","im");s.item(1).setAttribute("data-mode","sms")}t._listeners.push(n.delegate("click",o,"[data-action='new-conv']"))}if(n){n.once("click",h)}function c(e){var i=e.currentTarget;if(i.hasClass("sms")){t.showNewConversation("sms")}else if(i.hasClass("im")){t.showNewConversation("im")}}if(r){t._listeners.push(r.delegate("click",c,"#msg-preview-media-modes span a"))}function f(i,n){var o,s=e.Messenger.Model.ContactList.getInstance(),a;n=n||"im";if(!i||!i.id){return}if(n==="sms"){o=s.where({mobileno:i.id});if(o.length){t.showConversation(o[0].get("user"),o[0].get("network"),null,n)}else{t.showConversation(i.id,"sms",null,n)}}else{if(i.id.indexOf("@")!==-1){a=e.Messenger.Common.ABUtils.extractYidFromEmail(i.id);if(!a||!a.id){return}i.id=a.id;i.network=a.network}t.showConversation(i.id,i.network||"yahoo",null,n)}}if(window.yui){t._listeners.push(yui.on("contacts:sendIM",f));t._listeners.push(yui.on("chats:sendIM",f));t._listeners.push(yui.on("contacts:sendSms",function(e){f(e,"sms")}));t._listeners.push(yui.on("chats:sendSms",function(e){f(e,"sms")}))}t._addReqs=[]},onDestroy:function(){var t=this,i=e.Messenger.Model.Session;t.off("stopResize",t._onStopResize,t);t.off("stopMove",t._onStopMove,t);t.collection.off(a.EVENTS.MESSAGE,t._processMessage,t);t.collection.off("change:userTyping",t._processTypingNotification,t);t.collection.off("add",t._processAddRequest,t);if(t.options.floaty){t.options.collectionCL.off(l.ADD_REQUEST_RECEIVED,t.handleAddRequest,t)}else{i.off(l.LOGOUT_LOCAL,t.close,t)}i.off("change:presenceState",t._handlePresenceChange,t)},renderContent:function(t){t.ancestor(".modal").addClass("mim-conversations");t.append(e.Node.create(i.conversationlist({hasMinimize:!this.options.floaty})))},postRender:function(){var t=this,i=o.getWindowSize(),n=e.Messenger.Neo.yui,s=r.getPreference("mimConvWinSizePref"),a=r.getPreference("mimConvWinSizePrefOld"),d=r.getPreference("mimConvWinPosPref");this.listNode=this.node.one("ul.mim-conversations-list");this.tabNode=this.node.one("ul.mim-conversations-tabs");if(this.tabNode){this._overflowButton=this.tabNode.one(".mim-overflow-tab");this._addButton=this.tabNode.one(".mim-new-tab")}this.on("resize",function(){t._makeConversationTabVisible();t._checkTabOverflow()});if(typeof s==="string"){try{s=JSON.parse(s)}catch(l){}}if(typeof d==="string"){try{d=JSON.parse(d)}catch(l){}}if(s.width===a.width){s.width=300}if(!s){s={width:300,height:350}}else{if(typeof s.width==="string"){s.width=parseInt(s.width,10);if(isNaN(s.width)){s.width=0}}if(typeof s.height==="string"){s.height=parseInt(s.height,10);if(isNaN(s.height)){s.height=0}}s.width=Math.max(250,s.width);s.height=Math.max(250,s.height)}this.node.setStyles({width:s.width+"px",height:s.height+"px"});if(!d){d={right:200,bottom:20}}this.node.setStyles({bottom:d.bottom+"px",right:d.right+"px"});if(this.options.floaty){this.on("change:unreadCount",this._handleNewMsgNotification,this);this.on("change:minimized",this._handleConvMinMax,this);this._handleNewMsgNotification(this)}if(this.options.minimized!==false){this.minimize();this._viewStyles={top:i.height-(~~s.height+~~d.bottom)+"px",left:i.width-(~~s.width+~~d.right)+"px",opacity:"1.0",width:s.width+"px",height:s.height+"px"}}else{this.set("minimized",false)}this.on("stopResize",this._onStopResize,this);this.on("stopMove",this._onStopMove,this);this.on("hide",this._onHide,this);n.on("nav:messenger",this._onActivate,t)},_toggleHideCurrentView:function(e){var t=this.conversationViews[this.visibleConvID];if(t){if(e){t.hide()}else{t.show();this._switchConversationTab(this.visibleConvID)}}},_onActivate:function(){if(this.get("minimized")){d.stat("window_maximize");this.maximize()}},_onStopResize:function(){var e=this,t=e.node.get("region");r.setPreference("mimConvWinSizePref",{width:t.width,height:t.height});e._onStopMove()},_onStopMove:function(){var e=this,t=e.node.get("region"),i=o.getWindowSize(),n;if(h.get("isRTL")){e.node.setStyles({right:o.getWindowSize().width-t.right+"px",left:"auto"})}r.setPreference("mimConvWinPosPref",{right:i.width-t.right,bottom:i.height-t.bottom});r.save();if((n=e.visibleConvID)!==null){if(e.conversationViews[n]){e.conversationViews[n].focus()}}},_onHide:function(){var e=this;if(e.options.floaty){e.set("minimized",true)}},close:function(e,t){if(e&&e.type&&e.type==="keydown"&&e.keyCode!==13){return}var i=this;d.stat("window_close");if(!t&&this.get("unreadCount")){o.confirm({message:s.str_conv_close_confirm,callback:function(){i.close(e,true)}});return}i.minimize(function(){if(!i.options.floaty){for(var e in i.conversationViews){if(i.conversationViews.hasOwnProperty(e)){var t=i.conversationViews[e];t.close()}}i.visibleConvID=null}})},minimize:function(e){if(!e||e.type===undefined||(e.type==="click"||e.keyCode===13)){var t=this;if(t.get("minimized")){return}if(t.tabNode){t.tabNode.addClass("mim-overflow-hidden")}t._toggleHideWindow(true,function(){t._toggleHideCurrentView(true);if(e&&typeof e==="function"){e()}else if(e&&e.halt){d.stat("window_minimize")}});t.set("minimized",true)}},maximize:function(){var e=this;if(!e.get("minimized")){return}e._toggleHideWindow(false,function(){var t=e.node.get("region");e._checkTabOverflow();e._toggleHideCurrentView(false);if(h.get("isRTL")){e.node.setStyles({right:o.getWindowSize().width-t.right+"px",left:"auto"})}if(!e.visibleConvID){e.showNewConversation()}if(e.tabNode){e.tabNode.removeClass("mim-overflow-hidden")}e.visible=true;o.limitToViewport(e.node)});e.set("minimized",false)},_toggleHideWindow:function(t,i){var n=this,s=n.node,a=e.one("body"),r=n.options.floaty?".nav-item-messenger":a.getAttribute("data-open")==="messenger"?"#mim-cl-view":"#messenger",d={},l=["top","left","opacity","width","height"];if(t){n._viewStyles={};s.setStyle("top",s.get("offsetTop")+"px");s.setStyle("left",s.get("offsetLeft")+"px");v.top=e.one(r).get("region").top+"px";if(h.get("isRTL")){v.left=+o.getWindowSize().width-150+"px";s.setStyles({bottom:"auto",right:"auto"})}_.each(l,function(e){n._viewStyles[e]=s.getStyle(e)});_.extend(d,v,{on:{end:function(){s.addClass("hidden");if(i){i()}}}})}else{s.setStyle("top",e.one(r).get("region").top+"px");if(h.get("isRTL")){v.left=+o.getWindowSize().width-150+"px"}_.extend(d,v,n._viewStyles,{on:{end:function(){if(i){i()}}}});s.removeClass("hidden")}if(n.node.hasClass("hidden")){e.each(d,function(e,t){if(t!=="on"&&t!=="easing"&&t!=="duration"){s.setStyle(t,e)}});if(i){i()}}else{s.transition(d)}},_updateUnreadCount:function(){var e=0;for(var t in this.conversationViews){if(this.conversationViews.hasOwnProperty(t)&&this.conversationViews[t].get("unreadCount")){e+=this.conversationViews[t].get("unreadCount")}}this.set("unreadCount",e)},_addConversation:function(t,i,o,s,a){var r=this,d=r.collection,h=e.Messenger.Model.Session,c=e.Messenger.View.ConversationView,f=e.Messenger.Model.ContactList.getInstance(),v,m,g,u,w;i=i||"yahoo";v=f.get(n.getUserId(t,i));m=v?v.get("displayName"):t;o=o||h.get("loggedInId");g=n.getConversationId(o,t,i);w=r.conversationViews[g];if(w){w.set("mode",s)}else{if(!(u=d.get(g))){d.add({id:g,user:t,network:i,alias:o},{silent:true});d.trigger(l.CONVERSATION_INIT,{id:g,user:t,network:i});u=d.get(g)}s=s||"im";w=new c({parent:r.listNode,container:"<li class='mim-conversations-conversation hidden'></li>",model:u,mode:s,limitToViewport:false,keyEvents:[{keyCode:219,metaCtrlKey:true,callback:e.bind(r.togglePrevConv,r),halt:true},{keyCode:221,metaCtrlKey:true,callback:e.bind(r.toggleNextConv,r),halt:true},{keyCode:9,shiftKey:true,halt:true,callback:function(e){var t=r.node.one("a[data-action=emoticons]");if(e&&e.blur){e.blur()}if(t&&t.focus){t.focus()}}},{keyCode:9,shiftKey:false,callback:function(){(e.UA.ie?document:window).focus()}}],initiatedByMe:a});r.conversationViews[g]=w;w.render();r._addConversationTab(g,m,t);w.on("destroy",function(){r._conversationViewDestroyed(g)},r);w.on("change:unreadCount",function(e){r._updateTabBadge(e.getId());r._updateUnreadCount()});w.on(l.DISPLAYNAME_UPDATED,this._updateTabLabel,this)}return w},_delegateAddRequest:function(){var e=this,t,i;if(!e._addReqs||!e._addReqs.length){return}else if(e._addReqs.length>1){e._addRequestView()}else{i=e._addReqs[0];t=this.addConversation(i.user,i.network,i.alias);if(t){t.showAuthorizationILN(i.msg)}}e._addReqs=[]},_addRequestView:function(){var t=this,i=f,n=e.Messenger.View.AddRequestView,o=e.Messenger.Model.Session,a=t.conversationViews[i];if(!a){a=new n({parent:t.listNode,container:"<li class='mim-conversations-conversation hidden'></li>",addRequests:t._addReqs,limitToViewport:false,session:o});t.conversationViews[i]=a;a.render();t._addConversationTab(f,s.str_conv_add_requests);t._updateTabBadge(i);if(!t.visibleConvID){t._showExistingConversationView(a)}t._updateUnreadCount();a.on("change:unreadCount",function(e){t._updateTabBadge(e.getId());t._updateUnreadCount()});a.on("openConversation",function(e){if(e.contact){t.showConversation(e.contact.get("user"),e.contact.get("network"),e.contact.get("alias"))}});a.on("destroy",function(){t._conversationViewDestroyed(i)},t)}},_newConversation:function(t){var i=this,n=e.Messenger.Model.Session,o=e.Messenger.View.NewConversationView,s,a;t=t||"im";s=c;a=i.conversationViews[s];if(!a){a=new o({parent:i.listNode,container:"<li class='mim-conversations-conversation hidden'></li>",collection:e.Messenger.Model.ContactList.getInstance(),limitToViewport:false,conversationWindow:i,floaty:i.options.floaty,session:n,mode:t});i.conversationViews[s]=a;a.on("escKeyDown",function(){var t=e.Object.size(i.conversationViews);if(t===1){i.close()}else{i.togglePrevConv()}});a.render();a.on("destroy",function(){i._conversationViewDestroyed(s)},i)}else{a.set("mode",t)}return a},togglePrevConv:function(){this._toggleConv("prev")},toggleNextConv:function(){this._toggleConv("next")},_toggleConv:function(e){var t=_.keys(this.conversationViews),i=this.visibleConvID,n=_.indexOf(t,i),o,s;if(e==="prev"){o=n>0?n-1:n=t.length-1}else{o=n>t.length-2?n=0:n+1}s=this.conversationViews[t[o]];this._showExistingConversationView(s)},_addConversationTab:function(t,o,a){var r=this._addButton?2:1,d=e.Node.create(i.conversationtab({convId:t,displayTitle:o===a||t===f?o:n.substitute(s.str_session_title_order,{displayName:o,user:a}),displayName:o}));r=this.options.floaty?1:this.tabNode.all("li").size()-(this._addButton?2:1);this.tabNode.insert(d,r);this._checkTabOverflow()},_removeConversationTab:function(e){var t=this.tabNode.one('[data-id="'+e+'"]');if(t){t.remove()}this._checkTabOverflow()},_makeConversationTabVisible:function(e){if(!e){e=this.tabNode.one('[data-id="'+this.visibleConvID+'"]')}if(e&&e.hasClass("mim-overflowing")){e.removeClass("mim-overflowing");this.tabNode.removeChild(e);this.tabNode.insert(e,this.options.floaty?1:0)}},_switchConversationTab:function(e,t){var i=this.tabNode.one(".active"),n=this.tabNode.one('[data-id="'+e+'"]');if(i){i.removeClass("active");i.removeClass("tt-active-tab-bg");i.removeClass("mim-has-msg");i.addClass("tt-inactive-tab-bg")}if(n){n.addClass("active");n.addClass("tt-active-tab-bg");n.removeClass("tt-inactive-tab-bg");n.removeClass("mim-has-unread");this._makeConversationTabVisible(n)}if(!t){this._checkTabOverflow()}this._updateOverflowTabBadge()},_updateTabBadge:function(e){var t=this.conversationViews[e],i=this.tabNode.one('[data-id="'+e+'"]'),n=t.get("unreadCount");if(n){i.one(".mim-msg-badge").setHTML(n);i.addClass("mim-has-msg")}else{i.removeClass("mim-has-msg")}this._updateOverflowTabBadge()},_updateTabLabel:function(e,t){var i=this.tabNode.one('[data-id="'+e+'"]'),n;if(i){n=i.one(".mim-contact-name");n.setAttribute("title",t);n.setHTML(t);this._checkTabOverflow()}},_updateOverflowTabBadge:function(){var e=this.tabNode.all(".mim-overflowing.mim-has-msg .mim-msg-badge"),t,i=0;e.each(function(e){t=~~e.getHTML();if(typeof t==="number"){i+=t}});if(i>0){this._overflowButton.one(".mim-msg-badge").setHTML(i);this._overflowButton.addClass("mim-has-msg")}else{this._overflowButton.removeClass("mim-has-msg")}},_checkTabOverflow:function(){var e=this.tabNode.all(".mim-conv-tab"),t=e.size(),i=80,n,o,s=0,a,r,d=this.node.get("offsetWidth");if(this._addButton){d-=this._addButton.get("offsetWidth")}e.setStyle("width","auto");this.tabNode.removeClass("mim-has-overflow");this.tabNode.all(".mim-overflowing").removeClass("mim-overflowing");if(d===0){return}a=e.get("offsetWidth");if(!a||a.length===0){return}s=_.reduce(a,function(e,t){return e+t});if(s<=d){}else if(t*i<=d){s=i*t;r=~~((d-s)/a.length);e.setStyle("width",i+r+"px")}else{this.tabNode.addClass("mim-has-overflow");d-=this._overflowButton.get("offsetWidth");o=~~(d/i);n=e.slice(0,o);n.removeClass("mim-overflowing");e.slice(o,t).addClass("mim-overflowing");s=i*o;r=~~((d-s)/o);n.setStyle("width",i+r+"px")}},addConversation:function(e,t,i){var n=this._addConversation(e,t,i);if(!this.visibleConvID){this._showExistingConversationView(n)}return n},showConversation:function(t,i,n,o,s){var a=this,r=e.Messenger.Model.Session;r.login(null,function(){var e=a._addConversation(t,i,n,o,s);a._showExistingConversationView(e);a.maximize()})},showNewConversation:function(t){var i=this,n=e.Messenger.Model.Session;n.login(null,function(){var e=i._newConversation(t);i._showExistingConversationView(e);i.maximize()})},_showExistingConversationView:function(e){var t=e.getId();var i=this.visibleConvID&&this.conversationViews[this.visibleConvID];if(i){i.hide()}if(!this.get("minimized")){e.show();e._timeShown=new Date}this._switchConversationTab(t);this.visibleConvID=t;if(!this.isVisible()&&!this.get("minimized")){this.show()}},_conversationViewDestroyed:function(e){this._removeConversationTab(e);delete this.conversationViews[e];if(e===this.visibleConvID){this.visibleConvID=null}this._updateUnreadCount();this._showPriorConversation()},_showPriorConversation:function(){var e;var t=this.visibleConvID!=="new";_.each(this.conversationViews,function(i){if(i.getId()!=="new"){t=false}if(!e||i._timeShown>e._timeShown){e=i}});if(e&&!t){this._showExistingConversationView(e)}else if(this.options.floaty){this._handleNewTab()}else{this.visibleConvID=null;this.minimize()}},_processMessage:function(e){var t=e.fromSelf?e.receiver:e.sender,i=e.network,o=e.fromSelf?e.sender:e.receiver,s=n.getConversationId(o,t,i),a=this.conversationViews[s];if(!a){this.addConversation(t,i,o)}else{a.renderMessage(e)}this._updateTabBadge(s)},_processTypingNotification:function(e){var t=e.get("id"),i=this.conversationViews[t];i.setTypingNotification(e.get("userTyping"))},_processAddRequest:function(e){this.addConversation(e.get("user"),e.get("network"),e.get("alias"))},handleAddRequest:function(t){d.stat("add");this._addReqs.push(t);window.setTimeout(e.bind(this._delegateAddRequest,this),1e3)},_closeConversationEventHandler:function(e,t){var i=e.currentTarget.ancestor("[data-id]"),n=i.getAttribute("data-id"),a=this.conversationViews[n],r=this;e.halt();if(a.get("unreadCount")&&!t){o.confirm({message:s.str_conv_tab_close_confirm,callback:function(){r._closeConversationEventHandler(e,true)}});return}a.close()},_handleTabSwitch:function(t){if(t.target.hasClass("btn-close-conversation")){return}var i=t.currentTarget,n=i.getAttribute("data-id"),s=this.conversationViews[n];this._showExistingConversationView(s);this._handleTabOverflow();e.later(0,null,function(){o.triggerAds("978500262")})},_handleTabOverflow:function(t){var i=this,n=e.UA.ie?document:window,o=this._overflowContainer,s=this._overflowButton,a;if(!o){this._overflowContainer=this.node.one(".mim-overflow-tabs");o=this._overflowContainer}if(t===undefined||!o.hasClass("hidden")){o.addClass("hidden");if(s){s.removeClass("mim-selected")}if(i._overflowMenuListener){i._overflowMenuListener.detach()}}else{a=i.tabNode.all("li.mim-overflowing");o.empty().removeClass("hidden");if(s){s.addClass("mim-selected")}a.each(function(e){o.append(e.cloneNode(true).removeClass("tt-inactive-tab-bg"))});o.removeClass("hidden");e.later(0,null,function(){i._overflowMenuListener=e.on("click",function(e){if(!e.target.ancestor(".mim-menu.mim-overflow-tabs",true)){i._handleTabOverflow()}},n)})}},_handlePresenceChange:function(e){if(e.get("presenceState")===a.STATE.OFFLINE){_.each(this.conversationViews,function(e){if(e.handleLogout){e.handleLogout()}})}else if(e.previous("presenceState")===a.STATE.OFFLINE||e.previous("presenceState")===a.STATE.PENDING){_.each(this.conversationViews,function(e){if(e.handleLogin){e.handleLogin()}})}},_handleNewTab:function(){d.stat("window_plus");this.showNewConversation()},_handleNewMsgNotification:function(t){var i=e.one(".nav-item-messenger");if(i){o.showNewMsgNotification(t,i)}},_handleConvMinMax:function(t){var i=e.one(".nav-item-messenger");if(i){o.handleConvMinMax(t,i)}},events:{'click [data-action="closeconversations"]':"close",'keydown [data-action="closeconversations"]':"close",'click [data-action="hideconversations"]':"minimize",'keydown [data-action="hideconversations"]':"minimize",'click [data-action="closeconversation"]':"_closeConversationEventHandler","click li.mim-conv-tab":"_handleTabSwitch","click li.mim-overflow-tab":"_handleTabOverflow","click li.mim-new-tab":"_handleNewTab"}});e.namespace("Messenger.View").ConversationListView=t},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-dialogview","messenger-utils","messenger-viewutils","messenger-conversationview","messenger-newconversationview","messenger-conversationlist","messenger-conversationlist-css","messenger-addrequestview","tictac-mim-strings","messenger-session","transition","messenger-usersettings","messenger-stats","messenger-contactlist","messenger-abutils","messenger-systemsettings","messenger-constants"]});YUI.add("messenger-ssp",function(e){"use strict";var r={SSP_SET:{method:"PUT",path:"/v1/preferences"},SSP_GET:{method:"GET",path:"/v1/preferences"}},s={mimEnableSSA:"server.archive.enable"},t={},n=e.Tictac.mim.strings;e.Messenger.Common.SSPUserPreferences=function(){return{_dirtyPrefs:{},async:true,get:function(n,i){var a=r.SSP_GET,c=["pref="+s[n]||n];if(!t[n]){t[n]=true;e.Messenger.Common.RequestManager.issueRequest({type:"SSP_GET",server:"ssp",args:c,retries:5,method:a.method,path:a.path,successCallback:function(e){var r=e&&e.preferences?e.preferences[0].preference.value[0]:null;if(r==="1"){r=true}else if(r==="0"){r=false}i(r);delete t[n]},errorCallback:function(){delete t[n]}})}},set:function(e,r){this._dirtyPrefs[e]=r},save:function(t){var i={preferences:[]},a={preference:{}},c=r.SSP_SET;if(!_.isEmpty(this._dirtyPrefs)){e.each(this._dirtyPrefs,function(e,r){if(e===true){e="1"}else if(e===false){e="0"}a.preference.key=s[r]||r;a.preference.value=[];a.preference.value.push(e)});i.preferences.push(a);this._dirtyPrefs={};e.Messenger.Common.RequestManager.issueRequest({type:"SSP_SET",server:"ssp",postBody:i,retries:5,method:c.method,path:c.path,successCallback:function(){t()},failureCallback:function(){t(n.str_msgr_server_error_1)}})}else{t()}}}}()},"@VERSION@",{requires:["messenger-requestmanager","tictac-mim-strings"]});yui.add("messenger-common-omutils",function(e){"use strict";e.namespace("Messenger.Common").OMUtils=function(){var n={lastActive:{newpref:"mimLastActiveState"},mpopSignOutType:{newpref:"mimLogoutPref"},blockNonContacts:{newpref:"mimBlockNonContacts"},useTopContacts:{newpref:"mimUseTopContacts"},ssaNotificationSeen:{newpref:"mimSSANotificationSeen"},enableSounds:{newpref:"mimEnableSounds"},hideAddressBookContacts:{newpref:"mimShowOnlyBuddies"},homeCountry:{newpref:"mimHomeCountryPref"},mimContactScoringData:{newpref:"mimContactScoringData"},expandGroups:{},showModeTray:{},contactListImageSize:{},showOfflineContacts:{},convWindowStyle:{},conversationStyle:{}};return{fetchAllKeys:function(t){var o=[],a=["wssid="+NeoConfig.wssid,"appid=YahooMailNeoOM","r="+ +new Date],i=this,r;e.Array.each(e.Object.keys(n),function(e){o.push("_APP_"+e)});r={method:"GetExtensionData",params:[{query:{key:o,extensionId:"3cp9lcoq32dpn",instanceId:"000000000001h"},maxReturn:20,offset:0}],id:"123456789"};e.io("/ws/mailPreferences/v1/jsonrpc?"+a.join("&"),{method:"POST",data:e.JSON.stringify(r),headers:{"Content-Type":"multipart/form-data"},context:i,on:{success:function(n,o){var a;if(o.responseText){a=e.JSON.parse(o.responseText)}t.success(i._parseAndMapGED(a))},failure:function(e,n){t.failure(n)}}})},_parseAndMapGED:function(t){var o={},a;if(typeof t.error!=="undefined"&&t.error!==null){return null}e.Array.each(t.result.data,function(e){a=n[e.key.replace("_APP_","")];if(typeof a!=="undefined"&&typeof a.newpref!=="undefined"&&e.value!==""){o[a.newpref]=e.value}});return o}}}()},"1.0.0",{requires:["io-base"]});YUI.add("tictac-base-ywa",function(a){function c(c){var d=this;d.callbacksWhileLoading=[],d.cfg=a.merge(b,c)}var b={name:"tictac",sourceUrl:window.location.protocol==="https:"?"https://s.yimg.com/mi/ono/ywa.js":"http://d.yimg.com/mi/ono/ywa.js",server:"ONO",appId:"",isSampled:!0,actionEnums:{invoke:1,unknown:50},customFieldEnums:{action:17,bucket:28}};c.prototype={doCallbacks:function(){var a=this,b=a.callbacksWhileLoading.length,c;for(c=0;c<b;c++)a.callbacksWhileLoading[c]()},load:function(a){var b=this;if(window.YWA)a&&a();else{b.callbacksWhileLoading.push(a);if(b.callbacksWhileLoading.length<=1){var c=document.createElement("script");c.type="text/javascript",c.readyState?c.onreadystatechange=function(){if(c.readyState==="loaded"||c.readyState==="complete")c.onreadystatechange=null,b.doCallbacks&&b.doCallbacks()}:c.onload=function(){b.doCallbacks&&b.doCallbacks()},c.src=b.cfg.sourceUrl,document.getElementsByTagName("head")[0].appendChild(c)}}},submit:function(a,b){var c=this,d=c.cfg.actionEnums,e=c.cfg.customFieldEnums,f=c.cfg.appId,g=d&&d[a],h,i=!0,j;if(!c.YWATracker)try{c.YWATracker=window.YWA.getTracker(f,c.cfg.server),c.YWATracker.setDocumentName("Tictac for "+c.cfg.name),c.YWATracker.setDocumentGroup("Tictac for "+c.cfg.name),i=!0}catch(k){}try{g||(g=d&&d.unknown);if(!!f&&!!g){c.YWATracker.setAction(g);for(j in b)b.hasOwnProperty(j)&&(h=e&&e[j],h&&c.YWATracker.setCF(h,""+b[j]));c.YWATracker.setCF("17",a),c.YWATracker.setCF("28",NeoConfig.expBucketId),i?c.YWATracker.submit():c.YWATracker.submit_action()}}catch(k){}},stat:function(a,b){var c=this;c.cfg.isSampled&&c.load(function(){c.submit(a,b)})}},a.namespace("Tictac.base").Ywa=c},"1.0.0",{requires:[]});YUI.add("tictac-base-stats",function(a){function c(b){var c=b.ywa?b.ywa:b;b.name=b.name?b.name:c.name,c.name=c.name?c.name:b.name,this.cfg=b,this.ywa=new a.Tictac.base.Ywa(c)}var b=3;c.prototype={stat:function(c,d){var e=this.cfg,f;if(!e.ultActions||e.ultActions&&e.ultActions[c])!window.console||!window.console.log,this.ultStat(c,d);e.ymma&&e.ymma[c]&&(d&&(f=[],a.Object.each(d,function(a,c){f.length<b&&f.push(c+"=>"+a)}),f=f.join(",")),!window.console||!window.console.log,yui.common.Utils.ymmastats.stat(e.name+"_"+c,f));if(!e.ywa||e.ywa&&e.ywa.actionEnums[c])!window.console||!window.console.log,this.ywa.stat(c,d)},ultStat:function(b,c){var d=this.cfg.name+"_"+b,e,f=window.yui||a;for(e in c)if(e.length>8){c="";break}c?f.fire("mt:click",{action:d,append:c}):f.fire("mt:click",{action:d})}},a.namespace("Tictac.base").Stats=c},"1.0.0",{requires:["tictac-base-ywa","ymma-stats","json-stringify"]});YUI.add("messenger-contactscoring",function(e){"use strict";var t=e.Messenger.Common.Constants,s=t.EVENTS,o,n=e.Messenger.Model.ConversationList,r=e.Messenger.Model.UserSettings,c=e.Messenger.Model.SystemSettings,a=e.Messenger.Common.Utils,i="mimContactScoringData",S=5,l,d;d=e.Tictac.base.Model.extend({initialize:function(){var t=this;o=e.Messenger.Model.ContactList.getInstance();t.Events={CONVERSATION_INITIATED:"yim:convinitiated",MESSAGE_SEND_ERROR:"yim:msgerror",MESSAGE_RECEIVED:"yim:messagereceived",MESSAGE_SENT:"yim:messagesent",ADD_CONTACT_SENT:"yim:addcontactsent"};t.POINT_MAPPING={};t.POINT_MAPPING[t.Events.CONVERSATION_INITIATED]=1;t.POINT_MAPPING[t.Events.ADD_CONTACT_SENT]=2;t.POINT_MAPPING[t.Events.MESSAGE_SENT]=.5;t.POINT_MAPPING[t.Events.MESSAGE_RECEIVED]=.1;t.POINT_MAPPING["online"]=.005;t.SCORING_DATA={lastUpdated:null,mailScoreLastUpdated:null,contacts:[],includes:[],excludes:[]};t.MSGR_SCORE_TOTAL_CAP=15;t.MSGR_SCORE_NEW_CAP=25;t.MSGR_SCORE_NEW_CONTRIB=5;t.MAIL_SCORE_CONTRIB=5;t.DECAY_MULTIPLIER=.99;t.DECAY_INTERVAL=1*24*3600*1e3;t.MAIL_SCORE_REFRESH_INTERVAL=30*24*3600*1e3;t.MSGR_SCORE_FAVORITE=1e5;t.TOP_CONTACT_MIN_COUNT=10;t.TOP_CONTACT_MAX_COUNT=15;t.TOP_CONTACT_SCORE_CUTOFF=.5;t.PERSIST_INTERVAL=2*60*1e3;t.PERSIST_THRESHOLD=15;t._dirty=false;t._listeners=[];t._messengerScores={};t._topcontactOrder=[];t._scoresLoaded=false;t._maxSessionScore=0;t._topContacts=null;t._topContactMap={};t._activitySinceStore=0;t.startScoring()},startScoring:function(){var t=this;if(!t._scoresLoaded){t._loadScores()}n.on(s.MESSAGE,t._handleMessageEvent,t);n.on(s.CONVERSATION_INIT,t._handleNewConv,t);e.Messenger.GlobalEvents.on(s.ADD_REQUEST_SENT,t._handleAddRequest,t);o.on("remove",t._handleContactDeleted,t);o.on(s.AB_PARSING_COMPLETE,t._loadABData,t);if(!t._persistTimer){t._persistTimer=e.later(t.PERSIST_INTERVAL,t,t._persistScores,null,true)}},stopScoring:function(){var t=this;n.off(s.CONVERSATION_INITIATED,t._handleMessageEvent,t);n.off(s.CONVERSATION_INIT,t._handleNewConv,t);e.Messenger.GlobalEvents.off(s.ADD_REQUEST_SENT,t._handleAddRequest,t);o.off("remove",t._handleContactDeleted,t);o.off(s.AB_PARSING_COMPLETE,t._loadABData,t)},_loadScores:function(){var e=this,t;r.getPreference(i,function(s){var n,r,c,a,i,S,l,d;e._topContacts=[];t=s;if(t&&typeof t!=="object"){try{t=JSON.parse(t);e.SCORING_DATA=t}catch(E){}}n=(new Date).getTime();r=e.SCORING_DATA;r.includes=r.includes||[];r.excludes=r.excludes||[];c=n-r.lastUpdated;a=c>e.DECAY_INTERVAL?Math.pow(e.DECAY_MULTIPLIER,Math.floor(c/e.DECAY_INTERVAL)):1;for(S=0;S<r.contacts.length;S++){l=r.contacts[S];d=l.userId;i=l.msgr_score||0;i*=a;e._messengerScores[d]={};e._messengerScores[d].msgr_score=0;e._messengerScores[d].prev_msgr_score=i>0?i:0;e._messengerScores[d].mail_score=l.mail_score||0;e._topcontactOrder[d]=S}if(!e._loadABData()){e._populateTopContacts()}_.each(e._topContacts,function(e){var t=o.get(e.userId);t.set("topContact",true)})})},_loadABData:function(){var e=this,t=e.SCORING_DATA,s=(new Date).getTime(),n,r=0,c=1;if(!o.ABParsed||!t.mailScoreLastUpdated||s-t.mailScoreLastUpdated>e.MAIL_SCORE_REFRESH_INTERVAL){return false}n=o.where({type:"addressbook"});_.each(n,function(e){var t=e.get("mail_score")||0;if(t>r){r=t}});if(r>e.MAIL_SCORE_CONTRIB){c=e.MAIL_SCORE_CONTRIB/r}_.each(n,function(t){var s=t.get("id"),o=(t.get("mail_score")||0)*c;if(!e._messengerScores[s]){e._messengerScores[s]={};e._messengerScores[s].msgr_score=0;e._messengerScores[s].mail_score=o;e._messengerScores[s].prev_msgr_score=0}else{e._messengerScores[s].mail_score=o}});e._dirty=true;e._persistScores();return true},_handleMessageEvent:function(e){var t=this,s=e.fromSelf?t.Events.MESSAGE_SENT:t.Events.MESSAGE_RECEIVED,o;if(e.network!=="sms"){o=a.getUserId(e.fromSelf?e.receiver:e.sender,e.network);t._processActivityEvent(o,s)}},_handleNewConv:function(e){var t=this,s=a.getUserId(e.user,e.network);if(e.network!=="sms"){t._processActivityEvent(s,t.Events.CONVERSATION_INITIATED)}},_handleAddRequest:function(e){var t=this,s;if(e.network!=="sms"){s=a.getUserId(e.get("user"),e.get("network"));t._processActivityEvent(s,t.Events.ADD_CONTACT_SENT)}},_processActivityEvent:function(e,t){var s=this,n=o.get(e);if(t===s.Events.ADD_CONTACT_SENT||n&&n.get("type")!=="unknown"){s._dirty=true;if(!s._messengerScores[e]){s._messengerScores[e]={};s._messengerScores[e].msgr_score=0;s._messengerScores[e].mail_score=0;s._messengerScores[e].prev_msgr_score=0}if(s._messengerScores[e].msgr_score<s.MSGR_SCORE_NEW_CAP){s._messengerScores[e].msgr_score+=s.POINT_MAPPING[t];if(s._messengerScores[e].msgr_score>s._maxSessionScore){s._maxSessionScore=s._messengerScores[e].msgr_score}s._activitySinceStore+=s.POINT_MAPPING[t];if(s._activitySinceStore>s.PERSIST_THRESHOLD){s._persistScores(true)}}}},markFavorite:function(e,t){var s=this,o=e.get("id"),n=s.SCORING_DATA;if(t){if(!_.contains(n.includes,o)){n.includes.push(o)}n.excludes=_.without(n.excludes,o)}else{if(!_.contains(n.excludes,o)){n.excludes.push(o)}n.includes=_.without(n.includes,o);s._handleContactDeleted(e);e.set("topContact",false)}s._dirty=true;s._persistScores()},_handleContactDeleted:function(t){var s=this,o,n,r,c,_=t.get("id"),a=s.SCORING_DATA.contacts,i=false;if(s._topContacts){for(o=0,r=s._topContacts.length;o<r;o++){c=s._topContacts[o];if(c.userId===_){delete s._topContactMap[c.userId];s._topContacts.splice(o,1);if(a[o]&&a[o].userId===_){a.splice(o,1)}else{for(n=0;n<a.length;n++){if(a[n].userId===_){a.splice(n,1);break}}}i=true;break}}}if(s._messengerScores[_]){delete s._messengerScores[_]}if(i){s._dirty=true;e.later(0,s,s._persistScores)}},_persistScores:function(e){var s=this,n,c,_,a,S,l,d,E,C=false,u=0;if(s._dirty){S=s._maxSessionScore;n=s.SCORING_DATA;n.contacts=[];if(e){s._skip=true}else if(s._skip){s._skip=false;return}s._activitySinceStore=0;o.each(function(e){if(C&&e.get("type")==="addressbook"){return}if(e.get("presenceState")!==t.STATE.OFFLINE){s._processActivityEvent(e.get("id"),"online")}});d=S>s.MSGR_SCORE_NEW_CONTRIB?s.MSGR_SCORE_NEW_CONTRIB/S:1;for(c in s._messengerScores){if(s._messengerScores.hasOwnProperty(c)){_=s._messengerScores[c];E=d*_.msgr_score+_.prev_msgr_score;a=s._topcontactOrder[c];n.contacts.push({userId:c,msgr_score:E,mail_score:_.mail_score,prev_msgr_score:_.prev_msgr_score,position:a});if(E>u){u=E}}}d=u>s.MSGR_SCORE_TOTAL_CAP?s.MSGR_SCORE_TOTAL_CAP/u:1;for(l=0;l<n.contacts.length;l++){n.contacts[l].msgr_score*=d;n.contacts[l].score=n.contacts[l].msgr_score+n.contacts[l].mail_score}n.contacts.sort(s._stableContactSortFunc);for(l=0;l<n.contacts.length;l++){s._topcontactOrder[n.contacts[l].userId]=l;delete n.contacts[l]["position"]}if(n.contacts.length>50){n.contacts.splice(50)}s._populateTopContacts();s.trigger("topcontactsready");n.lastUpdated=(new Date).getTime();r.setPreference(i,JSON.stringify(n));r.save();s._dirty=false}},getTopContacts:function(){return this._topContacts||[]},_populateTopContacts:function(){var e=this,t,s,n,r;s=e.SCORING_DATA;e._topContacts=[];e._topContactMap={};_.each(s.includes,function(t){e._topContactMap[t]=true;e._topContacts.push({userId:t})});e._excludeMap={};_.each(s.excludes,function(t){e._excludeMap[t]=true});for(n=0;n<s.contacts.length&&e._topContacts.length<e.TOP_CONTACT_MAX_COUNT;n++){r=s.contacts[n].userId.split("~");if(r[1]==="facebook"){continue}t=o.getContact(r[0],r[1]);if(t&&!e._topContactMap[s.contacts[n].userId]&&!e._excludeMap[s.contacts[n].userId]&&s.contacts[n].score>=S){e._topContactMap[s.contacts[n].userId]=true;e._topContacts.push(s.contacts[n])}}_.each(o.where({topContact:true}),function(t){if(!e._topContactMap[t.get("id")]){t.set("topContact",false)}});_.each(e._topContacts,function(e){var t=e.userId.split("~"),s=o.getContact(t[0],t[1]);s.set("topContact",true)});if(s.contacts.length&&s.contacts[0].score>S){s.scoreThresholdReached=true;c.set("topContactsEnabled",true)}else if(s.includes.length||s.contacts.length>15){c.set("topContactsEnabled",true)}},_stableContactSortFunc:function(e,t){var s=e.score===undefined?0:e.score,o=t.score===undefined?0:t.score;if(s===o){return e.position-t.position}else{return o-s}}});e.namespace("Messenger").Model.ContactScoring=function(){if(!l){l=new d}return l}},"@VERSION@",{requires:["underscore","messenger-constants","messenger-utils","messenger-usersettings","messenger-contactlist","messenger-conversationlist","tictac-base-model","messenger-systemsettings"]});YUI.add("messenger-optionsview",function(e){"use strict";var t=e.Messenger.Model.UserSettings,n=e.Messenger.Model.SystemSettings,s=e.Messenger.Common.Constants,o=e.Messenger.Common.Stats,i=e.Tictac.mim.strings,r=e.Tictac.mim.rollups,c=e.Messenger.Common.Utils;e.namespace("Messenger.View").OptionsView=e.Tictac.base.View.extend({title:i.str_branding_messenger_generic,initialize:function(){this.on("show",this._onShow,this);this.on("hide",this._onHide,this);this._nodeListeners=[]},onDestroy:function(){while(this._nodeListeners.length){this._nodeListeners.pop().detach()}},createDOMNode:function(){var s=t.getPreference("mimLogoutPref"),o=n.get("smsEnabled"),c=e.Node.create(r.options({title:i.str_menu_messenger_options,showButtons:true,localSelected:s==="local"?true:false,globalSelected:s==="global"?true:false,promptSelected:s==="prompt"?true:false,enableSounds:t.getPreference("mimEnableSounds"),showOnlyBuddies:t.getPreference("mimShowOnlyBuddies"),smsEnabled:o,countries:o?e.Messenger.View.ViewUtils.getPhoneCountries():[]}));c.addClass("mim-options-view hidden");return c},postRender:function(){var e=this;e.node.one("#mim-addBlockedUserButton").on("click",e.showAddIgnoreDialog,e);e.node.one("#mim-removeBlockedUserButton").on("click",e.removeIgnoredUsers,e);e._nodeListeners.push(this.node.one("#mim-blockNonBuddies").on("change",function(t){e._setIgnoreListDisabledState(t.target.get("checked"))}));e._nodeListeners.push(this.node.one("#mim-blockSelected").on("change",function(t){e._setIgnoreListDisabledState(!t.target.get("checked"))}))},removeIgnoredUsers:function(){var t=this.node.one("#mim-blocklist").all("option"),n,s,o,i,r=e.Messenger.Model.ContactList.getInstance();t.each(function(e){if(e.get("selected")){n=e.getAttribute("value").split("~");s=n[0];o=n[1];i=r.getContact(s,o);i.unignoreUser();e.remove(true)}})},showAddIgnoreDialog:function(){var t=e.Messenger.View.ViewUtils,n=e.Messenger.Model.ContactList.getInstance(),s=this;t.confirm({callback:function(o){var r=o["mim-ignore-user"],d=o["mim-ignore-network"],l;if(!r){return i.str_conv_error_empty_general}else if(r.length<4||r.length>32){return c.substitute(i.str_cont_add_contact_error_invalid_id,{user:e.Escape.html(r),network:d})}l=n.getContact(r,d);l.ignoreUser({success:function(){s._populateIgnoreList()},err:function(e){if(l.get("type")==="unknown"){n.remove(l.id)}t.alert({message:t.convertErrorCodeToMessage(e.error.code)})}})},title:i.str_conv_btn_block_user,message:r.addignore()})},_onShow:function(){var n=e.Messenger.Model.Session,s=this;o.stat("options");s._populateIgnoreList();if(t.getPreference("mimBlockNonContacts")){s.node.one("#mim-blockNonBuddies").getDOMNode().checked=true;s._setIgnoreListDisabledState(true)}else{s.node.one("#mim-blockSelected").getDOMNode().checked=true;s._setIgnoreListDisabledState(false)}t.getPreference("mimEnableSSA",function(e){var t=s.node.one("#mim-enableSSACheckbox");t.removeAttribute("disabled");if(e){t.setAttribute("checked","checked")}else{t.removeAttribute("checked")}});n.on("change:presenceState",s._handlePresenceChange,s);e.later(0,null,function(){s._focusOnLogoutSelect()})},_focusOnLogoutSelect:function(){var e=this.node.one("#mim-logoutSelect");if(e){e.focus()}},_populateIgnoreList:function(){var t=e.Messenger.Model.ContactList.getInstance(),n=t.where({ignored:true}),s,o,i,r,d,l=this.node.one("#mim-blocklist"),a="<option value='{{id}}'>{{user}}</option>";l.setHTML("");for(s=0,o=n.length;s<o;s++){r=n[s].get("user");d=n[s].get("network");i=e.Node.create(c.substitute(a,{id:c.getUserId(r,d),user:r}));l.append(i)}},_onHide:function(){var t=e.Messenger.Model.Session;t.off("change:presenceState",this._handlePresenceChange,this)},_handlePresenceChange:function(e){this._setIgnoreListDisabledState(e.get("presenceState")===s.STATE.OFFLINE)},_setIgnoreListDisabledState:function(t){var n=this.node.one("#mim-blocklist"),o=this.node.all(".mim-options-ignore button"),i=this.node.one("#mim-offlineError"),r=e.Messenger.Model.Session,c=r.get("presenceState")===s.STATE.OFFLINE;t=t||c;if(t){n.setAttribute("disabled","disabled");o.setAttribute("disabled","disabled");if(c){i.removeClass("hidden")}}else{n.removeAttribute("disabled");o.removeAttribute("disabled");i.addClass("hidden")}},save:function(s){var i={},r=e.Messenger.Model.ContactList.getInstance(),c=this.node,d=c.one("#mim-showOnlyBuddiesCheckbox").get("checked");o.stat("options_save");i={mimLogoutPref:c.one("#mim-logoutSelect").get("value"),mimEnableSounds:c.one("#mim-enableSoundsCheckbox").get("checked"),mimShowOnlyBuddies:d,mimBlockNonContacts:c.one("#mim-blockNonBuddies").get("checked"),mimEnableSSA:c.one("#mim-enableSSACheckbox").get("checked")};if(n.get("smsEnabled")){i.mimHomeCountryPref=c.one("#mim-homeCountrySelect").get("value")}if(t.getPreference("mimShowOnlyBuddies")!==d){if(d){r.handleABPresence("unsubscribe")}else{r.handleABPresence("subscribe")}}t.setPreference(i);t.save();s()},focusOnPresenceMenu:function(t){if(t.keyCode===13){e.later(0,null,function(){e.Messenger.View.ViewUtils.focusOnPresenceStateMenu(t)})}},_handleKeyBlockNonBuddies:function(e){var t=this,n,s;if(e.keyCode===40){n=t.node.one("#mim-blockSelected");if(n&&n.get("checked")!==undefined){n.set("checked","true");n.focus()}e.halt()}else if(e.keyCode===38){s=t.node.one("#mim-showOnlyBuddiesCheckbox");if(s&&s.focus){s.focus()}e.halt()}},_handleKeyBlockSelected:function(e){var t=this,n,s;if(e.keyCode===38){n=t.node.one("#mim-blockNonBuddies");if(n&&n.get("checked")!==undefined){n.set("checked","true");n.focus()}e.halt()}else if(e.keyCode===40){s=t.node.one("#mim-blocklist");if(s&&s.focus){s.focus()}e.halt()}},_focusOnFirstEntryInBlockList:function(e){var t=e.currentTarget.one("option");if(t&&t.get("selected")!==undefined){t.set("selected","true");t.focus()}},_stopEventPropagation:function(e){e.stopPropagation()},_handleKeyCancel:function(t){if(t.keyCode===9){this._focusOnLogoutSelect();t.halt()}else if(t.keyCode===13){e.later(0,null,function(){e.Messenger.View.ViewUtils.focusOnPresenceStateMenu(t)})}},events:{"keydown .mim-button-ok":"focusOnPresenceMenu","keydown #mim-blockNonBuddies":"_handleKeyBlockNonBuddies","keydown #mim-blockSelected":"_handleKeyBlockSelected","focus #mim-blocklist":"_focusOnFirstEntryInBlockList","keydown .mim-options-list":"_stopEventPropagation","keydown .mim-button-cancel>a":"_handleKeyCancel"}})},"@VERSION@",{requires:["tictac-mim-rollups","tictac-base-view","tictac-mim-strings","messenger-options-css","messenger-utils","messenger-contactlist","messenger-constants","messenger-session","messenger-viewutils","messenger-usersettings","messenger-systemsettings"]});YUI.add("messenger-presenceplugin",function(e){"use strict";var t=e.Messenger.Common.Constants,s=e.Messenger.Common.Utils,n=e.Messenger.View.NewConversationView,i=e.Messenger.View.ContactListView,o=e.Messenger.Model.SystemSettings,a=e.Messenger.Model.UserSettings,r=e.Messenger.View.ViewUtils,c=e.Messenger.Common.Stats,l=e.Tictac.mim.rollups,u=e.Tictac.mim.strings,m;m={initialize:function(t){this.host=t;t.presencePlugin=this;t.togglePresenceMenu=e.bind(this.togglePresenceMenu,this);t.events["click button.mim-presence-state"]="togglePresenceMenu"},setPresenceState:function(s){var n=this,i=n.host,o=s.currentTarget.ancestor("li",true),m=o.getAttribute("data-action"),g,f,d,p,h=i.options.session,b=h.get("presenceState"),w=e.Messenger.Neo.yui,P=h.get("mpopInfo").totalEndpoints===1?"local":a.getPreference("mimLogoutPref");switch(m){case"setState":d=+o.getAttribute("data-state");if(b!==d||h.get("presenceMessage")){if(d===t.STATE.OFFLINE){if(P==="prompt"){n._handleLogoutPrompt()}else{c.stat("status_signout");c.stat("toggle",{ltxt:"signout"});h.logout(P);r.flashWindow(false);a.setPreference("cg.pref.im.loginpref",d);a.save()}}else{switch(d){case t.STATE.AVAILABLE:c.stat("status_available");break;case t.STATE.INVISIBLE:c.stat("status_invisible");break;default:c.stat("status_busy");break}h.setPresence(d,"");a.setPreference("cg.pref.im.loginpref",d);a.save();n.flashWindowUnreadMessages()}}break;case"setStateCustom":c.stat("status_custom_old");g=+o.getAttribute("data-state");f=o.getAttribute("data-message");h.setPresence(g,f);a.setPreference("cg.pref.im.loginpref",g);a.save();n.flashWindowUnreadMessages();break;case"newCustomStatus":r.confirm({message:l.custom_status_dialog(),title:u.str_custom_status_title,callback:function(e){var s=e["mim-custom-busy"]?t.STATE.BUSY:t.STATE.AVAILABLE,i=e["mim-custom-status-input"],o=a.getPreference("mimCustomPresenceArr")||[],r=false;if(!i){return u.str_conv_error_empty_general}_.each(o,function(e){if(e.state===s&&e.message===i){r=true}});if(!r){o.push({state:s,message:i});if(o.length>4){o.shift()}a.setPreference("mimCustomPresenceArr",o)}c.stat("status_custom_new");h.setPresence(s,i);a.setPreference("cg.pref.im.loginpref",s);a.save();n.flashWindowUnreadMessages()}});e.one("#mim-custom-status-input").focus();break;case"history":w.fire("search:input",{customTitle:{noLabel:true,value:u.str_opt_msg_general_heading_history},query:{fnums:[8]}});break;case"messengeroptions":window.yui.fire("openOptions",{view:"messenger"})}if(o.hasClass("mim-contacts-filter")){p=o.getAttribute("data-action");if(p==="topContacts"){c.stat("contactlist_top")}else{c.stat("contactlist_online")}a.setPreference("mimUseTopContacts",p==="topContacts");a.save()}n.togglePresenceMenu();if(s&&(!s.clientX&&!s.clientY)){r.focusOnPresenceStateMenu(s)}},_handleLogoutPrompt:function(){var e=this.host,s=e.options.session;r.confirm({title:u.str_opt_msg_general_heading_logout,cssClass:"mim-logout-options-dialog",message:l.logout_options(),callback:function(e){var n=e["mim-logoutType"];c.stat("status_signout");c.stat("toggle",{ltxt:"signout"});if(e["mim-rememberLogoutPref"]==="on"){a.setPreference("mimLogoutPref",n)}s.logout(n);r.flashWindow(false);a.setPreference("cg.pref.im.loginpref",t.STATE.OFFLINE);a.save()}})},updateContactListState:function(e){var t=this,n=t.host,i=e.get("presenceState"),o=s.normalizePresenceMessage(e.get("presenceMessage"))||r.getDefaultPresenceMessage(i),a,c,l;a=r.getStateName(i);n.node.one("#mim-cl-view").setAttribute("data-state",a);if(o){c=n.node.all("button.mim-presence-state");c.addClass("s-tp");l=n.node.one("button.mim-presence-state .mim-presence-message");l.setHTML(o);c.setAttribute("title",l.get("text"))}},flashWindowUnreadMessages:function(){var e=this.host.options.conversationWindow.get("unreadCount");if(e===1){r.flashWindow(u.str_unread_messages_single);return u.str_unread_messages_single}else if(e>1){var t=s.substitute(u.str_unread_messages_plural,{count:e});r.flashWindow(t);return t}else{return 0}},_handleKeyPresenceMenuItems:function(e){var t=e.currentTarget.ancestor("li.mim-menu-item",true),s=t.previous("li.mim-menu-item"),n=t.next("li.mim-menu-item");if(e.keyCode===38){if(s!==null){s.one("a").focus()}else{t.ancestor("ul#mim-presence-menu").one("> li.mim-menu-item:last-of-type a").focus()}e.halt()}else if(e.keyCode===40){if(n!==null){n.one("a").focus()}else{t.ancestor("ul#mim-presence-menu").one("> li.mim-menu-item a").focus()}e.halt()}else if(e.keyCode===27){this.togglePresenceMenu();r.focusOnPresenceStateMenu(e)}},togglePresenceMenu:function(t){var s=e.one("#mim-presence-menu"),n=this,i=n.host,c,u,m,g,f,d,p,h=i.options.session,_,b=o.get("topContactsEnabled")&&!this.embedded,w;if(!s){f=h.get("presenceState");d=h.get("presenceMessage");s=e.Node.create(l.presence_menu({customPresenceArr:a.getPreference("mimCustomPresenceArr")||[],isOnline:h.isOnline(),hasTopContacts:b}));e.one(document.body).append(s);c=t?t.target.ancestor("button.mim-presence-state",true):i.node.one("button.mim-presence-state");u=c.get("region");m=u.bottom-document.body.scrollTop;g=u.left;s.setStyle("left","-1000px");if(m+s.get("offsetHeight")>document.body.offsetHeight){m=document.body.offsetHeight-s.get("offsetHeight");g=u.right}s.setStyle("top",m);if(o.get("isRTL")){s.setStyle("left","auto");s.setStyle("right",r.getWindowSize().width-u.right)}else{s.setStyle("left",g)}e.later(0,null,function(){if(e.one("#mim-presence-menu")){i._menuHideListener=e.once("mousedown",function(e){if(!e.target.ancestor("#mim-presence-menu",true)){n.togglePresenceMenu()}},e.UA.ie?document:window)}});if(e.one("body").hasClass("fullpage")){w=e.UA.ie?document:window}else{w=e.one("#shellnavigation")}i._scrollHandler=e.once("scroll",function(){n.togglePresenceMenu()},w);if(!d){p=s.one('li[data-state="'+f+'"]');if(p){p.addClass("checked")}}else{s.all('li[data-state="'+f+'"]').each(function(e){if(e.getAttribute("data-message")===d){e.addClass("checked")}})}s.all(".mim-contacts-filter").removeClass("checked");if(a.getPreference("mimUseTopContacts")===true){_="li[data-action='topContacts']"}else{_="li[data-action='onlineContacts']"}if(_&&b){s.one(_).addClass("checked")}r.limitToViewport(s);i._menuListener=s.delegate("click",e.bind(this.setPresenceState,this),"li.mim-menu-item");s.delegate("keydown",e.bind(this._handleKeyPresenceMenuItems,this),"li.mim-menu-item")}else{if(i._menuListener){i._menuListener.detach();i._menuListener=null}if(i._scrollHandler){i._scrollHandler.detach();i._scrollHandler=null}s.remove(true);if(i._menuHideListener){i._menuHideListener.detach();i._menuHideListener=null}}return false}};e.Messenger.View.PresencePlugin=m;if(typeof window.NeoConfig!=="undefined"&&window.NeoConfig.nav){m.embedded=true;n.plugins=n.plugins||[];n.plugins.push(m)}else{i.plugins=i.plugins||[];i.plugins.push(m)}},"1.0.0",{requires:["messenger-newconversationview","messenger-contactlist-view","messenger-contactlist-css","tictac-mim-rollups","tictac-base-view","messenger-constants","messenger-conversation","tictac-mim-strings","messenger-usersettings","messenger-viewutils","messenger-utils","messenger-stats","messenger-systemsettings","event-hover","messenger-base-css","escape"]});YUI.add("messenger-contactplugin",function(e){"use strict";var t=e.Messenger.Common.Constants,s=e.Messenger.Common.Utils,i=e.Messenger.View.NewConversationView,n=e.Messenger.View.ContactListView,o=e.Messenger.Model.SystemSettings,a=t.EVENTS,r=e.Messenger.View.ViewUtils,c=e.Messenger.Common.SMSUtils,l=e.Messenger.Common.Stats,m=e.Tictac.mim.rollups,g=e.Tictac.mim.strings,d;d={initialize:function(e){this.host=e;e.contactPlugin=this},showContactMenu:function(t){var i=this,n=i.host,a=t.contact,c=a.get("email"),d=!!c,u=window.strings&&window.strings.str_cfg_tog_hasSMS&&a.get("mobileno"),_=a.get("presenceMessage"),h=!!_,f,v,p,b=t.item.get("region"),w,C;l.stat("right_click",{option:"menu"});w=e.one("#mim-contact-menu");if(w){w.remove()}f=m.contact_menu({id:t.id,presenceMessage:_,user:a.get("user"),email:c,hasEmail:d,hasSMS:u,hasMessage:h,hasFavorites:t.favorites,isFavorite:a.get("topContact"),isBuddy:a.get("type")==="buddy",appearOfflineMsg:s.substitute(g.str_menu_appear_offline,{contact_name:a.get("displayName")}),appearOnlineMsg:s.substitute(g.str_menu_appear_online,{contact_name:a.get("displayName")}),onInvisibleList:a.get("isInvisible"),onVisibleList:a.get("isVisible"),isInvisible:n.options.session.isInvisible()});v=e.Node.create(f);e.one(document.body).append(v);v.removeClass("hidden");C=b.top+b.height/2-v.get("offsetHeight")/2-document.body.scrollTop;if(o.get("isRTL")){v.setStyle("right",t.leftPos+"px")}else{v.setStyle("left",t.leftPos+"px")}v.setStyle("top",C+"px");n._menuHideListener=e.on("mousedown",function(e){if(!e.target.ancestor("#mim-contact-menu")){i._hideContactMenu()}},e.UA.ie?document:window);if(t.hover){n._menuLeaveListener=v.on("mouseleave",e.bind(i._hideContactMenu,i))}n._menuEnterListener=v.on("mouseenter",e.bind(i._hoverContactMenuEnter,i));if(e.one("body").hasClass("fullpage")){p=e.UA.ie?document:window}else{p=e.one("#shellnavigation")}n._showContactScrollHandler=e.once("scroll",function(){i._hideContactMenu()},p);v.delegate("click",i._contactMenuClicked,"li[data-action]",i);r.limitToViewport(v)},_contactMenuClicked:function(t){var i=this,n=i.host,o=t.currentTarget,d=o.getAttribute("data-action"),u=o.ancestor("#mim-contact-menu"),h=u.getAttribute("data-id"),f=e.Messenger.View.ConversationListView.convListView,v=n.collection.get(h),p=v.get("user"),b=v.get("network"),w=n.options.session.get("loggedInId"),C=e.Messenger.Model.ContactScoring(),M=g.str_session_display_name_order.indexOf("{{lastName}}")===0;switch(d){case"im":l.stat("im",{type:"right_click"});l.stat("frnd");f.showConversation(p,b,w);break;case"sms":l.stat("sms",{type:"right_click"});f.showConversation(p,b,w,"sms");break;case"email":l.stat("email",{type:"right_click"});var k={cbfn:function(e){var t=e.get("header");t.to=[{name:v.get("displayName"),email:v.get("email")}];e.set("header",t)}};yui.fire("newMessage",k);break;case"edit":l.stat("right_click",{option:"edit"});r.confirm({title:g.str_cont_edit_cont,message:m.addcontact({user:p,lastNameFirst:M,isIE:!!e.UA.ie,firstName:v.get("firstName"),lastName:v.get("lastName"),email:v.get("email"),mobileno:v.get("mobileno")}),callback:function(t){var s={},i;s.id=v.get("addressbookId");i=r.validateContactForm(t);if(i){return i}_.each(t,function(e,t){s[t.toLowerCase()]=e});return v.editContact({user:p,network:b,addressbook:s,success:function(){var i=e.Messenger.Neo.yui;i.fire(a.CONTACTS_UPDATED,[{addressbookId:s.id,addressbook:s}]);v.set(t);v.set("normalizedNumber",c.normalizeNumber(t.mobileno))}})}});break;case"delete":l.stat("right_click",{option:"delete"});r.confirm({message:s.substitute(g.str_del_contact_msg_messenger_desc,{contact_highlighted:v.get("displayName")}),title:g.str_del_contact_msg_header,callback:function(){n.collection.deleteContact(h)}});break;case"favorite":l.stat("right_click",{option:"favorite"});C.markFavorite(v,true);break;case"unfavorite":l.stat("right_click",{option:"unfavorite"});C.markFavorite(v,false);break;case"visibility":if(n.options.session.isInvisible()){if(!v.get("isVisible")){l.stat("right_click",{option:"add_to_visible"});v.addToVisibleList()}else{l.stat("right_click",{option:"remove_from_visible"});v.removeFromVisibleList()}}else{if(!v.get("isInvisible")){l.stat("right_click",{option:"add_to_invisible"});v.addToInvisibleList()}else{l.stat("right_click",{option:"remove_from_invisible"});v.removeFromInvisibleList()}}break}i._hideContactMenu()},_hideContactMenu:function(){var t=e.one("#mim-contact-menu"),s=this,i=s.host;if(t){t.remove(true);this._contactMenuFocused=false;if(i._menuHideListener){i._menuHideListener.detach();delete i._menuHideListener}if(i._menuLeaveListener){i._menuLeaveListener.detach();delete i._menuLeaveListener}if(i._menuEnterListener){i._menuEnterListener.detach();delete i._menuEnterListener}if(i._showContactScrollHandler){i._showContactScrollHandler.detach();delete i._showContactScrollHandler}}},_hoverContactMenuEnter:function(){this._contactMenuFocused=true}};e.Messenger.View.ContactPlugin=d;if(typeof window.NeoConfig!=="undefined"&&window.NeoConfig.nav){i.plugins=i.plugins||[];i.plugins.push(d)}else{n.plugins=n.plugins||[];n.plugins.push(d)}},"1.0.0",{requires:["messenger-newconversationview","messenger-contactlist-view","messenger-contactlist-css","tictac-mim-rollups","tictac-base-view","messenger-constants","messenger-conversation","tictac-mim-strings","messenger-usersettings","messenger-viewutils","messenger-utils","messenger-stats","messenger-systemsettings","event-hover","messenger-base-css","escape"]});