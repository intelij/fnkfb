/**
 * Support for v3 batch transport.
 *
 * @module tictac-base
 * @submodule tictac-att-batch-transport
 */YUI.add("tictac-base-batch-transport",function(a){function h(b){var c=d(b).split("\r\n"),e={};return a.Array.each(c,function(a){var b=d(a).split(":");e[d(b[0])]=d(b[1])}),e}function i(b,e){var f=e?d(e):"",g="\r?\n?[-]*"+f+"[-]*\r?\n?",i,j,k,l,m,n={};return j=new RegExp(g,"igm"),k=b.split(j),a.Array.each(k,function(a){a!==""&&a!=="--"&&a!=="\r\n"&&(i=a.indexOf("\r\n\r\n"),l=h(a.substr(0,i)),m=d(a.substr(i+1)),l["Content-Type"].indexOf("application/json")!==-1&&(m=c.parseJSON(m)),n[l["Content-RequestId"]]={header:l,body:m})}),n}function j(a){var b,c;return a.status===200&&(c=a.getResponseHeader("Content-Type").split("boundary=")[1],b=i(a.responseText,c)),b}function k(b,d){var h=[NeoConfig.launch_protocol,location.hostname,"/ws/v3/batch","?appid=YahooMailNeo","&wssid="+e.getWssid(),"&windowid="+NeoConfig.windowId,"&r="+(new Date).getTime()].join("");a.io(h,{method:"POST",data:a.JSON.stringify(b),headers:{Accept:"application/json, multipart/form-data","Content-Type":"application/json"},timeout:g,on:{success:function(a,b){var c=j(b);d.success(a,b,c)},failure:function(g,h){var i=c.parseJSON(h.responseText),j,l,m;if(i&&i.error&&i.error.code===107){j=i.error.detail.url,l=j.match(f),m=l.length>1?l[1]:e.getWssid(),NeoConfig.wssid=m,e.setWssid(m),b.requests[1]&&b.requests[1].id==="GetAttachment"&&(b.requests[1].uri=b.requests[1].uri.replace(f,"&wssid="+m)),k(b,d);return}if(i&&i.error&&i.error.code===108){a.once("net:reloginSuccessful",function(){k(b,d)}),a.common.net.Error.simpleRelogin();return}d.fail(g,h)}}})}var b=a.Tictac,c=b.base.utils,d=a.Lang.trim,e=a.common.net.SessionMgr,f=/[\&|\?]wssid=([^\&\#]+)/,g=25e3;a.namespace("Tictac.base").BatchTransport={send:k}},"1.0.0",{requires:["tictac-base-utils","io","common-net-sessionmgr"]});YUI.add("tictac-att-slideshow",function(t){var e=t.Tictac,i=e.base.isRTL,a=t.UA.ie<=9&&t.UA.ie!==0,s=t.UA.ie===10,o=t.Tictac.att.strings,n,c;function r(t){var e=this;r.superclass.constructor.apply(e,arguments);if(t.stats&&t.stats.stat){e.stats=t.stats}if(t.fetcher){e.fetcher=t.fetcher}e._timeoutObjects=[]}function d(e){var i=this;i.mouseTimeout=null;i.justHidden=false;i.timeoutObj=null;this.start=function(){i.move();i.justHidden=false};this.clean=function(){this.stop();if(this.timeoutObj){this.timeoutObj.cancel()}};this.stop=function(){if(i.mouseTimeout){i.mouseTimeout.cancel()}i.mouseTimeout=null};this.move=function(a){var s;if(a&&a.type==="mousedown"&&a.target){s=t.one(".tictac-att-ss-docview-page-current input");if(a.target.get("tagName")!=="INPUT"&&s){s.blur()}}if(!i.justHidden){i.justHidden=false;if(i.mouseTimeout){i.mouseTimeout.cancel()}e.onactive();i.mouseTimeout=t.later(e.timeout,{},i.idled,[],false)}};this.idled=function(){e.onidle();i.justHidden=true;i.timeoutObj=t.later(500,{},function(){i.justHidden=false},[],false)}}r.NAME="slideshow";r.ATTRS={attachments:{validator:t.Lang.isArray,value:null},position:{validator:t.Lang.isNumber,value:0},delay:{validator:t.Lang.isNumber,value:4e3},imgActive:{validator:t.Lang.isObject,value:{opacity:1}},imgInactive:{validator:t.Lang.isObject,value:{opacity:0}},duration:{validator:t.Lang.isNumber,value:.6},disableDownload:{validator:t.Lang.isBoolean,value:false},easing:{validator:t.Lang.isString,value:"ease-in-out"},showDropboxLinK:{validator:t.Lang.isBoolean,value:true}};t.extend(r,t.Widget,{renderUI:function(){var e=this,s=e.get("contentBox"),o=e.get("attachments");s.append(t.Tictac.att.rollups.slideshow({attachments:o,is_single:o.length===1,isRTL:i,isIE:a,disableDownload:e.get("disableDownload")}));e._slideshow=s.one(".tictac-att-slideshow");e._spinner=t.one(".tictac-att-ss-topbar-scanning");e._docviewToolbar=e._slideshow.one(".tictac-att-ss-docview-toolbar");e._loadingSpinnerNode=e._slideshow.one(".tictac-att-ss-state-loading");e._loadingSpinner=new t.comms.ui.Envelope(e._loadingSpinnerNode);e._errorNode=e._slideshow.one(".tictac-att-ss-state-error");e._arrangeAttachments();e.set("imageNodes",t.all(".tictac-att-ss-image"));e.set("documentNodes",t.all(".tictac-att-ss-doc"));e._hasRendered=true},bindUI:function(){var e=this,a=e.get("contentBox"),o=t.Node.create('<div class="tictac-att-attachment-menu optionMenu"></div>');t.one("body").append(o);e._menuNodeSaveTo=o;e._events=[];e._events.push(a.one(".tictac-att-ss-footer").on("click",function(){var i=e.get("attachments"),a=e.get("position"),s=i[a],o=s.mid,n=s.fid;e.closeSlideshow();t.Tictac.base.mailutils.openMessage({mid:o,fid:n})}));e._events.push(a.one(".tictac-att-ss-close").on("click",function(){e.closeSlideshow()}));e._events.push(a.one(".tictac-att-ss-controls-prev").on("click",function(){if(!this.hasClass("att-ss-disabled")){e.moveLeft();e.stats.stat("slideshow_prev")}}));e._events.push(a.one(".tictac-att-ss-controls-next").on("click",function(){if(!this.hasClass("att-ss-disabled")){e.moveRight();e.stats.stat("slideshow_next")}}));e._events.push(e._errorNode.one(".tictac-att-ss-state-error-retry").on("click",function(){e._loadAttachment(e.get("position"))}));if(!e.get("disableDownload")){e._events.push(a.delegate("click",e.hideError,".tictac-att-error-dismiss",e));e._events.push(a.delegate("click",function(){var t=e.get("attachments"),i=e.get("position"),a=t[i].aid;e.fire("download:single",{data:a});e.stats.stat("slideshow_download_single")},".tictac-att-ss-download"));e._events.push(a.one(".tictac-att-ss-topbar-download").on("click",function(i){if(i.currentTarget.menu){return}function s(){var i=t.Tictac.base.utils.getVal(t,"Tictac.dropbox.controller"),s=a.one(".tictac-att-ss-topbar-download");o.setHTML(t.Tictac.att.rollups.slideshowmenu({save_to_computer:true,save_to_dropbox:!!i&&e.get("showDropboxLinK")}));t.common.ui.MenuHelper.create(s,{menu:o},function(){o.on("menuSelected",function(t){e.fire(t.dataAction,{data:e.get("attachments")[e.get("position")],pos:e.get("position"),callback:function(){e._setScanning(false)}})})})}if(t.Tictac.base.utils.hasTictacModule("tictac-dropbox")){t.use("tictac-dropbox-controller",function(){s()})}else{s()}}))}e._events.push(t.one(document.body).on("keydown",t.bind(function(t){var e=this,a=e.get("boundingBox");if(a.hasClass("hidden")){return}t.stopPropagation();switch(t.keyCode){case 37:if(i){e.moveRight()}else{e.moveLeft()}break;case 39:if(i){e.moveLeft()}else{e.moveRight()}break;case 27:t.halt();e.closeSlideshow();return false}},e)));if(!s){e._events.push(a.on(["mousemove","mousedown","mousewheel","keypress"],e.mouseIdler.move));e._events.push(a.delegate("hover",e.mouseIdler.stop,e.mouseIdler.start,".tictac-att-ss-controls"))}},destructor:function(){var e=this,i=e.mouseIdler;if(i){i.clean()}if(e._events){t.each(e._events,function(t){t.detach()})}if(e._menuNodeSaveTo){e._menuNodeSaveTo.remove(true)}if(e._timeoutObjects){t.each(e._timeoutObjects,function(t){t.cancel()})}if(e.docManager){e.docManager.cleanup()}if(e._loadingSpinner){e._loadingSpinner.destroy()}e._dontListenForBackButton()},initializer:function(){var e=this,i=[],a=[];var s=e.get("attachments");t.Array.each(s,function(t){if(t.type==="image"){i.push(t)}else{a.push(t)}});e.set("attachments",i.concat(a));var o,n,c,r=function(){return t.one(".tictac-att-ss-active div")},l=function(){o=t.one(".tictac-att-slideshow-thumbs");n=t.one(".tictac-att-ss-controls");c=r()},u=function(t,e,i){var a=c&&c.ancestor()&&c.ancestor().hasClass("tictac-att-ss-active");o.setStyle("cursor",t);n.setStyle("display",e);c=a?c:r();if(c){c.setStyle("overflow",i)}};e.mouseIdler=new d({onidle:function(){if(!o){l()}this.onidle=function(){u("none","none","hidden")};this.onidle()},onactive:function(){if(!o){l()}this.onactive=t.throttle(function(){u("auto","block","auto")},250);this.onactive()},timeout:3e3})},_doListenForBackButton:function(){var t=this;function e(){t._dontListenForBackButton();t.hide()}if(typeof window.history.pushState==="function"){t._doBackButton=e;window.history.pushState(null,"");window.addEventListener("popstate",t._doBackButton,false)}},_dontListenForBackButton:function(){var t=this;if(t._doBackButton){window.removeEventListener("popstate",t._doBackButton,false);t._doBackButton=null}},_getAttachmentObject:function(t){var e=this.get("attachments"),i=null;if(e&&e.get){i=e.get(t)}return i},_arrangeAttachments:function(){var t=this,e=t.get("position"),i=t.get("imgActive"),a=t.get("attachments"),s;t._slideshow.all(".tictac-att-ss-active").removeClass("tictac-att-ss-active");s=a[e].aid;t._preload(e);t._slideshow.one('li[data-id="'+s+'"]').setStyles(i).addClass("tictac-att-ss-active");t._uiUpdateStatus()},_transition:function(e){var i=this,a=i.get("attachments"),s=i.get("position"),o,n,c;if(e>=0&&e<a.length){n=i._slideshow.one('li[data-id="'+a[s].aid+'"]');o=i._slideshow.one('li[data-id="'+a[e].aid+'"]');c=function(t,e){return{on:{start:function(){if(e){t.addClass("tictac-att-ss-active")}},end:function(){if(!e){t.removeClass("tictac-att-ss-active")}}}}};if(n){n.transition(t.merge({duration:i.get("duration"),easing:i.get("easing")},i.get("imgInactive"),c(n,false)))}if(o){o.transition(t.merge({duration:i.get("duration"),easing:i.get("easing")},i.get("imgActive"),c(o,true)))}i.set("position",e);return true}else{return false}},_getAttSize:function(t){var e={};if(t&&t.width&&t.height){e["maxWidth"]=t.width+"px";e["maxHeight"]=t.height+"px"}return e},_setScanning:function(t){var e=this._slideshow;if(!e){return}if(t){e.addClass("att-ss-scanning")}else{e.removeClass("att-ss-scanning")}},_move:function(t){var e=this,i=e.get("position"),a=false;if(t==="left"){a=e._transition(i-1)}else if(t==="right"){a=e._transition(i+1)}e._preload(e.get("position"));e._uiUpdateStatus();return a},_loadDoc:function(i,a,s){var o=this,n=t.one(".tictac-att-ss-docview-toolbar"),c=(new Date).getTime();t.use("tictac-att-docman",function(){if(!o.docManager){o.docManager=new e.att.DocManager({zoomIn:n.one(".tictac-att-ss-docview-zoom-in"),zoomOut:n.one(".tictac-att-ss-docview-zoom-out"),goPrev:n.one(".tictac-att-ss-docview-page-prev"),goNext:n.one(".tictac-att-ss-docview-page-next"),info:n.one(".tictac-att-ss-docview-page-current")},o._slideshow)}o.docManager.show(i,a,s,c)})},_loadAttachment:function(i,a){var s=this,n=s.get("attachments")[i],c=n.aid,r=s._slideshow.one('li[data-id="'+c+'"]'),d=s._slideshow.one(".tictac-att-ss-state-loading-message"),l={};if(n.hasLoaded||n.isLoading){return}if(n.isDoc&&a){return}l={load:function(){n.hasLoaded=true;n.hasError=false;n.isLoading=false;s._updateState(n,i);d.setStyle("display","none")},fail:function(t,a,o){n.hasLoaded=false;n.hasError=true;n.isLoading=false;if(e.att.DocViewer&&o===e.att.DocViewer.PASSWORD_PROTECTED){t.isPasswordProtected=true}s._updateState(n,i);d.setStyle("display","none")},beforeAttShow:function(e){n.isLoading=true;s._timeoutObjects.push(t.later(300,s,function(){s._updateState(n,i);if(e===true&&n.isLoading){d.setContent(o["str_generating_message"]);d.setStyle("display","inline")}},[],false))}};if(n.isDoc){s._loadDoc(n,r,l)}else{s._loadImage(n,r,l)}},_updateState:function(t,e){var i=this,a;if(i.get("position")!==e){return}if(t.isLoading){i._showSpinner()}else{i._hideSpinner()}if(t.hasError&&!t.isLoading){a=t.isPasswordProtected?o["str_tictac_att_password_error"]:o["str_tictac_att_state_error"];i._showStateError(a,t.isPasswordProtected)}else{i._hideStateError()}if(t.isDoc&&t.hasLoaded){i._showDocToolbar()}else{i._hideDocToolbar()}},_showAttachment:function(t,e){var i=this;i._updateState(t,e);if(i.get("position")!==e){return}if(t.isDoc&&t.hasLoaded){i.docManager.show(t)}},_showDocToolbar:function(){this._docviewToolbar.show()},_hideDocToolbar:function(){this._docviewToolbar.hide()},_showSpinner:function(){var t=this._loadingSpinnerNode;if(t){t.show();this._loadingSpinner.start()}},_hideSpinner:function(){var t=this._loadingSpinnerNode;if(t){t.hide();this._loadingSpinner.stop()}},_showStateError:function(t,e){var i=this._errorNode,a=this._errorNode.one(".tictac-att-ss-state-error-retry");i.one(".tictac-att-ss-state-error-msg").set("text",t);i.show();if(e){a.hide()}else{a.show()}},_hideStateError:function(){this._errorNode.hide()},_loadImage:function(e,i,a){var s=this,o;if(!e.fullsize){return}a.beforeAttShow();o=new Image;function n(){a.load();e.width=o.width;e.height=o.height;if(t.UA.ie<=8&&t.UA.ie>0){i.setStyle("maxWidth",s._getAttSize(e)["maxWidth"])}else{i.setStyles(s._getAttSize(e))}i.setStyle("backgroundImage","url("+e.fullsize+")")}function c(){a.fail()}o.onload=n;o.onerror=c;o.src=e.fullsize},_preload:function(t){var e=this,i=e.get("attachments"),a=2,s=2,o=t-a>0?t-a:0,n=t+s+1<i.length?t+s+1:i.length,c;e._loadAttachment(t);for(c=o;c<n;c++){if(c!==t){e._loadAttachment(c,true)}}if(e.fetcher&&e.fetcher.hasMore()){e.fetcher.fetch(function(t){e.set("attachments",i.concat(t))})}},moveLeft:function(){return this._move("left")},moveRight:function(){return this._move("right")},show:function(t,e){var i=this,a=i.get("boundingBox"),s,o=t,c;a.appendChild("<style>::-webkit-scrollbar-thumb { background: rgba(153, 153, 153, 0.75); }</style>");if(e){s=i.get("attachments");for(c=0;c<s.length;c++){if(s[c].aid===t){o=c;break}}}if(t!==undefined){s=i.get("attachments");i.set("position",o)}else{i.set("position",0)}if(!i.hasRendered()){i.render()}else{i._arrangeAttachments()}a.removeClass("hidden");i._doListenForBackButton();if(window.yui){n=window.yui.mail.ui.Workspace.get("navKeys");window.yui.mail.ui.Workspace.set("navKeys",null)}document.activeElement.blur()},closeSlideshow:function(){var e=this,i;if(e.docManager){i=e.docManager.viewers;t.each(i,function(t){e.docManager.stat("docview_ss_close",{count:t.countPagesSeen()})})}e.hide()},hide:function(){var t=this,e=this.get("boundingBox");e.addClass("hidden");if(e.one("style")&&e.one("style").remove){e.one("style").remove(true)}if(t.mouseIdler){t.mouseIdler.stop()}t._hideSpinner();if(t._doBackButton){window.history.back()}t._dontListenForBackButton();if(window.yui){window.yui.mail.ui.Workspace.set("navKeys",n)}},hasRendered:function(){return!!this._hasRendered},_uiUpdateStatus:function(){var e=this,i,a,s=e.get("attachments"),o=e._slideshow.one,n,c=o(".tictac-att-ss-controls-prev"),r=o(".tictac-att-ss-controls-next"),d=o(".tictac-att-ss-topbar-filename"),l=o(".tictac-att-ss-footer"),u=o(".tictac-att-ss-photo"),h=o(".tictac-att-ss-from >p"),f=o(".tictac-att-ss-folderdate >p"),g=o(".tictac-att-ss-snippet >p"),m=o(".tictac-att-ss-subject >p");e._uiUpdateStatus=function(){i=e.get("position");a=s[i];e._showAttachment(a,i);d.setHTML(t.Escape.html(s[i].filename));if(a.imageUrl){u.setStyle("backgroundImage",'url("'+a.imageUrl+'")');h.setHTML(t.Escape.html(a.fromStr));n=a.folderStr||yui.mail.ui.common.StringUtils.getSystemFolderName(a.fid,a.fid);a.folderDate=n+" "+a.dateStr;f.setHTML(t.Escape.html(a.folderDate));g.setHTML(t.Escape.html(a.snippet));m.setHTML(t.Escape.html(a.subject));o("ul.tictac-att-slideshow-thumbs").addClass("tictac-att-slideshow-has-footer");l.removeClass("hidden")}else{l.addClass("hidden")}if(i===0){c.addClass("att-ss-disabled")}else{c.removeClass("att-ss-disabled")}if(i+1>=s.length){r.addClass("att-ss-disabled")}else{r.removeClass("att-ss-disabled")}};e._uiUpdateStatus()},_getErrorNode:function(){return this._slideshow.one(".tictac-att-ss-topbar-error")},_showError:function(t){if(t){this._slideshow.addClass("att-ss-error")}else{this._slideshow.removeClass("att-ss-error")}},_startSpinning:function(){this._setScanning(true)},_stopSpinning:function(){this._setScanning(false)},_getArray:function(){if(c){return c.getArray(null,true)}return this._getCollection().getArray(null,true)},_getCollection:function(){var e=this.get("attachments");if(c&&c.getViewableArray().length>0&&c.getViewableArray().length===e.length&&e[0].aid===c.getViewableArray()[0].aid){return c}c=new t.Tictac.att.Collection;t.Array.each(e,function(e){c.add(new t.Tictac.att.Attachment(e))});return c}});t.mix(r.prototype,t.Tictac.att.AttachmentView);t.namespace("Tictac.att").Slideshow=r},"1.0.0",{requires:["array-extras","event-hover","event-mousewheel","node-base","transition","widget","comms-ui-envelope","common-ui-menu-helper","tictac-att-attachments","tictac-att-attachmentview","tictac-att-rollups","tictac-att-strings","tictac-base","tictac-base-stats","tictac-base-utils","tictac-base-mailutils","yui-throttle","event-custom","escape"]});YUI.add("tictac-atm-strings",function(a){a.namespace("Tictac.atm").strings={str_view_attachment:"This message has an attachment",str_view_attachments:"This message has attachments",last:null}},"1.0.0");