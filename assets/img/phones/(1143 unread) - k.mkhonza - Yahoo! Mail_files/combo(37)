YUI.add("tictac-dropbox-controller",function(e){var o=e.Tictac,r=o.base,n=r.utils,s=n.log,t=n.verify,a=o.dropbox,i=a.api,c=a.auth,u=a.chooser,l=a.saver,_=a.Stats.stat,d=a.strings,f=function(){var e=0,o;function r(e){var r;if(o&&(r=o())){return r}r=d.str_dropbox_saveto_in_progress;if(window.event){window.event.returnValue=r}if(e&&e.returnValue){e.returnValue=r}return r}function n(){e+=1;if(e>1){return}o=window.onbeforeunload;window.onbeforeunload=r}function s(){e-=1;if(e>0){return}t(e===0,"Unexpected negative count");window.onbeforeunload=o}return{hook:n,unhook:s}}();function p(){window.alert(d.str_chooser_invalid_response);_("dropbox_invalid_chooser")}function b(o){var r=["link","name","bytes"];if(!e.Lang.isArray(o)){return false}return!e.Array.some(o,function(o){if(!e.Lang.isObject(o)){return true}return e.Array.some(r,function(r){if(!e.Object.owns(o,r)){s("file missing field:"+r);return true}return false})})}function v(e,o){function r(o){m(e,o)}function n(){c.linkDropboxAccount(function(){v(e,o)},o)}function s(){_("dropbox_sign_out_unlink")}u.chooseFiles({success:r,webSessionUnlinked:s,ssoFailure:n})}function x(e){return{link:e.link}}function m(o,r){var n={};s("onFilesChosen");if(!r){return}if(!b(r)){p();return}e.Array.each(r,function(e){var r,s;n[e.link]=true;s=o.findDropbox(e);if(s){o.set(s.id,"dropbox",x(e),{squelchCommit:true});return}r={filename:e.name,size:e.bytes,uploadState:"success",dropbox:x(e)};if(e.thumbnails){r.thumbnail=e.thumbnails["64x64"]}o.add(r,true)});o.commit()}function g(o,r,n){var t={hd:d["str_save_attach_to_db"],bd:e.Tictac.dropbox.rollups.disclaimer({headline:d["str_yahoo_partner_db_save_to_cloud"],body:d["str_db_free_service_disclaimer"]})},a;function i(e,r){var s=r?{fmt:"has-error",autoDismiss:false}:null;n.clearStatus(o,"savingToCloud");if(e){n.notify(e,s)}f.unhook()}function u(){var e=d.str_dropbox_saveto_complete_singular;_("dropbox_saveto",{message:"success"});if(r.length>1){e=d.str_dropbox_saveto_complete_plural;e=e.replace("{{num}}",r.length)}i(e)}function p(){}function b(){n.clearStatus(o,"savingToCloud");i(d.str_dropbox_saveto_transfer_error,true);_("dropbox_saveto",{message:"error"})}function v(){_("dropbox_sign_out_unlink");i();_("dropbox_saveto",{message:"websession_unlinked"})}function x(){_("dropbox_saveto",{message:"sso_failure"});c.linkDropboxAccount(function(){g()},t)}function m(){_("dropbox_saveto",{message:"cancel"});i()}function g(){_("dropbox_saveto",{message:"directory"});l.saveToDirectory({files:a,success:u,cancel:m,progress:p,error:b,webSessionUnlinked:v,ssoFailure:x})}a=e.Array.map(r,function(e){return{filename:e.fileName,url:e.secureDownload.url}});s("Save to Dropbox");_("dropbox_saveto",{message:"save"});t.cancel=m;c.getToken(function(){g()},t)}var h={MAX_FILE_SIZE:i.MAX_UPLOAD_SIZE,saveTo:function(o,r,n,s,t){var a=e.Tictac.att.downloader,i=e.Array.map(r,function(e){return e.aid});_("dropbox_saveto",{message:"start"});a.setStats(n);f.hook();a.getURLs(o,r,function(e,r){if(e!=="success"){_("dropbox_saveto",{message:"downloader_failure"});o.clearStatus(i,"scanning");f.unhook();o.notify(d.str_dropbox_saveto_no_URLs,"has-error");return}o.setStatus(i,"savingToCloud");o.clearStatus(i,"scanning");g(i,r.attachments,o)},s,t)},attachFrom:function(o){var r={hd:d["str_share_files_from_db"],bd:e.Tictac.dropbox.rollups.disclaimer({headline:d["str_yahoo_partner_db_store_on_db"],body:d["str_db_free_service_disclaimer"]})};s("controller.attachFrom");_("dropbox_share_from_activated");function n(){v(o,r)}c.getToken(n,r)},dialogIfTooBig:function(o,r){var s=n.subs(d.str_dropbox_alf_over_size,{dropbox_oversize_url:"https://www.dropbox.com/help/5"});if(o<=h.MAX_FILE_SIZE){return false}e.common.ui.DialogHelper.cancelDialog({hd:d.str_db_attach_large_files,bd:e.Tictac.dropbox.rollups.limit({too_big_msg:r?d.str_dropbox_alf_over_size_error_multiple:d.str_dropbox_alf_over_size_error_single,learn_how_msg:s})});return true},attachLargeFiles:function(o,r,n,s,t){var i={hd:d["str_db_attach_large_files"],bd:e.Tictac.dropbox.rollups.disclaimer({headline:d["str_yahoo_partner_db_25mb"],body:d["str_db_free_service_disclaimer"]})},u=this,l=d[o?"str_dropbox_files_exceed_25MB":"str_dropbox_file_exceed_25MB"];function f(o){function n(){var n={configureUpload:function(r,n){n({url:e.Tictac.dropbox.controller.UPLOAD_URL,postVars:{web_session_token:o.token}})},parseServerResponse:u.parseServerResponse,isSvrResponseSuccess:u.isSvrResponseSuccess,isSvrResponseWarning:u.isSvrResponseWarning};_("dropbox_alf_enable_ok");if(!s){v(r,i)}else{s(n)}}function c(){_("dropbox_alf_enable_cancel");a.alfview.cleanup();t()}if(o.src==="partner"){n()}else{e.common.ui.DialogHelper.confirm({hd:d["str_db_attach_large_files"],bd:l},{ok:{handler:n},cancel:{handler:c}})}}if(s){a.alfview.register(r,n)}c.getToken(f,i)},UPLOAD_URL:i.blockBaseUrl+"/upload_web_session",parseServerResponse:function(e,o){o=n.parseJSON(o);if(!o){return}if(o.error_id==="quota"){e.reason="over_quota";return}if(o.error==="Invalid web session token"){e.reason="invalid_token";return}if(!o.link){e.reason="DropboxNoLink";return}e.reason="DropboxSuccess";e.dropboxLink=o.link},isSvrResponseSuccess:function(e){return e==="DropboxSuccess"},isSvrResponseWarning:function(){return false}};e.namespace("Tictac.dropbox").controller=h},"1.0.0",{requires:["common-ui-dialog-helper","tictac-base-utils","tictac-dropbox-alfview","tictac-dropbox-api","tictac-dropbox-auth","tictac-dropbox-strings","tictac-dropbox-rollups","tictac-dropbox-stats","tictac-dropbox-chooser","tictac-dropbox-saver"]});